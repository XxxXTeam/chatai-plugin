import plugin from '../../../lib/plugins/plugin.js'
import config from '../config/config.js'
import { chatLogger } from '../src/core/utils/logger.js'

const logger = {
    info: (...args) => chatLogger.info('QQBotApp', ...args),
    warn: (...args) => chatLogger.warn('QQBotApp', ...args),
    error: (...args) => chatLogger.error('QQBotApp', ...args),
    debug: (...args) => chatLogger.debug('QQBotApp', ...args),
}

let qqBotProxyService = null
let qqBotMessageHandler = null
let initialized = false

async function initQQBotProxy() {
    if (initialized) return

    const cfg = config.get('qqBotProxy')
    if (!cfg?.enabled) {
        logger.debug('QQå®˜æ–¹Botä»£ç†æœªå¯ç”¨')
        return
    }

    try {
        const serviceModule = await import('../src/services/qqbot/QQBotProxyService.js')
        const handlerModule = await import('../src/services/qqbot/QQBotMessageHandler.js')
        
        qqBotProxyService = serviceModule.qqBotProxyService
        qqBotMessageHandler = handlerModule.qqBotMessageHandler

        // æ³¨å†Œæ¶ˆæ¯äº‹ä»¶å¤„ç†
        qqBotProxyService.on('*', (eventType, data, instance) => {
            qqBotMessageHandler.handleMessage(eventType, data, instance)
        })

        // åˆå§‹åŒ–æœåŠ¡
        await qqBotProxyService.init()
        
        initialized = true
        logger.info('QQå®˜æ–¹Botä»£ç†åº”ç”¨åˆå§‹åŒ–å®Œæˆ')
    } catch (err) {
        logger.error(`åˆå§‹åŒ–å¤±è´¥: ${err.message}`)
    }
}

// å»¶è¿Ÿåˆå§‹åŒ–
setTimeout(() => {
    initQQBotProxy()
}, 3000)

export class QQBotProxyApp extends plugin {
    constructor() {
        super({
            name: 'QQå®˜æ–¹Botä»£ç†',
            dsc: 'ç®¡ç†QQå®˜æ–¹Botä»£ç†è¿æ¥',
            event: 'message',
            priority: 500,
            rule: [
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*(çŠ¶æ€|status)$/i,
                    fnc: 'status',
                    permission: 'master',
                },
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*(å¯åŠ¨|start)$/i,
                    fnc: 'start',
                    permission: 'master',
                },
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*(åœæ­¢|stop)$/i,
                    fnc: 'stop',
                    permission: 'master',
                },
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*(é‡è¿|reconnect)$/i,
                    fnc: 'reconnect',
                    permission: 'master',
                },
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*æ·»åŠ \s+(\S+)\s+(\S+)(\s+\S+)?$/i,
                    fnc: 'addBot',
                    permission: 'master',
                },
                {
                    reg: /^#(qqbot|å®˜æ–¹bot)\s*(åˆ é™¤|remove)\s+(\S+)$/i,
                    fnc: 'removeBot',
                    permission: 'master',
                },
            ],
        })
    }

    async status(e) {
        if (!qqBotProxyService) {
            await e.reply('QQå®˜æ–¹Botä»£ç†æœåŠ¡æœªåˆå§‹åŒ–')
            return true
        }

        const status = qqBotProxyService.getStatus()
        
        let msg = `ğŸ¤– QQå®˜æ–¹Botä»£ç†çŠ¶æ€\n`
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`
        msg += `å¯ç”¨: ${status.enabled ? 'âœ…' : 'âŒ'}\n`
        msg += `å·²åˆå§‹åŒ–: ${status.initialized ? 'âœ…' : 'âŒ'}\n`
        msg += `Botæ•°é‡: ${status.botCount}\n`

        if (status.bots.length > 0) {
            msg += `\nğŸ“‹ Botåˆ—è¡¨:\n`
            for (const bot of status.bots) {
                const statusIcon = bot.connected ? 'ğŸŸ¢' : 'ğŸ”´'
                msg += `${statusIcon} ${bot.appid}\n`
                msg += `   ç”¨æˆ·å: ${bot.username || 'æœªçŸ¥'}\n`
                msg += `   çŠ¶æ€: ${bot.status}\n`
                msg += `   åºå·: ${bot.seq}\n`
            }
        }

        await e.reply(msg.trim())
        return true
    }

    async start(e) {
        const cfg = config.get('qqBotProxy')
        if (!cfg?.enabled) {
            config.set('qqBotProxy.enabled', true)
        }

        if (!initialized) {
            await initQQBotProxy()
            await e.reply('QQå®˜æ–¹Botä»£ç†å·²å¯åŠ¨')
        } else {
            await e.reply('QQå®˜æ–¹Botä»£ç†å·²åœ¨è¿è¡Œä¸­')
        }
        return true
    }

    async stop(e) {
        if (qqBotProxyService) {
            await qqBotProxyService.shutdown()
            initialized = false
            await e.reply('QQå®˜æ–¹Botä»£ç†å·²åœæ­¢')
        } else {
            await e.reply('QQå®˜æ–¹Botä»£ç†æœªè¿è¡Œ')
        }
        return true
    }

    async reconnect(e) {
        if (!qqBotProxyService) {
            await e.reply('QQå®˜æ–¹Botä»£ç†æœåŠ¡æœªåˆå§‹åŒ–')
            return true
        }

        await qqBotProxyService.shutdown()
        initialized = false
        await initQQBotProxy()
        await e.reply('QQå®˜æ–¹Botä»£ç†å·²é‡è¿')
        return true
    }

    async addBot(e) {
        const match = e.msg.match(/^#(?:qqbot|å®˜æ–¹bot)\s*æ·»åŠ \s+(\S+)\s+(\S+)(?:\s+(\S+))?$/i)
        if (!match) {
            await e.reply('æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨: #qqbotæ·»åŠ  appid secret [sandbox]')
            return true
        }

        const [, appid, secret, sandboxStr] = match
        const sandbox = sandboxStr === 'true' || sandboxStr === '1'

        // ä¿å­˜åˆ°é…ç½®
        const bots = config.get('qqBotProxy.bots') || []
        const existing = bots.find(b => b.appid === appid)
        if (existing) {
            await e.reply(`Bot ${appid} å·²å­˜åœ¨`)
            return true
        }

        bots.push({ appid, secret, sandbox, intents: 0 })
        config.set('qqBotProxy.bots', bots)

        // å¦‚æœæœåŠ¡å·²åˆå§‹åŒ–ï¼Œç«‹å³åˆ›å»ºBot
        if (qqBotProxyService && initialized) {
            const proxyUrl = config.get('qqBotProxy.proxyUrl') || 'http://localhost:2173'
            try {
                await qqBotProxyService.createBot({ appid, secret, sandbox }, proxyUrl)
                await e.reply(`Bot ${appid} æ·»åŠ å¹¶è¿æ¥æˆåŠŸ`)
            } catch (err) {
                await e.reply(`Bot ${appid} æ·»åŠ æˆåŠŸä½†è¿æ¥å¤±è´¥: ${err.message}`)
            }
        } else {
            await e.reply(`Bot ${appid} å·²æ·»åŠ åˆ°é…ç½®ï¼Œè¯·å¯åŠ¨ä»£ç†æœåŠ¡`)
        }

        return true
    }

    async removeBot(e) {
        const match = e.msg.match(/^#(?:qqbot|å®˜æ–¹bot)\s*(?:åˆ é™¤|remove)\s+(\S+)$/i)
        if (!match) {
            await e.reply('æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨: #qqbotåˆ é™¤ appid')
            return true
        }

        const appid = match[1]

        // ä»é…ç½®ä¸­åˆ é™¤
        const bots = config.get('qqBotProxy.bots') || []
        const index = bots.findIndex(b => b.appid === appid)
        if (index === -1) {
            await e.reply(`Bot ${appid} ä¸å­˜åœ¨`)
            return true
        }

        bots.splice(index, 1)
        config.set('qqBotProxy.bots', bots)

        // å¦‚æœæœåŠ¡å·²åˆå§‹åŒ–ï¼Œç«‹å³åˆ é™¤Bot
        if (qqBotProxyService && initialized) {
            await qqBotProxyService.deleteBot(appid)
        }

        await e.reply(`Bot ${appid} å·²åˆ é™¤`)
        return true
    }
}
