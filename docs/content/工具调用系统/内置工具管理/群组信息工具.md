# 群组信息工具




## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

群组信息工具是 ChatGPT 插件中的核心功能模块，专门用于管理和查询 QQ 群组相关信息。该工具类别提供了完整的群组信息查询、成员列表获取、群组状态管理等功能，支持多种群组操作和权限控制。

该工具类别包含 8 个主要工具，涵盖群组基本信息查询、成员管理、群组状态监控等多个方面，为用户提供全面的群组管理能力。

## 项目结构

插件采用模块化的架构设计，群组信息工具位于 `src/mcp/tools/group.js` 文件中，通过 MCP（Model Context Protocol）协议提供标准化的工具接口。

```mermaid
graph TB
subgraph "群组信息工具架构"
A[group.js - 群组工具定义]
B[index.js - 工具分类管理]
C[helpers.js - 工具辅助函数]
D[config.js - 配置管理]
end
subgraph "权限控制系统"
E[PermissionService.js - 权限检查]
F[ScopeManager.js - 作用域管理]
end
subgraph "前端管理界面"
G[editor.tsx - 群组编辑器]
H[groupAdminRoutes.js - 管理路由]
end
A --> C
B --> A
D --> A
E --> A
F --> G
G --> H
```

**图表来源**
- [group.js](file://src/mcp/tools/group.js#L1-L602)
- [index.js](file://src/mcp/tools/index.js#L1-L181)
- [helpers.js](file://src/mcp/tools/helpers.js#L1-L800)

**章节来源**
- [README.md](file://README.md#L356-L396)
- [group.js](file://src/mcp/tools/group.js#L1-L602)

## 核心组件

### 群组信息工具类别

群组信息工具类别包含以下 8 个核心工具：

| 工具名称 | 功能描述 | 权限级别 |
|---------|----------|----------|
| get_group_info | 获取群组基本信息 | 所有人 |
| get_group_list | 获取机器人加入的群列表 | 所有人 |
| get_group_member_list | 获取群成员列表 | 群管理 |
| get_group_member_info | 获取群成员详细信息 | 群管理 |
| get_current_group | 获取当前会话所在群信息 | 所有人 |
| get_group_admins | 获取群管理员列表 | 群管理 |
| search_group_member | 在群成员中搜索用户 | 群管理 |
| get_group_notice | 获取群公告列表 | 群管理 |

### 工具参数配置

每个工具都定义了详细的输入参数规范和验证机制：

```mermaid
flowchart TD
A[工具调用] --> B[参数验证]
B --> C{必需参数检查}
C --> |缺失| D[返回错误]
C --> |完整| E[权限检查]
E --> F{权限验证}
F --> |通过| G[执行工具]
F --> |拒绝| H[权限错误]
G --> I[返回结果]
D --> J[错误处理]
H --> J
I --> K[完成]
J --> K
```

**图表来源**
- [helpers.js](file://src/mcp/tools/helpers.js#L702-L787)

**章节来源**
- [group.js](file://src/mcp/tools/group.js#L8-L602)
- [helpers.js](file://src/mcp/tools/helpers.js#L702-L787)

## 架构概览

### 工具执行流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant Tool as 群组工具
participant Helper as 辅助函数
participant Bot as 机器人实例
participant QQ as QQ平台API
Client->>Tool : 调用群组工具
Tool->>Tool : 参数验证
Tool->>Helper : 权限检查
Helper->>Bot : 获取Bot实例
Bot->>QQ : 调用平台API
QQ-->>Bot : 返回群组数据
Bot-->>Tool : 处理后的数据
Tool->>Tool : 格式化结果
Tool-->>Client : 返回工具结果
```

**图表来源**
- [group.js](file://src/mcp/tools/group.js#L19-L60)
- [helpers.js](file://src/mcp/tools/helpers.js#L190-L255)

### 权限控制机制

```mermaid
flowchart TD
A[用户请求] --> B[权限检查]
B --> C{检查用户身份}
C --> |主人| D[直接通过]
C --> |群管理员| E{检查群组权限}
C --> |普通用户| F{检查功能权限}
E --> |有权限| G[通过]
E --> |无权限| H[拒绝]
F --> |有权限| G
F --> |无权限| H
D --> I[执行工具]
G --> I
H --> J[返回错误]
I --> K[返回结果]
```

**图表来源**
- [PermissionService.js](file://src/services/permission/PermissionService.js#L337-L421)

**章节来源**
- [PermissionService.js](file://src/services/permission/PermissionService.js#L1-L484)

## 详细组件分析

### 群组信息查询工具

#### get_group_info 工具

该工具用于获取群组的基本信息，包括群名、成员数量、群主信息等关键数据。

**参数配置：**
- `group_id` (string, 必需): 群号

**返回值格式：**
```json
{
  "success": true,
  "group_id": "群号",
  "group_name": "群名称",
  "member_count": 成员数量,
  "max_member_count": 最大成员数,
  "owner_id": 群主ID,
  "admin_flag": 管理员标志,
  "avatar_url": 头像URL,
  "bot_in_group": 是否在群内
}
```

#### get_group_list 工具

获取机器人加入的所有群组列表。

**参数配置：**
- `limit` (number): 返回的最大数量，默认50

**返回值格式：**
```json
{
  "success": true,
  "total": 群组总数,
  "returned": 返回数量,
  "groups": [
    {
      "group_id": "群号",
      "group_name": "群名称",
      "member_count": 成员数量
    }
  ]
}
```

**章节来源**
- [group.js](file://src/mcp/tools/group.js#L9-L91)

### 成员管理工具

#### get_group_member_list 工具

获取指定群组的成员列表，支持分页和限制数量。

**参数配置：**
- `group_id` (string, 必需): 群号
- `limit` (number): 返回的最大数量，默认100

**返回值格式：**
```json
{
  "success": true,
  "group_id": "群号",
  "group_name": "群名称",
  "total": 成员总数,
  "returned": 返回数量,
  "members": [
    {
      "user_id": "用户ID",
      "nickname": "昵称",
      "card": "群名片",
      "role": "角色",
      "title": "头衔"
    }
  ]
}
```

#### get_group_member_info 工具

获取指定群成员的详细信息。

**参数配置：**
- `group_id` (string, 必需): 群号
- `user_id` (string, 必需): 用户QQ号

**返回值格式：**
```json
{
  "success": true,
  "group_id": "群号",
  "user_id": "用户ID",
  "nickname": "昵称",
  "card": "群名片",
  "role": "角色",
  "title": "头衔",
  "level": 等级,
  "join_time": 加入时间,
  "avatar_url": 头像URL
}
```

**章节来源**
- [group.js](file://src/mcp/tools/group.js#L93-L221)

### 群组状态管理工具

#### get_group_admins 工具

获取群管理员列表，包括群主和管理员。

**参数配置：**
- `group_id` (string): 群号，不填则使用当前群

**返回值格式：**
```json
{
  "success": true,
  "group_id": "群号",
  "group_name": "群名称",
  "owner": 群主信息,
  "admin_count": 管理员数量,
  "admins": [
    {
      "user_id": "用户ID",
      "nickname": "昵称",
      "card": "群名片",
      "role": "角色",
      "title": "头衔"
    }
  ]
}
```

#### get_group_notice 工具

获取群公告列表或指定公告详情。

**参数配置：**
- `group_id` (string): 群号，不填则使用当前群
- `index` (number): 获取指定序号的公告详情（1-N），不填则获取列表
- `limit` (number): 返回数量限制，默认10

**返回值格式：**
```json
{
  "success": true,
  "group_id": "群号",
  "count": 公告数量,
  "notices": [
    {
      "index": 序号,
      "id": 公告ID,
      "content": 公告内容,
      "sender_id": 发送者ID,
      "time": 发布时间,
      "confirm_required": 是否需要确认,
      "read_count": 阅读数量,
      "is_pinned": 是否置顶
    }
  ]
}
```

**章节来源**
- [group.js](file://src/mcp/tools/group.js#L223-L494)

### 实际应用场景

#### 群组管理自动化

```mermaid
flowchart TD
A[群组管理需求] --> B[选择合适工具]
B --> C{需要查询信息}
B --> D{需要管理成员}
B --> E{需要监控状态}
C --> F[get_group_info]
C --> G[get_group_list]
C --> H[get_group_member_list]
D --> I[get_group_member_info]
D --> J[get_group_admins]
D --> K[search_group_member]
E --> L[get_group_notice]
E --> M[check_in_group]
E --> N[search_group]
F --> O[执行管理]
G --> O
H --> O
I --> O
J --> O
K --> O
L --> O
M --> O
N --> O
```

**图表来源**
- [group.js](file://src/mcp/tools/group.js#L8-L602)

#### 权限控制示例

```mermaid
sequenceDiagram
participant User as 普通用户
participant Admin as 群管理员
participant Master as 机器人主人
participant Tool as 群组工具
participant Perm as 权限服务
User->>Tool : 请求管理操作
Tool->>Perm : 检查权限
Perm-->>Tool : 拒绝
Admin->>Tool : 请求管理操作
Tool->>Perm : 检查权限
Perm-->>Tool : 允许
Master->>Tool : 请求管理操作
Tool->>Perm : 检查权限
Perm-->>Tool : 允许
```

**图表来源**
- [PermissionService.js](file://src/services/permission/PermissionService.js#L337-L421)

**章节来源**
- [PermissionService.js](file://src/services/permission/PermissionService.js#L337-L421)

## 依赖关系分析

### 工具依赖关系

```mermaid
graph TB
subgraph "群组工具依赖"
A[group.js]
B[helpers.js]
C[config.js]
D[PermissionService.js]
E[ScopeManager.js]
end
subgraph "平台适配"
F[icqqGroup]
G[icqqFriend]
H[groupNoticeApi]
end
A --> B
A --> C
A --> D
B --> F
B --> G
B --> H
D --> E
```

**图表来源**
- [group.js](file://src/mcp/tools/group.js#L6-L7)
- [helpers.js](file://src/mcp/tools/helpers.js#L13-L122)

### 配置依赖

群组工具依赖于全局配置系统，包括：

- **触发配置**: 控制工具的触发方式和权限
- **工具配置**: 管理工具的启用状态和执行模式
- **权限配置**: 定义不同用户角色的访问权限
- **群组配置**: 群组级别的个性化设置

**章节来源**
- [config.js](file://config/config.js#L62-L586)
- [index.js](file://src/mcp/tools/index.js#L29-L58)

## 性能考虑

### 工具执行优化

1. **缓存机制**: 利用平台提供的缓存接口，减少重复查询
2. **批量操作**: 支持批量获取成员列表，提高效率
3. **分页处理**: 对大量数据进行分页处理，避免内存溢出
4. **并发控制**: 限制同时执行的工具数量，防止系统过载

### 内存管理

```mermaid
flowchart TD
A[工具调用] --> B[参数验证]
B --> C[权限检查]
C --> D[执行查询]
D --> E[数据处理]
E --> F[结果缓存]
F --> G[内存释放]
G --> H[返回结果]
subgraph "内存优化策略"
I[及时释放临时变量]
J[使用流式处理大数据]
K[避免内存泄漏]
end
E --> I
E --> J
E --> K
```

## 故障排除指南

### 常见问题及解决方案

#### 权限相关问题

**问题**: "机器人不在此群内"
**原因**: 机器人未加入目标群组
**解决**: 确保机器人已在目标群组中，或检查群组ID是否正确

**问题**: "需要管理员权限"
**原因**: 当前用户不是群管理员
**解决**: 联系群主或管理员获取相应权限

#### 数据获取问题

**问题**: "获取成员列表失败"
**原因**: 平台API限制或网络问题
**解决**: 检查网络连接，适当增加超时时间，或分批获取数据

#### 参数验证错误

当工具调用失败时，系统会返回详细的错误信息：

```json
{
  "success": false,
  "error": "缺少必需参数: group_id (群号)",
  "missing_params": ["group_id"],
  "invalid_params": []
}
```

**章节来源**
- [helpers.js](file://src/mcp/tools/helpers.js#L780-L787)

## 结论

群组信息工具类别为 QQ 群组管理提供了完整、灵活的解决方案。通过标准化的 MCP 协议接口，用户可以轻松实现群组信息查询、成员管理、状态监控等各种功能。

该工具类别的主要优势包括：

1. **完整的功能覆盖**: 涵盖群组管理的各个方面
2. **灵活的权限控制**: 支持多层次的权限管理
3. **标准化的接口**: 基于 MCP 协议，易于集成和扩展
4. **完善的错误处理**: 提供详细的错误信息和恢复机制
5. **良好的性能表现**: 优化的数据处理和缓存机制

通过合理配置和使用这些工具，用户可以实现高效的群组自动化管理，提升群组运营效率和用户体验。
