# åª’ä½“æœåŠ¡

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [ImageService.js](file://src/services/media/ImageService.js)
- [RenderService.js](file://src/services/media/RenderService.js)
- [RedisClient.js](file://src/core/cache/RedisClient.js)
- [config.js](file://config/config.js)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js)
- [media.js](file://src/mcp/tools/media.js)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–åˆ†æ](#ä¾èµ–åˆ†æ)
7. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» ChatAI æ’ä»¶çš„åª’ä½“æœåŠ¡ï¼Œé‡ç‚¹æ¶µç›– ImageService çš„å›¾ç‰‡ç”Ÿæˆä¸å¤„ç†èƒ½åŠ›ï¼Œä»¥åŠ RenderService çš„æ¸²æŸ“æœåŠ¡å®ç°ã€‚å†…å®¹åŒ…æ‹¬å›¾ç‰‡å°ºå¯¸æ§åˆ¶ã€æ ¼å¼è½¬æ¢ã€è´¨é‡ä¼˜åŒ–ã€æ¨¡æ¿æ¸²æŸ“ã€æ ·å¼å¤„ç†ã€è¾“å‡ºæ ¼å¼æ§åˆ¶ç­‰ç‰¹æ€§ã€‚åŒæ—¶è¯´æ˜åª’ä½“æœåŠ¡ä¸å‰ç«¯ç®¡ç†é¢æ¿çš„é›†æˆæ–¹å¼ï¼Œä»¥åŠä¸ AI æ¨¡å‹æœåŠ¡çš„åä½œæœºåˆ¶ï¼Œå¹¶æä¾›å…·ä½“çš„ä½¿ç”¨ç¤ºä¾‹ã€é”™è¯¯å¤„ç†ç­–ç•¥ï¼Œä»¥åŠåª’ä½“æ–‡ä»¶çš„å­˜å‚¨ã€ç¼“å­˜å’Œæ¸…ç†æœºåˆ¶ã€‚

## é¡¹ç›®ç»“æ„
åª’ä½“æœåŠ¡ä½äºæ’ä»¶çš„åç«¯æœåŠ¡å±‚ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦æ–‡ä»¶ç»„ç»‡å¦‚ä¸‹ï¼š
- åª’ä½“æœåŠ¡æ ¸å¿ƒï¼šImageServiceï¼ˆå›¾ç‰‡å¤„ç†ï¼‰ã€RenderServiceï¼ˆæ¸²æŸ“æœåŠ¡ï¼‰
- ç¼“å­˜æœåŠ¡ï¼šRedisClientï¼ˆåŸºäº ioredis çš„ Redis å®¢æˆ·ç«¯ï¼‰
- é…ç½®ç®¡ç†ï¼šconfig.jsï¼ˆç»Ÿä¸€é…ç½®ä¸­å¿ƒï¼‰
- è·¯ç”±æ¥å£ï¼šimageRoutes.jsï¼ˆå›¾åƒç”Ÿæˆç›¸å…³ APIï¼‰
- MCP å·¥å…·ï¼šmedia.jsï¼ˆåª’ä½“å¤„ç†å·¥å…·é›†ï¼‰

```mermaid
graph TB
subgraph "åç«¯æœåŠ¡"
IS["ImageService<br/>å›¾ç‰‡å¤„ç†ä¸å­˜å‚¨"]
RS["RenderService<br/>æ¸²æŸ“æœåŠ¡"]
RC["RedisClient<br/>ç¼“å­˜å®¢æˆ·ç«¯"]
CFG["config.js<br/>é…ç½®ä¸­å¿ƒ"]
IR["imageRoutes.js<br/>å›¾åƒç”Ÿæˆè·¯ç”±"]
MT["media.js<br/>MCPåª’ä½“å·¥å…·"]
end
subgraph "å‰ç«¯é›†æˆ"
FE["å‰ç«¯ç®¡ç†é¢æ¿<br/>Next.jsåº”ç”¨"]
end
FE --> IR
IR --> IS
IR --> RS
IS --> RC
RS --> RC
IS --> CFG
RS --> CFG
MT --> IS
MT --> RS
```

**å›¾è¡¨æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L1-L849)
- [RenderService.js](file://src/services/media/RenderService.js#L1-L2439)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L1-L130)
- [config.js](file://config/config.js#L1-L631)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L1-L487)
- [media.js](file://src/mcp/tools/media.js#L1-L892)

**ç« èŠ‚æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L1-L849)
- [RenderService.js](file://src/services/media/RenderService.js#L1-L2439)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L1-L130)
- [config.js](file://config/config.js#L1-L631)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L1-L487)
- [media.js](file://src/mcp/tools/media.js#L1-L892)

## æ ¸å¿ƒç»„ä»¶
æœ¬èŠ‚æ¦‚è¿°åª’ä½“æœåŠ¡çš„å…³é”®ç»„ä»¶åŠå…¶èŒè´£ï¼š

- ImageServiceï¼šè´Ÿè´£å›¾ç‰‡ä¸Šä¼ ã€éªŒè¯ã€å¤„ç†ã€å­˜å‚¨ã€ç¼“å­˜ã€åˆ é™¤ã€æ‰¹é‡å¤„ç†ã€æ ¼å¼è½¬æ¢ã€å°ºå¯¸è°ƒæ•´ã€å‹ç¼©ã€ç½‘æ ¼åˆ‡å‰²ç­‰ã€‚
- RenderServiceï¼šè´Ÿè´£å°† Markdown æ–‡æœ¬æ¸²æŸ“ä¸ºå›¾ç‰‡ï¼Œæ”¯æŒæ•°å­¦å…¬å¼æ¸²æŸ“ã€ä¸»é¢˜æ ·å¼ã€æ¨¡æ¿æ¸²æŸ“ã€Canvas å¿«é€Ÿæ¸²æŸ“ã€Puppeteer æ¸²æŸ“ç­‰ã€‚
- RedisClientï¼šæä¾› Redis ç¼“å­˜èƒ½åŠ›ï¼Œç”¨äºå›¾ç‰‡å…ƒæ•°æ®ç¼“å­˜ã€URL éªŒè¯ç¼“å­˜ç­‰ã€‚
- é…ç½®ç³»ç»Ÿï¼šé›†ä¸­ç®¡ç†åª’ä½“æœåŠ¡ç›¸å…³çš„é…ç½®ï¼ŒåŒ…æ‹¬å­˜å‚¨è·¯å¾„ã€å¤§å°é™åˆ¶ã€æ ¼å¼æ”¯æŒã€æ¸²æŸ“ä¸»é¢˜ç­‰ã€‚
- è·¯ç”±æ¥å£ï¼šæä¾›å›¾åƒç”Ÿæˆã€é¢„è®¾ç®¡ç†ã€é…ç½®æ›´æ–°ç­‰ APIã€‚
- MCP å·¥å…·ï¼šæä¾›è§£æå›¾ç‰‡ã€ç”ŸæˆäºŒç»´ç ã€å‘é€å›¾ç‰‡ç­‰å·¥å…·æ–¹æ³•ã€‚

**ç« èŠ‚æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L17-L86)
- [RenderService.js](file://src/services/media/RenderService.js#L39-L83)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L4-L61)
- [config.js](file://config/config.js#L271-L282)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L57-L113)
- [media.js](file://src/mcp/tools/media.js#L8-L75)

## æ¶æ„æ¦‚è§ˆ
åª’ä½“æœåŠ¡é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œå‰ç«¯é€šè¿‡è·¯ç”±æ¥å£ä¸åç«¯äº¤äº’ï¼Œåç«¯é€šè¿‡æœåŠ¡å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œç¼“å­˜å±‚æä¾›é«˜æ€§èƒ½æ•°æ®è®¿é—®ï¼Œé…ç½®å±‚ç»Ÿä¸€ç®¡ç†è¿è¡Œå‚æ•°ã€‚

```mermaid
sequenceDiagram
participant FE as "å‰ç«¯ç®¡ç†é¢æ¿"
participant API as "imageRoutes.js"
participant IS as "ImageService"
participant RS as "RenderService"
participant RC as "RedisClient"
participant FS as "æ–‡ä»¶ç³»ç»Ÿ"
FE->>API : è¯·æ±‚å›¾åƒç”Ÿæˆ/é¢„è®¾ç®¡ç†
API->>IS : å›¾ç‰‡å¤„ç†/å­˜å‚¨
IS->>RC : ç¼“å­˜å…ƒæ•°æ®
IS->>FS : ä¿å­˜å›¾ç‰‡/ç¼©ç•¥å›¾
API->>RS : æ¸²æŸ“Markdownä¸ºå›¾ç‰‡
RS->>RC : åŠ è½½å­—ä½“/ä¸»é¢˜ç¼“å­˜
RS-->>API : è¿”å›å›¾ç‰‡Buffer
API-->>FE : è¿”å›å¤„ç†ç»“æœ
```

**å›¾è¡¨æ¥æº**
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L319-L330)
- [ImageService.js](file://src/services/media/ImageService.js#L41-L86)
- [RenderService.js](file://src/services/media/RenderService.js#L873-L1020)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L43-L65)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### ImageService ç»„ä»¶åˆ†æ
ImageService æ˜¯åª’ä½“æœåŠ¡çš„æ ¸å¿ƒï¼Œè´Ÿè´£å›¾ç‰‡çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

#### ä¸»è¦åŠŸèƒ½
- å›¾ç‰‡ä¸Šä¼ ä¸éªŒè¯ï¼šæ”¯æŒ Bufferã€URLã€æœ¬åœ°æ–‡ä»¶ç­‰å¤šç§è¾“å…¥æºï¼Œè¿›è¡Œå¤§å°é™åˆ¶ã€æ ¼å¼éªŒè¯ã€å…ƒæ•°æ®æå–ã€‚
- å›¾ç‰‡å¤„ç†ï¼šç¼©ç•¥å›¾ç”Ÿæˆã€æ ¼å¼è½¬æ¢ã€å°ºå¯¸è°ƒæ•´ã€è´¨é‡å‹ç¼©ã€ç½‘æ ¼åˆ‡å‰²ã€‚
- å­˜å‚¨ä¸ç¼“å­˜ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨ + Redis ç¼“å­˜ï¼Œæ”¯æŒå›¾ç‰‡åˆ é™¤ã€æ¸…ç†æ—§æ–‡ä»¶ã€‚
- URL å¤„ç†ï¼šæ”¯æŒ HTTP/HTTPSã€æœ¬åœ°æ–‡ä»¶ã€Base64ã€QQ ç‰¹æ®ŠåŸŸåç­‰ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¯ç”¨æ ¼å¼ã€‚
- æ‰¹é‡å¤„ç†ï¼šæ”¯æŒæ‰¹é‡å‡†å¤‡å›¾ç‰‡ç”¨äº API è°ƒç”¨ã€‚

#### å…³é”®ç‰¹æ€§
- **å°ºå¯¸æ§åˆ¶**ï¼šæ”¯æŒæŒ‡å®šæœ€å¤§å®½é«˜ï¼Œè‡ªåŠ¨æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œé˜²æ­¢æ”¾å¤§ã€‚
- **æ ¼å¼è½¬æ¢**ï¼šæ”¯æŒ JPEGã€PNGã€WebPã€GIF ç­‰æ ¼å¼è½¬æ¢ï¼Œå¯æŒ‡å®šè´¨é‡å‚æ•°ã€‚
- **è´¨é‡ä¼˜åŒ–**ï¼šæä¾›å‹ç¼©æ¥å£ï¼Œè®¡ç®—å‹ç¼©å‰åå­—èŠ‚æ•°å’ŒèŠ‚çœç™¾åˆ†æ¯”ã€‚
- **ç½‘æ ¼åˆ‡å‰²**ï¼šæ”¯æŒå°†å›¾ç‰‡æŒ‰è¡Œåˆ—åˆ‡å‰²ä¸ºå¤šä¸ªå•å…ƒæ ¼ï¼Œç”¨äº OCR æˆ–åˆ†æåœºæ™¯ã€‚
- **URL éªŒè¯**ï¼šæ”¯æŒ HTTP HEAD/GET éªŒè¯ï¼Œç‰¹æ®ŠåŸŸåè‡ªåŠ¨æ·»åŠ  Refererï¼Œç¼“å­˜éªŒè¯ç»“æœã€‚

```mermaid
classDiagram
class ImageService {
+constructor()
+init()
+uploadImage(buffer, originalName) Promise~Object~
+getImage(id) Promise~Object|null~
+getImageBuffer(id) Promise~Buffer|null~
+getImageBase64(id, format) Promise~string~
+validateImageUrl(url, timeout) Promise~Object~
+downloadImageBuffer(url, timeout) Promise~Buffer~
+downloadImage(url) Promise~Object~
+urlToBase64(url) Promise~string~
+prepareImageForApi(url, options) Promise~Object~
+prepareImagesForApi(urls, options) Promise~Object~
+deleteImage(id) Promise~boolean~
+cleanupOldImages() Promise~number~
+processYunzaiImages(segments) Promise~Array~
+convertForApi(imageId, targetFormat) Promise~string~
+compressImage(imageId, options) Promise~Object~
+convertFormat(imageId, targetFormat) Promise~Object~
+resizeImage(imageId, width, height, fit) Promise~Object~
+splitGridImage(input, options) Promise~Array~
}
```

**å›¾è¡¨æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L17-L849)

**ç« èŠ‚æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L17-L849)

#### å›¾ç‰‡å¤„ç†æµç¨‹ï¼ˆåºåˆ—å›¾ï¼‰
```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant IS as "ImageService"
participant Sharp as "Sharpåº“"
participant Redis as "RedisClient"
participant FS as "æ–‡ä»¶ç³»ç»Ÿ"
Client->>IS : uploadImage(buffer, name)
IS->>IS : éªŒè¯å¤§å°/æ ¼å¼
IS->>Sharp : è¯»å–å…ƒæ•°æ®
IS->>FS : ä¿å­˜åŸå›¾
IS->>Sharp : ç”Ÿæˆç¼©ç•¥å›¾
IS->>FS : ä¿å­˜ç¼©ç•¥å›¾
IS->>Redis : ç¼“å­˜å…ƒæ•°æ®
IS-->>Client : è¿”å›å›¾ç‰‡å…ƒæ•°æ®
```

**å›¾è¡¨æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L41-L86)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L43-L65)

#### URL éªŒè¯ä¸è½¬æ¢æµç¨‹ï¼ˆæµç¨‹å›¾ï¼‰
```mermaid
flowchart TD
Start(["å¼€å§‹"]) --> CheckInput["æ£€æŸ¥è¾“å…¥URL"]
CheckInput --> IsBase64{"æ˜¯å¦Base64?"}
IsBase64 --> |æ˜¯| ReturnBase64["è¿”å›Base64"]
IsBase64 --> |å¦| IsLocal{"æ˜¯å¦æœ¬åœ°æ–‡ä»¶?"}
IsLocal --> |æ˜¯| ValidateLocal["éªŒè¯æœ¬åœ°æ–‡ä»¶å­˜åœ¨"]
ValidateLocal --> ReturnLocal["è¿”å›æœ¬åœ°æ–‡ä»¶"]
IsLocal --> |å¦| CheckCache["æ£€æŸ¥URLç¼“å­˜"]
CheckCache --> CacheHit{"ç¼“å­˜å‘½ä¸­?"}
CacheHit --> |æ˜¯| ReturnCached["è¿”å›ç¼“å­˜ç»“æœ"]
CacheHit --> |å¦| FetchURL["HTTPè¯·æ±‚éªŒè¯"]
FetchURL --> ValidateResp["éªŒè¯å“åº”ç±»å‹/å¤§å°"]
ValidateResp --> IsImage{"æ˜¯å¦å›¾ç‰‡?"}
IsImage --> |æ˜¯| ReturnValid["è¿”å›æœ‰æ•ˆç»“æœ"]
IsImage --> |å¦| ConvertIfNeeded["æ˜¯å¦éœ€è¦è½¬æ¢ä¸ºBase64?"]
ConvertIfNeeded --> |æ˜¯| ToBase64["ä¸‹è½½å¹¶è½¬æ¢ä¸ºBase64"]
ConvertIfNeeded --> |å¦| ReturnInvalid["è¿”å›æ— æ•ˆç»“æœ"]
ReturnBase64 --> End(["ç»“æŸ"])
ReturnLocal --> End
ReturnCached --> End
ReturnValid --> End
ToBase64 --> End
ReturnInvalid --> End
```

**å›¾è¡¨æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L164-L250)
- [ImageService.js](file://src/services/media/ImageService.js#L346-L425)

### RenderService ç»„ä»¶åˆ†æ
RenderService è´Ÿè´£å°† Markdown æ–‡æœ¬æ¸²æŸ“ä¸ºé«˜è´¨é‡å›¾ç‰‡ï¼Œæ”¯æŒæ•°å­¦å…¬å¼æ¸²æŸ“ã€ä¸»é¢˜æ ·å¼ã€æ¨¡æ¿æ¸²æŸ“ç­‰ã€‚

#### ä¸»è¦åŠŸèƒ½
- **æ•°å­¦å…¬å¼æ¸²æŸ“**ï¼šè‡ªåŠ¨æ£€æµ‹æ•°å­¦å…¬å¼ï¼Œä½¿ç”¨ KaTeX æ¸²æŸ“ï¼Œæ”¯æŒå¤šç§ LaTeX è¯­æ³•ã€‚
- **ä¸»é¢˜æ ·å¼**ï¼šæ”¯æŒæµ…è‰²/æ·±è‰²ä¸»é¢˜ï¼ŒåŠ¨æ€ç”Ÿæˆ CSS æ ·å¼ã€‚
- **æ¨¡æ¿æ¸²æŸ“**ï¼šæä¾›ç¾¤èŠæ€»ç»“ã€ç”¨æˆ·ç”»åƒã€åˆ†ææŠ¥å‘Šã€è®°å¿†åˆ—è¡¨ã€è¯äº‘ç­‰æ¨¡æ¿ã€‚
- **æ¸²æŸ“å¼•æ“**ï¼šä¼˜å…ˆä½¿ç”¨ Canvas å¿«é€Ÿæ¸²æŸ“ï¼Œå›é€€åˆ° Puppeteer æ¸²æŸ“ã€‚
- **å­—ä½“ç®¡ç†**ï¼šæ”¯æŒè‡ªå®šä¹‰ä¸­æ–‡å­—ä½“ï¼Œè‡ªåŠ¨åŠ è½½ç³»ç»Ÿå­—ä½“ã€‚

#### å…³é”®ç‰¹æ€§
- **æ•°å­¦å…¬å¼æ£€æµ‹**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹ LaTeX å—çº§ã€è¡Œå†…ã€ç¯å¢ƒç­‰å…¬å¼ï¼Œé¿å…è¯¯åˆ¤ã€‚
- **ä¸»é¢˜æ ·å¼**ï¼šåŠ¨æ€ç”Ÿæˆ CSSï¼Œæ”¯æŒå®¹å™¨ã€æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ã€è¡¨æ ¼ç­‰æ ·å¼ã€‚
- **æ¨¡æ¿ç³»ç»Ÿ**ï¼šæä¾›å¤šç§é¢„è®¾æ¨¡æ¿ï¼Œæ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜ã€å‰¯æ ‡é¢˜ã€å›¾æ ‡ã€æ—¶é—´æˆ³ç­‰ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šCanvas æ¸²æŸ“æ¯” Puppeteer å¿« 10 å€ä»¥ä¸Šï¼Œé€‚åˆå¤§é‡æ–‡æœ¬æ¸²æŸ“ã€‚

```mermaid
classDiagram
class RenderService {
+constructor()
+detectMathFormulas(text) Object
+convertToLatex(text) string
+renderMathContent(text, options) Promise~Buffer~
+getBrowser() Promise~Object~
+closeBrowser() Promise~void~
+loadFonts() Promise~void~
+renderWithCanvas(options) Promise~Buffer~
+parseMarkdownToLines(markdown) string[]
+cleanMarkdown(text) string
+protectMathExpressions(text) Object
+restoreMathExpressions(html, expressions) string
+getThemeStyles(theme) string
+renderMarkdownToImage(options) Promise~Buffer~
+renderGroupSummary(markdown, options) Promise~Buffer~
+renderUserProfile(markdown, nickname, options) Promise~Buffer~
+renderAnalysisReport(markdown, options) Promise~Buffer~
+renderMemoryList(memories, nickname, options) Promise~Buffer~
+renderWordCloud(words, options) Promise~Buffer~
}
```

**å›¾è¡¨æ¥æº**
- [RenderService.js](file://src/services/media/RenderService.js#L39-L2399)

**ç« èŠ‚æ¥æº**
- [RenderService.js](file://src/services/media/RenderService.js#L39-L2399)

#### æ¸²æŸ“æµç¨‹ï¼ˆåºåˆ—å›¾ï¼‰
```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant RS as "RenderService"
participant Marked as "Markedè§£æå™¨"
participant KaTeX as "KaTeXæ¸²æŸ“å™¨"
participant Browser as "Puppeteeræµè§ˆå™¨"
Client->>RS : renderMarkdownToImage(options)
RS->>RS : æ¸…ç†Markdownå†…å®¹
RS->>RS : ä¿æŠ¤æ•°å­¦å…¬å¼
RS->>Marked : è§£æMarkdown
RS->>RS : æ¢å¤æ•°å­¦å…¬å¼
RS->>RS : ç”Ÿæˆä¸»é¢˜æ ·å¼
alt åŒ…å«æ•°å­¦å…¬å¼
RS->>KaTeX : æ¸²æŸ“å…¬å¼
end
RS->>Browser : æˆªå›¾ç”Ÿæˆå›¾ç‰‡
Browser-->>RS : è¿”å›å›¾ç‰‡Buffer
RS-->>Client : è¿”å›å›¾ç‰‡Buffer
```

**å›¾è¡¨æ¥æº**
- [RenderService.js](file://src/services/media/RenderService.js#L873-L1020)

### å‰ç«¯ç®¡ç†é¢æ¿é›†æˆ
åª’ä½“æœåŠ¡ä¸å‰ç«¯ç®¡ç†é¢æ¿é€šè¿‡ Express è·¯ç”±æ¥å£è¿›è¡Œé›†æˆï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
- å›¾åƒç”Ÿæˆé…ç½®ç®¡ç†ï¼šè·å–/æ›´æ–°å›¾åƒç”Ÿæˆé…ç½®
- é¢„è®¾ç®¡ç†ï¼šå†…ç½®ã€è‡ªå®šä¹‰ã€è¿œç¨‹é¢„è®¾çš„å¢åˆ æ”¹æŸ¥
- é¢„è®¾æ¥æºç®¡ç†ï¼šæ·»åŠ /æ›´æ–°/åˆ é™¤é¢„è®¾æ¥æº
- é¢„è®¾çƒ­é‡è½½ä¸è¿œç¨‹æ›´æ–°

```mermaid
sequenceDiagram
participant FE as "å‰ç«¯ç®¡ç†é¢æ¿"
participant IR as "imageRoutes.js"
participant CFG as "config.js"
FE->>IR : GET /config
IR->>CFG : è¯»å–é…ç½®
CFG-->>IR : è¿”å›é…ç½®
IR-->>FE : è¿”å›é…ç½®
FE->>IR : PUT /config
IR->>CFG : æ›´æ–°é…ç½®
CFG-->>IR : ä¿å­˜é…ç½®
IR-->>FE : è¿”å›æˆåŠŸ
FE->>IR : GET /presets
IR->>CFG : è¯»å–å†…ç½®/è‡ªå®šä¹‰é¢„è®¾
IR-->>FE : è¿”å›æ‰€æœ‰é¢„è®¾
```

**å›¾è¡¨æ¥æº**
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L59-L113)
- [config.js](file://config/config.js#L591-L626)

**ç« èŠ‚æ¥æº**
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L57-L487)
- [config.js](file://config/config.js#L477-L490)

### ä¸ AI æ¨¡å‹æœåŠ¡çš„åä½œæœºåˆ¶
åª’ä½“æœåŠ¡ä¸ AI æ¨¡å‹æœåŠ¡é€šè¿‡ä»¥ä¸‹æ–¹å¼åä½œï¼š
- å›¾ç‰‡é¢„å¤„ç†ï¼šImageService å°†å›¾ç‰‡è½¬æ¢ä¸º API å‹å¥½çš„æ ¼å¼ï¼ˆBase64ï¼‰ï¼Œæ”¯æŒå¼ºåˆ¶è½¬æ¢ä»¥ç»•è¿‡ç½‘ç»œé™åˆ¶ã€‚
- æ¸²æŸ“æœåŠ¡ï¼šRenderService å°† AI ç”Ÿæˆçš„ Markdown å†…å®¹æ¸²æŸ“ä¸ºå›¾ç‰‡ï¼Œä¾¿äºå±•ç¤ºã€‚
- MCP å·¥å…·ï¼šæä¾›è§£æå›¾ç‰‡ã€ç”ŸæˆäºŒç»´ç ã€å‘é€å›¾ç‰‡ç­‰å·¥å…·ï¼Œä¾› AI å·¥å…·è°ƒç”¨ã€‚

```mermaid
graph TB
subgraph "AIæ¨¡å‹æœåŠ¡"
LLM["LLMæœåŠ¡"]
Tools["å·¥å…·è°ƒç”¨"]
end
subgraph "åª’ä½“æœåŠ¡"
IS["ImageService"]
RS["RenderService"]
MT["MCPåª’ä½“å·¥å…·"]
end
LLM --> Tools
Tools --> IS
Tools --> RS
Tools --> MT
IS --> Tools
RS --> Tools
MT --> Tools
```

**å›¾è¡¨æ¥æº**
- [media.js](file://src/mcp/tools/media.js#L19-L75)
- [ImageService.js](file://src/services/media/ImageService.js#L346-L425)
- [RenderService.js](file://src/services/media/RenderService.js#L873-L1020)

**ç« èŠ‚æ¥æº**
- [media.js](file://src/mcp/tools/media.js#L1-L892)
- [ImageService.js](file://src/services/media/ImageService.js#L346-L425)
- [RenderService.js](file://src/services/media/RenderService.js#L873-L1020)

## ä¾èµ–åˆ†æ
åª’ä½“æœåŠ¡çš„ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œè€¦åˆåº¦ä½ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

```mermaid
graph TB
IS["ImageService"] --> Sharp["sharpåº“"]
IS --> Redis["ioredis"]
RS["RenderService"] --> Marked["markedè§£æå™¨"]
RS --> Puppeteer["puppeteeræµè§ˆå™¨"]
RS --> Canvas["@napi-rs/canvas"]
RS --> KaTeX["KaTeXæ¸²æŸ“å™¨"]
IS --> Config["config.js"]
RS --> Config
IR["imageRoutes.js"] --> IS
IR --> RS
IR --> Config
MT["media.js"] --> IS
MT --> RS
```

**å›¾è¡¨æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L1-L10)
- [RenderService.js](file://src/services/media/RenderService.js#L1-L33)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L4-L18)
- [media.js](file://src/mcp/tools/media.js#L6-L7)

**ç« èŠ‚æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L1-L10)
- [RenderService.js](file://src/services/media/RenderService.js#L1-L33)
- [imageRoutes.js](file://src/services/routes/imageRoutes.js#L4-L18)
- [media.js](file://src/mcp/tools/media.js#L6-L7)

## æ€§èƒ½è€ƒè™‘
- **ç¼“å­˜ç­–ç•¥**ï¼šä½¿ç”¨ Redis ç¼“å­˜å›¾ç‰‡å…ƒæ•°æ®å’Œ URL éªŒè¯ç»“æœï¼Œå‡å°‘é‡å¤ IO å’Œç½‘ç»œè¯·æ±‚ã€‚
- **æ¸²æŸ“ä¼˜åŒ–**ï¼šä¼˜å…ˆä½¿ç”¨ Canvas å¿«é€Ÿæ¸²æŸ“ï¼Œé€‚åˆå¤§é‡æ–‡æœ¬æ¸²æŸ“åœºæ™¯ï¼›Puppeteer é€‚åˆå¤æ‚ HTML/CSS åœºæ™¯ã€‚
- **å›¾ç‰‡å¤„ç†**ï¼šä½¿ç”¨ Sharp è¿›è¡Œé«˜æ•ˆçš„å›¾ç‰‡å¤„ç†ï¼Œæ”¯æŒå¤šæ ¼å¼è½¬æ¢å’Œè´¨é‡æ§åˆ¶ã€‚
- **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾ Puppeteer æµè§ˆå™¨å®ä¾‹ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
- **å¹¶å‘å¤„ç†**ï¼šæ‰¹é‡å¤„ç†å›¾ç‰‡æ—¶ä½¿ç”¨ Promise.all å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜ååé‡ã€‚

## æ•…éšœæ’é™¤æŒ‡å—
- **å›¾ç‰‡ä¸Šä¼ å¤±è´¥**ï¼šæ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶ã€æ ¼å¼æ˜¯å¦å—æ”¯æŒã€ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚
- **URL æ— æ³•è®¿é—®**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ã€ç›®æ ‡æœåŠ¡å™¨æ˜¯å¦æ”¯æŒ HEAD/GET è¯·æ±‚ã€æ˜¯å¦éœ€è¦ç‰¹æ®Š Refererã€‚
- **æ¸²æŸ“å¤±è´¥**ï¼šæ£€æŸ¥ Puppeteer æ˜¯å¦æ­£ç¡®å®‰è£…ã€å­—ä½“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€HTML/CSS æ˜¯å¦åˆæ³•ã€‚
- **Redis è¿æ¥å¤±è´¥**ï¼šæ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€ã€é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ã€ç½‘ç»œæ˜¯å¦å¯è¾¾ã€‚
- **å†…å­˜ä¸è¶³**ï¼šç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŠæ—¶æ¸…ç†ç¼“å­˜å’Œå…³é—­ä¸å¿…è¦çš„æµè§ˆå™¨å®ä¾‹ã€‚

**ç« èŠ‚æ¥æº**
- [ImageService.js](file://src/services/media/ImageService.js#L164-L250)
- [RenderService.js](file://src/services/media/RenderService.js#L402-L425)
- [RedisClient.js](file://src/core/cache/RedisClient.js#L10-L41)

## ç»“è®º
åª’ä½“æœåŠ¡æä¾›äº†å®Œæ•´çš„å›¾ç‰‡å¤„ç†å’Œæ¸²æŸ“èƒ½åŠ›ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§å’Œç¨³å®šæ€§ã€‚é€šè¿‡åˆç†çš„ç¼“å­˜ç­–ç•¥ã€æ¸²æŸ“ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†æœºåˆ¶ï¼Œèƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„åª’ä½“å¤„ç†éœ€æ±‚ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åˆç†é…ç½® Redisã€å­—ä½“æ–‡ä»¶å’Œæ¸²æŸ“å‚æ•°ï¼Œä»¥è·å¾—æœ€ä½³æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

## é™„å½•

### ä½¿ç”¨ç¤ºä¾‹

#### å›¾ç‰‡ç”Ÿæˆæµç¨‹
```javascript
// 1. ä¸Šä¼ å›¾ç‰‡
const imageData = await imageService.uploadImage(buffer, 'example.png');

// 2. è½¬æ¢ä¸º API å‹å¥½æ ¼å¼
const base64Url = await imageService.getImageBase64(imageData.id, 'jpeg');

// 3. å‡†å¤‡å›¾ç‰‡ç”¨äº API è°ƒç”¨
const prepared = await imageService.prepareImageForApi(url, { forceBase64: true });
```

#### æ¸²æŸ“é…ç½®é€‰é¡¹
```javascript
// æ¸²æŸ“ Markdown ä¸ºå›¾ç‰‡
const imageBuffer = await renderService.renderMarkdownToImage({
  markdown: '# æ ‡é¢˜\n\nå†…å®¹',
  title: 'æ ‡é¢˜',
  subtitle: 'å‰¯æ ‡é¢˜',
  icon: 'ğŸ“Š',
  theme: 'light',
  width: 800,
  showTimestamp: true
});
```

#### é”™è¯¯å¤„ç†ç­–ç•¥
```javascript
try {
  const result = await imageService.prepareImageForApi(url);
  if (!result.url) {
    throw new Error(result.error || 'æ— æ³•è·å–å›¾ç‰‡');
  }
} catch (error) {
  logger.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error.message);
  // å›é€€åˆ°æœ¬åœ°æ–‡ä»¶æˆ–å…¶ä»–å¤„ç†æ–¹å¼
}
```

### é…ç½®é€‰é¡¹
- **å›¾ç‰‡å­˜å‚¨**ï¼šstoragePathã€maxSizeã€allowedFormats
- **æ¸²æŸ“ä¸»é¢˜**ï¼šrender.mathFormulaã€render.themeã€render.width
- **å›¾åƒç”Ÿæˆ**ï¼šfeatures.imageGen.enabledã€modelã€timeoutã€maxImages

**ç« èŠ‚æ¥æº**
- [config.js](file://config/config.js#L278-L282)
- [config.js](file://config/config.js#L393-L398)
- [config.js](file://config/config.js#L477-L490)