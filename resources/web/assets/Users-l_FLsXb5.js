import{W as B,r as f,l as V,X as F,Y as b,Z as t,$ as e,a0 as N,a1 as h,a2 as x,a3 as l,a4 as O,az as Q,P as j,ay as M,Q as v,a5 as u,b3 as q,a6 as P,ac as E,aa as i,ab as _,a7 as R,a8 as I,h as c}from"./index-Djva7SqX.js";import{S as W}from"./SearchOutlined-wL2ODODN.js";import{N as X}from"./DataTable-jx0pgYFA.js";import{N as Y,a as d}from"./DescriptionsItem-9YX3s5OT.js";import{N as U}from"./InputNumber-D5K1aSQ_.js";import{N as Z}from"./Switch-C5jJhFCr.js";import{N as G}from"./Popconfirm-YD1GkPSH.js";import"./Select-A1ZDk8Ui.js";const oe={__name:"Users",setup(H){const m=B(),y=f(!1),g=f([]),k=f(""),D=f(!1),r=f(null),p=f(!1),n=f({maxTokensPerDay:1e5,maxMessagesPerDay:100,allowedModels:[],blocked:!1}),z=[{title:"用户ID",key:"userId",width:150,ellipsis:{tooltip:!0}},{title:"昵称",key:"nickname",width:120,ellipsis:{tooltip:!0}},{title:"对话数",key:"conversationCount",width:80,align:"center"},{title:"消息数",key:"messageCount",width:80,align:"center"},{title:"最后活动",key:"lastActivity",width:140,render:a=>C(a.lastActivity)},{title:"状态",key:"status",width:80,render:a=>a.blocked?c(_,{type:"error",size:"small"},()=>"已封禁"):c(_,{type:"success",size:"small"},()=>"正常")},{title:"操作",key:"actions",width:180,render:a=>c(N,{size:"small"},()=>[c(v,{size:"small",onClick:()=>T(a)},()=>"详情"),c(v,{size:"small",type:"info",onClick:()=>A(a)},()=>"设置"),c(G,{onPositiveClick:()=>$(a.userId)},{trigger:()=>c(v,{size:"small",type:"warning"},()=>"清除"),default:()=>"确定清除该用户的所有数据？"})])}],S=V(()=>{if(!k.value)return g.value;const a=k.value.toLowerCase();return g.value.filter(s=>s.userId?.toLowerCase().includes(a)||s.nickname?.toLowerCase().includes(a))});async function w(){y.value=!0;try{const a=await h.get("/api/users/list");a.data.code===0&&(g.value=a.data.data||[])}catch(a){m.error("获取用户列表失败: "+a.message)}finally{y.value=!1}}function T(a){r.value=a,D.value=!0}function A(a){r.value=a,n.value={maxTokensPerDay:a.settings?.maxTokensPerDay||1e5,maxMessagesPerDay:a.settings?.maxMessagesPerDay||100,allowedModels:a.settings?.allowedModels||[],blocked:a.blocked||!1},p.value=!0}async function L(){try{(await h.put(`/api/users/${r.value.userId}/settings`,n.value)).data.code===0&&(m.success("设置已保存"),p.value=!1,w())}catch(a){m.error("保存失败: "+a.message)}}async function $(a){try{(await h.delete(`/api/users/${a}/data`)).data.code===0&&(m.success("用户数据已清除"),w())}catch(s){m.error("清除失败: "+s.message)}}function C(a){return a?new Date(a).toLocaleString("zh-CN"):"-"}return F(()=>{w()}),(a,s)=>(x(),b(e(N),{vertical:"",size:"large"},{default:t(()=>[l(e(O),{title:"用户管理"},{"header-extra":t(()=>[l(e(N),null,{default:t(()=>[l(e(j),{value:k.value,"onUpdate:value":s[0]||(s[0]=o=>k.value=o),placeholder:"搜索用户ID或昵称",clearable:"",style:{width:"200px"}},{prefix:t(()=>[l(e(M),null,{default:t(()=>[l(e(W))]),_:1})]),_:1},8,["value"]),l(e(v),{onClick:w,loading:y.value},{icon:t(()=>[l(e(M),null,{default:t(()=>[l(e(q))]),_:1})]),default:t(()=>[s[7]||(s[7]=u(" 刷新 ",-1))]),_:1},8,["loading"])]),_:1})]),default:t(()=>[g.value.length===0?(x(),b(e(Q),{key:0,description:"暂无用户数据"})):(x(),b(e(X),{key:1,columns:z,data:S.value,loading:y.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"]))]),_:1}),l(e(P),{show:D.value,"onUpdate:show":s[1]||(s[1]=o=>D.value=o),preset:"card",title:"用户详情",style:{width:"500px"}},{default:t(()=>[r.value?(x(),b(e(Y),{key:0,column:1,"label-placement":"left",bordered:""},{default:t(()=>[l(e(d),{label:"用户ID"},{default:t(()=>[u(i(r.value.userId),1)]),_:1}),l(e(d),{label:"昵称"},{default:t(()=>[u(i(r.value.nickname||"-"),1)]),_:1}),l(e(d),{label:"对话数"},{default:t(()=>[u(i(r.value.conversationCount||0),1)]),_:1}),l(e(d),{label:"消息数"},{default:t(()=>[u(i(r.value.messageCount||0),1)]),_:1}),l(e(d),{label:"Token使用"},{default:t(()=>[u(i(r.value.tokenUsage||0),1)]),_:1}),l(e(d),{label:"首次活动"},{default:t(()=>[u(i(C(r.value.firstActivity)),1)]),_:1}),l(e(d),{label:"最后活动"},{default:t(()=>[u(i(C(r.value.lastActivity)),1)]),_:1}),l(e(d),{label:"状态"},{default:t(()=>[l(e(_),{type:r.value.blocked?"error":"success",size:"small"},{default:t(()=>[u(i(r.value.blocked?"已封禁":"正常"),1)]),_:1},8,["type"])]),_:1})]),_:1})):E("",!0)]),_:1},8,["show"]),l(e(P),{show:p.value,"onUpdate:show":s[6]||(s[6]=o=>p.value=o),preset:"card",title:"用户设置",style:{width:"450px"}},{footer:t(()=>[l(e(N),{justify:"end"},{default:t(()=>[l(e(v),{onClick:s[5]||(s[5]=o=>p.value=!1)},{default:t(()=>[...s[8]||(s[8]=[u("取消",-1)])]),_:1}),l(e(v),{type:"primary",onClick:L},{default:t(()=>[...s[9]||(s[9]=[u("保存",-1)])]),_:1})]),_:1})]),default:t(()=>[l(e(R),{"label-placement":"left","label-width":"120"},{default:t(()=>[l(e(I),{label:"每日Token限制"},{default:t(()=>[l(e(U),{value:n.value.maxTokensPerDay,"onUpdate:value":s[2]||(s[2]=o=>n.value.maxTokensPerDay=o),min:0,max:1e7,style:{width:"100%"}},null,8,["value"])]),_:1}),l(e(I),{label:"每日消息限制"},{default:t(()=>[l(e(U),{value:n.value.maxMessagesPerDay,"onUpdate:value":s[3]||(s[3]=o=>n.value.maxMessagesPerDay=o),min:0,max:1e4,style:{width:"100%"}},null,8,["value"])]),_:1}),l(e(I),{label:"封禁用户"},{default:t(()=>[l(e(Z),{value:n.value.blocked,"onUpdate:value":s[4]||(s[4]=o=>n.value.blocked=o)},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}};export{oe as default};
