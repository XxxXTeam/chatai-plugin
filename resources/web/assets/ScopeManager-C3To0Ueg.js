import{_ as fe,K as ye,x as n,C as ge,L as Ie,a2 as T,T as l,O as r,P as t,U as W,W as Q,R as I,S as $,a6 as be,V as o,Z as M,$ as S,Q as p,Y as k,a3 as ke,a4 as Pe,a0 as X,B as u,M as V,a1 as j,ad as q,X as L,N as U,h as b}from"./index-DILGEmlc.js";import{N as ce}from"./Switch-BEXbUwW7.js";import{N as we}from"./Divider-CMEiRSnR.js";import{N as Ce,a as O}from"./Tabs-Czmt7cPX.js";import{N as E}from"./DataTable-VhJo6Uli.js";import{N as _}from"./Select-bkYqJANp.js";import{N as H}from"./Popconfirm-CZwfnzWv.js";import"./Add-CG2bvB3N.js";import"./prop-NnGblK-3.js";const Ue={class:"priority-list"},Ne={class:"priority-rank"},De={class:"priority-desc"},xe={__name:"ScopeManager",setup($e){const d=ye(),z=n([]),G=n([]),h=n([]),C=n(!1),c=n({priority:["group","group_user","user","default"],useIndependent:!0}),B=n(!1),F=[{value:"group",label:"群聊人格 (group)",description:"特定群组的人格设定"},{value:"group_user",label:"群内用户人格 (group_user)",description:"特定群内特定用户的人格"},{value:"user",label:"用户全局人格 (user)",description:"用户在所有场景的人格"},{value:"default",label:"默认预设 (default)",description:"系统默认预设"}],Y=ge(()=>c.value.priority.map(a=>{const e=F.find(s=>s.value===a);return e?e.label:a}).join(" > ")),N=n(!1),D=n(!1),x=n(!1),v=n(!1),m=n({userId:"",systemPrompt:"",presetId:""}),f=n({groupId:"",systemPrompt:"",presetId:""}),i=n({groupId:"",userId:"",systemPrompt:"",presetId:""}),A=n([]),y=()=>({Authorization:`Bearer ${localStorage.getItem("token")}`});async function P(){C.value=!0;try{const[a,e,s,g,w]=await Promise.all([I.get("/api/scope/users",{headers:y()}),I.get("/api/scope/groups",{headers:y()}),I.get("/api/scope/group-users",{headers:y()}),I.get("/api/preset/list",{headers:y()}),I.get("/api/config/personality",{headers:y()})]);z.value=a.data?.data||[],G.value=e.data?.data||[],h.value=s.data?.data||[],A.value=(g.data?.data||[]).map(R=>({label:R.name||R.id,value:R.id})),w.data?.data&&(c.value={priority:w.data.data.priority||["group","group_user","user","default"],useIndependent:w.data.data.useIndependent!==!1})}catch(a){d.error("加载数据失败: "+a.message)}finally{C.value=!1}}async function Z(){B.value=!0;try{await I.patch("/api/config/personality",c.value,{headers:y()}),d.success("优先级配置已保存")}catch(a){d.error("保存失败: "+a.message)}finally{B.value=!1}}function K(a,e){const s=[...c.value.priority],g=a+e;g<0||g>=s.length||([s[a],s[g]]=[s[g],s[a]],c.value.priority=s)}const J=[{title:"用户ID",key:"userId",width:150},{title:"自定义Prompt",key:"systemPrompt",ellipsis:{tooltip:!0},render:a=>a.systemPrompt?a.systemPrompt.substring(0,50)+(a.systemPrompt.length>50?"...":""):"-"},{title:"预设",key:"presetId",width:120},{title:"更新时间",key:"updatedAt",width:180,render:a=>a.updatedAt?new Date(a.updatedAt).toLocaleString():"-"},{title:"操作",key:"actions",width:150,render:a=>b(p,null,{default:()=>[b(u,{size:"small",onClick:()=>ae(a)},{default:()=>"编辑"}),b(H,{onPositiveClick:()=>se(a.userId)},{trigger:()=>b(u,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确认删除此用户的人格设定？"})]})}],ee=[{title:"群组ID",key:"groupId",width:150},{title:"自定义Prompt",key:"systemPrompt",ellipsis:{tooltip:!0},render:a=>a.systemPrompt?a.systemPrompt.substring(0,50)+(a.systemPrompt.length>50?"...":""):"-"},{title:"预设",key:"presetId",width:120},{title:"更新时间",key:"updatedAt",width:180,render:a=>a.updatedAt?new Date(a.updatedAt).toLocaleString():"-"},{title:"操作",key:"actions",width:150,render:a=>b(p,null,{default:()=>[b(u,{size:"small",onClick:()=>oe(a)},{default:()=>"编辑"}),b(H,{onPositiveClick:()=>ie(a.groupId)},{trigger:()=>b(u,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确认删除此群组的人格设定？"})]})}],te=[{title:"群组ID",key:"groupId",width:150},{title:"用户ID",key:"userId",width:150},{title:"自定义Prompt",key:"systemPrompt",ellipsis:{tooltip:!0},render:a=>a.systemPrompt?a.systemPrompt.substring(0,50)+(a.systemPrompt.length>50?"...":""):"-"},{title:"预设",key:"presetId",width:120},{title:"操作",key:"actions",width:150,render:a=>b(p,null,{default:()=>[b(u,{size:"small",onClick:()=>pe(a)},{default:()=>"编辑"}),b(H,{onPositiveClick:()=>me(a.groupId,a.userId)},{trigger:()=>b(u,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确认删除此群内用户的人格设定？"})]})}];function le(){v.value=!1,m.value={userId:"",systemPrompt:"",presetId:""},N.value=!0}function ae(a){v.value=!0,m.value={...a},N.value=!0}async function re(){if(!m.value.userId){d.warning("请输入用户ID");return}try{await I.put(`/api/scope/user/${m.value.userId}`,{systemPrompt:m.value.systemPrompt,presetId:m.value.presetId},{headers:y()}),d.success("保存成功"),N.value=!1,P()}catch(a){d.error("保存失败: "+a.message)}}async function se(a){try{await I.delete(`/api/scope/user/${a}`,{headers:y()}),d.success("删除成功"),P()}catch(e){d.error("删除失败: "+e.message)}}function ue(){v.value=!1,f.value={groupId:"",systemPrompt:"",presetId:""},D.value=!0}function oe(a){v.value=!0,f.value={...a},D.value=!0}async function de(){if(!f.value.groupId){d.warning("请输入群组ID");return}try{await I.put(`/api/scope/group/${f.value.groupId}`,{systemPrompt:f.value.systemPrompt,presetId:f.value.presetId},{headers:y()}),d.success("保存成功"),D.value=!1,P()}catch(a){d.error("保存失败: "+a.message)}}async function ie(a){try{await I.delete(`/api/scope/group/${a}`,{headers:y()}),d.success("删除成功"),P()}catch(e){d.error("删除失败: "+e.message)}}function ne(){v.value=!1,i.value={groupId:"",userId:"",systemPrompt:"",presetId:""},x.value=!0}function pe(a){v.value=!0,i.value={...a},x.value=!0}async function ve(){if(!i.value.groupId||!i.value.userId){d.warning("请输入群组ID和用户ID");return}try{await I.put(`/api/scope/group/${i.value.groupId}/user/${i.value.userId}`,{systemPrompt:i.value.systemPrompt,presetId:i.value.presetId},{headers:y()}),d.success("保存成功"),x.value=!1,P()}catch(a){d.error("保存失败: "+a.message)}}async function me(a,e){try{await I.delete(`/api/scope/group/${a}/user/${e}`,{headers:y()}),d.success("删除成功"),P()}catch(s){d.error("删除失败: "+s.message)}}return Ie(()=>{P()}),(a,e)=>($(),T("div",null,[l(t(W),{title:"人格优先级配置",style:{"margin-bottom":"16px"}},{"header-extra":r(()=>[l(t(u),{type:"primary",size:"small",onClick:Z,loading:B.value},{default:r(()=>[...e[17]||(e[17]=[o(" 保存配置 ",-1)])]),_:1},8,["loading"])]),default:r(()=>[l(t(be),{type:"info",style:{"margin-bottom":"16px"}},{default:r(()=>[e[18]||(e[18]=o(" 当多个作用域都设置了人格时，按以下优先级选择第一个有效的人格。",-1)),e[19]||(e[19]=M("br",null,null,-1)),e[20]||(e[20]=o(" 当前优先级: ",-1)),M("strong",null,S(Y.value),1)]),_:1}),l(t(p),{vertical:""},{default:r(()=>[l(t(k),{label:"启用独立人格"},{default:r(()=>[l(t(ce),{value:c.value.useIndependent,"onUpdate:value":e[0]||(e[0]=s=>c.value.useIndependent=s)},null,8,["value"]),e[21]||(e[21]=M("span",{style:{"margin-left":"12px",color:"#888"}},"开启后，找到的人格将完全替换默认预设，而不是拼接",-1))]),_:1}),l(t(we),{"title-placement":"left"},{default:r(()=>[...e[22]||(e[22]=[o("优先级顺序（从高到低）",-1)])]),_:1}),M("div",Ue,[($(!0),T(ke,null,Pe(c.value.priority,(s,g)=>($(),T("div",{key:s,class:"priority-item"},[M("span",Ne,S(g+1),1),l(t(X),{type:s==="default"?"default":"info",size:"large"},{default:r(()=>[o(S(F.find(w=>w.value===s)?.label||s),1)]),_:2},1032,["type"]),l(t(p),null,{default:r(()=>[l(t(u),{size:"small",disabled:g===0,onClick:w=>K(g,-1)},{default:r(()=>[...e[23]||(e[23]=[o("↑",-1)])]),_:1},8,["disabled","onClick"]),l(t(u),{size:"small",disabled:g===c.value.priority.length-1,onClick:w=>K(g,1)},{default:r(()=>[...e[24]||(e[24]=[o("↓",-1)])]),_:1},8,["disabled","onClick"])]),_:2},1024),M("span",De,S(F.find(w=>w.value===s)?.description),1)]))),128))])]),_:1})]),_:1}),l(t(W),{title:"人格设定管理"},{"header-extra":r(()=>[l(t(X),{type:"success"},{default:r(()=>[o("共 "+S(z.value.length+G.value.length+h.value.length)+" 条人格设定",1)]),_:1})]),default:r(()=>[l(t(Ce),{type:"line",animated:""},{default:r(()=>[l(t(O),{name:"user",tab:"用户人格"},{default:r(()=>[l(t(p),{vertical:""},{default:r(()=>[l(t(p),null,{default:r(()=>[l(t(u),{type:"primary",onClick:le},{default:r(()=>[...e[25]||(e[25]=[o("添加用户人格",-1)])]),_:1}),l(t(u),{onClick:P},{default:r(()=>[...e[26]||(e[26]=[o("刷新",-1)])]),_:1})]),_:1}),l(t(E),{columns:J,data:z.value,loading:C.value,bordered:!1},null,8,["data","loading"]),z.value.length===0&&!C.value?($(),V(t(q),{key:0,description:"暂无用户人格设定"})):j("",!0)]),_:1})]),_:1}),l(t(O),{name:"group",tab:"群组人格"},{default:r(()=>[l(t(p),{vertical:""},{default:r(()=>[l(t(p),null,{default:r(()=>[l(t(u),{type:"primary",onClick:ue},{default:r(()=>[...e[27]||(e[27]=[o("添加群组人格",-1)])]),_:1}),l(t(u),{onClick:P},{default:r(()=>[...e[28]||(e[28]=[o("刷新",-1)])]),_:1})]),_:1}),l(t(E),{columns:ee,data:G.value,loading:C.value,bordered:!1},null,8,["data","loading"]),G.value.length===0&&!C.value?($(),V(t(q),{key:0,description:"暂无群组人格设定"})):j("",!0)]),_:1})]),_:1}),l(t(O),{name:"groupUser",tab:"群内用户人格"},{default:r(()=>[l(t(p),{vertical:""},{default:r(()=>[l(t(p),null,{default:r(()=>[l(t(u),{type:"primary",onClick:ne},{default:r(()=>[...e[29]||(e[29]=[o("添加群内用户人格",-1)])]),_:1}),l(t(u),{onClick:P},{default:r(()=>[...e[30]||(e[30]=[o("刷新",-1)])]),_:1})]),_:1}),l(t(E),{columns:te,data:h.value,loading:C.value,bordered:!1},null,8,["data","loading"]),h.value.length===0&&!C.value?($(),V(t(q),{key:0,description:"暂无群内用户人格设定"})):j("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),l(t(Q),{show:N.value,"onUpdate:show":e[5]||(e[5]=s=>N.value=s),preset:"card",title:v.value?"编辑用户人格":"添加用户人格",style:{width:"600px"}},{footer:r(()=>[l(t(p),{justify:"end"},{default:r(()=>[l(t(u),{onClick:e[4]||(e[4]=s=>N.value=!1)},{default:r(()=>[...e[31]||(e[31]=[o("取消",-1)])]),_:1}),l(t(u),{type:"primary",onClick:re},{default:r(()=>[...e[32]||(e[32]=[o("保存",-1)])]),_:1})]),_:1})]),default:r(()=>[l(t(L),{model:m.value,"label-placement":"left","label-width":"100px"},{default:r(()=>[l(t(k),{label:"用户ID",required:""},{default:r(()=>[l(t(U),{value:m.value.userId,"onUpdate:value":e[1]||(e[1]=s=>m.value.userId=s),placeholder:"QQ号",disabled:v.value},null,8,["value","disabled"])]),_:1}),l(t(k),{label:"自定义Prompt"},{default:r(()=>[l(t(U),{value:m.value.systemPrompt,"onUpdate:value":e[2]||(e[2]=s=>m.value.systemPrompt=s),type:"textarea",rows:6,placeholder:"为该用户设置专属的系统提示词..."},null,8,["value"])]),_:1}),l(t(k),{label:"使用预设"},{default:r(()=>[l(t(_),{value:m.value.presetId,"onUpdate:value":e[3]||(e[3]=s=>m.value.presetId=s),options:A.value,placeholder:"选择预设（可选）",clearable:""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(t(Q),{show:D.value,"onUpdate:show":e[10]||(e[10]=s=>D.value=s),preset:"card",title:v.value?"编辑群组人格":"添加群组人格",style:{width:"600px"}},{footer:r(()=>[l(t(p),{justify:"end"},{default:r(()=>[l(t(u),{onClick:e[9]||(e[9]=s=>D.value=!1)},{default:r(()=>[...e[33]||(e[33]=[o("取消",-1)])]),_:1}),l(t(u),{type:"primary",onClick:de},{default:r(()=>[...e[34]||(e[34]=[o("保存",-1)])]),_:1})]),_:1})]),default:r(()=>[l(t(L),{model:f.value,"label-placement":"left","label-width":"100px"},{default:r(()=>[l(t(k),{label:"群组ID",required:""},{default:r(()=>[l(t(U),{value:f.value.groupId,"onUpdate:value":e[6]||(e[6]=s=>f.value.groupId=s),placeholder:"群号",disabled:v.value},null,8,["value","disabled"])]),_:1}),l(t(k),{label:"自定义Prompt"},{default:r(()=>[l(t(U),{value:f.value.systemPrompt,"onUpdate:value":e[7]||(e[7]=s=>f.value.systemPrompt=s),type:"textarea",rows:6,placeholder:"为该群组设置专属的系统提示词..."},null,8,["value"])]),_:1}),l(t(k),{label:"使用预设"},{default:r(()=>[l(t(_),{value:f.value.presetId,"onUpdate:value":e[8]||(e[8]=s=>f.value.presetId=s),options:A.value,placeholder:"选择预设（可选）",clearable:""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(t(Q),{show:x.value,"onUpdate:show":e[16]||(e[16]=s=>x.value=s),preset:"card",title:v.value?"编辑群内用户人格":"添加群内用户人格",style:{width:"600px"}},{footer:r(()=>[l(t(p),{justify:"end"},{default:r(()=>[l(t(u),{onClick:e[15]||(e[15]=s=>x.value=!1)},{default:r(()=>[...e[35]||(e[35]=[o("取消",-1)])]),_:1}),l(t(u),{type:"primary",onClick:ve},{default:r(()=>[...e[36]||(e[36]=[o("保存",-1)])]),_:1})]),_:1})]),default:r(()=>[l(t(L),{model:i.value,"label-placement":"left","label-width":"100px"},{default:r(()=>[l(t(k),{label:"群组ID",required:""},{default:r(()=>[l(t(U),{value:i.value.groupId,"onUpdate:value":e[11]||(e[11]=s=>i.value.groupId=s),placeholder:"群号",disabled:v.value},null,8,["value","disabled"])]),_:1}),l(t(k),{label:"用户ID",required:""},{default:r(()=>[l(t(U),{value:i.value.userId,"onUpdate:value":e[12]||(e[12]=s=>i.value.userId=s),placeholder:"QQ号",disabled:v.value},null,8,["value","disabled"])]),_:1}),l(t(k),{label:"自定义Prompt"},{default:r(()=>[l(t(U),{value:i.value.systemPrompt,"onUpdate:value":e[13]||(e[13]=s=>i.value.systemPrompt=s),type:"textarea",rows:6,placeholder:"为该群内的特定用户设置专属的系统提示词..."},null,8,["value"])]),_:1}),l(t(k),{label:"使用预设"},{default:r(()=>[l(t(_),{value:i.value.presetId,"onUpdate:value":e[14]||(e[14]=s=>i.value.presetId=s),options:A.value,placeholder:"选择预设（可选）",clearable:""},null,8,["value","options"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}},Te=fe(xe,[["__scopeId","data-v-6b694627"]]);export{Te as default};
