import{W as ue,r as i,l as ne,X as re,Y as P,Z as u,$ as a,a0 as x,a1 as d,a2 as T,a3 as s,a4 as G,a8 as n,Q as f,a5 as y,a6 as V,a7 as ie,P as b,aa as m,ac as L,h as c,ab as J}from"./index-ZGt1bkd7.js";import{N as de,a as S}from"./Tabs-YeBL90-o.js";import{N as pe}from"./Code-rGRECPFV.js";import{N as q}from"./Select-ByyB7dhL.js";import{N as M}from"./Switch-s-asTNZq.js";import{N as ve}from"./DataTable-Bnkss8nN.js";import{N as I}from"./InputNumber-DmcmrgKm.js";import{N as U}from"./DynamicTags-BH2Oan8A.js";import{N as fe}from"./Popconfirm-Dpi9ZTqP.js";const Ce={__name:"Presets",setup(me){const r=ue(),w=i([]),O=i([]),B=i([]),g=i(!1),N=i(!1),h=i(""),j=i(null),A=i(""),z=i(!1),p=i({defaultId:"default",allowUserSwitch:!0,perUserPreset:!1,perGroupPreset:!1}),$=()=>({name:"",description:"",systemPrompt:"",model:"",temperature:.7,persona:{name:"",personality:"",background:"",speakingStyle:"",traits:[],likes:[],dislikes:[],customFields:{}},context:{maxMessages:20,maxTokens:8e3,includeGroupContext:!1,groupContextLength:10},tools:{enableBuiltinTools:!0,allowedTools:[],disabledTools:[]}}),o=i($()),Q={name:{required:!0,message:"请输入名称",trigger:"blur"}},W=ne(()=>w.value.map(l=>({label:l.name,value:l.id}))),X=[{title:"名称",key:"name",width:120},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"人设",key:"persona",width:100,render(l){return l.persona?.name?c(J,{type:"info",size:"small"},{default:()=>l.persona.name}):"-"}},{title:"模型",key:"model",width:150,ellipsis:{tooltip:!0}},{title:"默认",key:"isDefault",width:60,render(l){return p.value.defaultId===l.id?c(J,{type:"success",size:"small"},{default:()=>"是"}):""}},{title:"操作",key:"actions",width:220,render(l){return c(x,null,{default:()=>[c(f,{size:"small",onClick:()=>H(l)},{default:()=>"编辑"}),c(f,{size:"small",type:"info",onClick:()=>K(l.id)},{default:()=>"预览"}),l.id!==p.value.defaultId?c(f,{size:"small",onClick:()=>_(l.id)},{default:()=>"设为默认"}):null,c(fe,{onPositiveClick:()=>ae(l.id)},{trigger:()=>c(f,{size:"small",type:"error",disabled:l.id==="default"},{default:()=>"删除"}),default:()=>"确定删除该预设吗？"})].filter(Boolean)})}}];async function C(){try{const l=await d.get("/api/preset/list");l.data.code===0&&(w.value=l.data.data)}catch{r.error("获取预设列表失败")}}async function Y(){try{const l=await d.get("/api/channels/list");if(l.data.code===0){O.value=l.data.data;const e=new Set;O.value.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(v=>e.add(v))}),B.value=Array.from(e).map(t=>({label:t,value:t})),B.value.unshift({label:"使用默认模型",value:""})}}catch(l){console.error("Failed to fetch channels",l)}}function Z(){N.value=!1,h.value="",o.value=$(),g.value=!0}function H(l){N.value=!0,h.value=l.id;const e=$();o.value={...e,...l,persona:{...e.persona,...l.persona},context:{...e.context,...l.context},tools:{...e.tools,...l.tools}},g.value=!0}async function K(l){try{const e=await d.get(`/api/preset/${l}/prompt`);e.data.code===0&&(A.value=e.data.data.prompt,z.value=!0)}catch{r.error("获取预览失败")}}async function _(l){try{(await d.put("/api/presets/config",{defaultId:l})).data.code===0&&(p.value.defaultId=l,r.success("已设为默认预设"))}catch{r.error("设置失败")}}async function ee(){try{const l=await d.get("/api/presets/config");l.data.code===0&&(p.value=l.data.data)}catch(l){console.error("Failed to fetch presets config",l)}}async function D(){try{(await d.put("/api/presets/config",p.value)).data.code===0&&r.success("配置已保存")}catch{r.error("保存失败")}}async function ae(l){try{const e=await d.delete(`/api/preset/${l}`);e.data.code===0?(r.success("删除成功"),C()):r.error(e.data.message)}catch{r.error("删除失败")}}function le(){const l=JSON.stringify(w.value,null,2),e=new Blob([l],{type:"application/json"}),t=URL.createObjectURL(e),v=document.createElement("a");v.href=t,v.download=`presets_${new Date().toISOString().slice(0,10)}.json`,v.click(),URL.revokeObjectURL(t),r.success("导出成功")}function te(){const l=document.createElement("input");l.type="file",l.accept=".json",l.onchange=async e=>{const t=e.target.files[0];if(t)try{const v=await t.text(),F=JSON.parse(v);if(!Array.isArray(F)){r.error("无效的预设文件格式");return}let R=0;for(const k of F)try{w.value.find(oe=>oe.id===k.id)?await d.put(`/api/preset/${k.id}`,k):await d.post("/api/preset/",k),R++}catch(E){console.error("导入预设失败:",k.name,E)}r.success(`成功导入 ${R} 个预设`),C()}catch(v){r.error("导入失败: "+v.message)}},l.click()}async function se(){j.value?.validate(async l=>{if(!l)try{let e;N.value?e=await d.put(`/api/preset/${h.value}`,o.value):e=await d.post("/api/preset/",o.value),e.data.code===0?(r.success("保存成功"),g.value=!1,C()):r.error(e.data.message)}catch{r.error("保存失败")}})}return re(()=>{C(),Y(),ee()}),(l,e)=>(T(),P(a(x),{vertical:""},{default:u(()=>[s(a(G),{title:"预设配置",size:"small"},{default:u(()=>[s(a(x),null,{default:u(()=>[s(a(n),{label:"默认预设","label-placement":"left"},{default:u(()=>[s(a(q),{value:p.value.defaultId,"onUpdate:value":[e[0]||(e[0]=t=>p.value.defaultId=t),D],options:W.value,style:{width:"200px"}},null,8,["value","options"])]),_:1}),s(a(n),{label:"允许用户切换","label-placement":"left"},{default:u(()=>[s(a(M),{value:p.value.allowUserSwitch,"onUpdate:value":[e[1]||(e[1]=t=>p.value.allowUserSwitch=t),D]},null,8,["value"])]),_:1})]),_:1})]),_:1}),s(a(G),{title:"预设管理"},{"header-extra":u(()=>[s(a(x),null,{default:u(()=>[s(a(f),{onClick:te},{default:u(()=>[...e[24]||(e[24]=[y("导入",-1)])]),_:1}),s(a(f),{onClick:le},{default:u(()=>[...e[25]||(e[25]=[y("导出",-1)])]),_:1}),s(a(f),{type:"primary",onClick:Z},{default:u(()=>[...e[26]||(e[26]=[y("添加预设",-1)])]),_:1})]),_:1})]),default:u(()=>[s(a(ve),{columns:X,data:w.value,pagination:{pageSize:10}},null,8,["data"])]),_:1}),s(a(V),{show:g.value,"onUpdate:show":e[22]||(e[22]=t=>g.value=t),preset:"card",title:N.value?"编辑预设":"添加预设",style:{width:"800px","max-height":"90vh"},"mask-closable":!1},{footer:u(()=>[s(a(x),{justify:"end"},{default:u(()=>[s(a(f),{onClick:e[21]||(e[21]=t=>g.value=!1)},{default:u(()=>[...e[28]||(e[28]=[y("取消",-1)])]),_:1}),s(a(f),{type:"primary",onClick:se},{default:u(()=>[...e[29]||(e[29]=[y("保存",-1)])]),_:1})]),_:1})]),default:u(()=>[s(a(ie),{ref_key:"formRef",ref:j,model:o.value,rules:Q,"label-placement":"left","label-width":"100"},{default:u(()=>[s(a(de),{type:"line"},{default:u(()=>[s(a(S),{name:"basic",tab:"基础设置"},{default:u(()=>[s(a(n),{label:"名称",path:"name"},{default:u(()=>[s(a(b),{value:o.value.name,"onUpdate:value":e[2]||(e[2]=t=>o.value.name=t),placeholder:"请输入名称"},null,8,["value"])]),_:1}),s(a(n),{label:"描述",path:"description"},{default:u(()=>[s(a(b),{value:o.value.description,"onUpdate:value":e[3]||(e[3]=t=>o.value.description=t),placeholder:"请输入描述"},null,8,["value"])]),_:1}),s(a(n),{label:"系统提示词"},{feedback:u(()=>[y(" 支持变量: "+m(l.user_name)+", "+m(l.user_id)+", "+m(l.group_name)+", "+m(l.group_id)+", "+m(l.bot_name)+", "+m(l.date)+", "+m(l.time)+", "+m(l.weekday),1)]),default:u(()=>[s(a(b),{value:o.value.systemPrompt,"onUpdate:value":e[4]||(e[4]=t=>o.value.systemPrompt=t),type:"textarea",placeholder:"基础系统提示词，人设信息会自动附加",rows:4},null,8,["value"])]),_:1}),s(a(n),{label:"模型"},{default:u(()=>[s(a(q),{value:o.value.model,"onUpdate:value":e[5]||(e[5]=t=>o.value.model=t),options:B.value,placeholder:"留空使用默认模型",filterable:"",tag:"",clearable:""},null,8,["value","options"])]),_:1}),s(a(n),{label:"温度"},{default:u(()=>[s(a(I),{value:o.value.temperature,"onUpdate:value":e[6]||(e[6]=t=>o.value.temperature=t),min:0,max:2,step:.1,style:{width:"150px"}},null,8,["value"])]),_:1})]),_:1}),s(a(S),{name:"persona",tab:"人设配置"},{default:u(()=>[s(a(n),{label:"角色名称"},{default:u(()=>[s(a(b),{value:o.value.persona.name,"onUpdate:value":e[7]||(e[7]=t=>o.value.persona.name=t),placeholder:"AI的名字"},null,8,["value"])]),_:1}),s(a(n),{label:"性格特点"},{default:u(()=>[s(a(b),{value:o.value.persona.personality,"onUpdate:value":e[8]||(e[8]=t=>o.value.persona.personality=t),placeholder:"如：友好、幽默、专业"},null,8,["value"])]),_:1}),s(a(n),{label:"说话风格"},{default:u(()=>[s(a(b),{value:o.value.persona.speakingStyle,"onUpdate:value":e[9]||(e[9]=t=>o.value.persona.speakingStyle=t),placeholder:"如：礼貌、简洁、活泼"},null,8,["value"])]),_:1}),s(a(n),{label:"背景故事"},{default:u(()=>[s(a(b),{value:o.value.persona.background,"onUpdate:value":e[10]||(e[10]=t=>o.value.persona.background=t),type:"textarea",placeholder:"角色的背景故事",rows:3},null,8,["value"])]),_:1}),s(a(n),{label:"性格标签"},{default:u(()=>[s(a(U),{value:o.value.persona.traits,"onUpdate:value":e[11]||(e[11]=t=>o.value.persona.traits=t)},null,8,["value"])]),_:1}),s(a(n),{label:"喜好"},{default:u(()=>[s(a(U),{value:o.value.persona.likes,"onUpdate:value":e[12]||(e[12]=t=>o.value.persona.likes=t)},null,8,["value"])]),_:1}),s(a(n),{label:"厌恶"},{default:u(()=>[s(a(U),{value:o.value.persona.dislikes,"onUpdate:value":e[13]||(e[13]=t=>o.value.persona.dislikes=t)},null,8,["value"])]),_:1})]),_:1}),s(a(S),{name:"context",tab:"上下文配置"},{default:u(()=>[s(a(n),{label:"最大消息数"},{default:u(()=>[s(a(I),{value:o.value.context.maxMessages,"onUpdate:value":e[14]||(e[14]=t=>o.value.context.maxMessages=t),min:1,max:100,style:{width:"150px"}},null,8,["value"])]),_:1}),s(a(n),{label:"最大Token数"},{default:u(()=>[s(a(I),{value:o.value.context.maxTokens,"onUpdate:value":e[15]||(e[15]=t=>o.value.context.maxTokens=t),min:100,max:128e3,step:100,style:{width:"150px"}},null,8,["value"])]),_:1}),s(a(n),{label:"包含群聊上下文"},{default:u(()=>[s(a(M),{value:o.value.context.includeGroupContext,"onUpdate:value":e[16]||(e[16]=t=>o.value.context.includeGroupContext=t)},null,8,["value"])]),_:1}),o.value.context.includeGroupContext?(T(),P(a(n),{key:0,label:"群聊上下文长度"},{default:u(()=>[s(a(I),{value:o.value.context.groupContextLength,"onUpdate:value":e[17]||(e[17]=t=>o.value.context.groupContextLength=t),min:1,max:50,style:{width:"150px"}},null,8,["value"])]),_:1})):L("",!0)]),_:1}),s(a(S),{name:"tools",tab:"工具配置"},{default:u(()=>[s(a(n),{label:"启用内置工具"},{default:u(()=>[s(a(M),{value:o.value.tools.enableBuiltinTools,"onUpdate:value":e[18]||(e[18]=t=>o.value.tools.enableBuiltinTools=t)},null,8,["value"])]),_:1}),o.value.tools.enableBuiltinTools?(T(),P(a(n),{key:0,label:"允许的工具"},{feedback:u(()=>[...e[27]||(e[27]=[y("留空表示允许所有工具",-1)])]),default:u(()=>[s(a(U),{value:o.value.tools.allowedTools,"onUpdate:value":e[19]||(e[19]=t=>o.value.tools.allowedTools=t)},null,8,["value"])]),_:1})):L("",!0),o.value.tools.enableBuiltinTools?(T(),P(a(n),{key:1,label:"禁用的工具"},{default:u(()=>[s(a(U),{value:o.value.tools.disabledTools,"onUpdate:value":e[20]||(e[20]=t=>o.value.tools.disabledTools=t)},null,8,["value"])]),_:1})):L("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(a(V),{show:z.value,"onUpdate:show":e[23]||(e[23]=t=>z.value=t),preset:"card",title:"系统提示词预览",style:{width:"700px"}},{default:u(()=>[s(a(pe),{code:A.value,language:"markdown","word-wrap":""},null,8,["code"])]),_:1},8,["show"])]),_:1}))}};export{Ce as default};
