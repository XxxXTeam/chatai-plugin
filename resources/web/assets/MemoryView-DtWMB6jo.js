import{d as P,a2 as L,S as w,Z as F,K as J,x as f,L as T,M as N,O as l,P as t,Q as g,R as c,T as s,a8 as E,a9 as h,U as k,ai as z,a1 as G,B as m,V as i,ac as y,ad as j,aw as H,W as K,X as Q,Y as _,N as U,h as I}from"./index-DI9sxwHq.js";import{S as W}from"./SearchOutlined-7_ijp3DF.js";import{D as O}from"./DeleteOutlined-BPykx3Ct.js";import{N as X}from"./Select-WRU1rpWn.js";import{N as S}from"./Popconfirm-D8CcXZH3.js";import{N as Y}from"./DataTable-BSSVUSBo.js";import"./prop-NnGblK-3.js";const Z={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},q=P({name:"AddOutlined",render:function(r,o){return w(),L("svg",Z,o[0]||(o[0]=[F("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",fill:"currentColor"},null,-1)]))}}),ne={__name:"MemoryView",setup(B){const r=J(),o=f(""),u=f([]),x=f([]),v=f(!1),p=f(!1),d=f({content:"",metadata:"{}"}),C=f({totalUsers:0,totalMemories:0}),D=[{title:"ID",key:"id",width:80,ellipsis:{tooltip:!0}},{title:"内容",key:"content",ellipsis:{tooltip:!0},render:e=>{const a=typeof e.content=="string"?e.content:JSON.stringify(e.content);return a.length>100?a.substring(0,100)+"...":a}},{title:"相似度",key:"score",width:80,render:e=>e.score?(e.score*100).toFixed(1)+"%":"-"},{title:"时间",key:"timestamp",width:160,render:e=>e.timestamp?new Date(e.timestamp).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:100,render(e){return I(S,{onPositiveClick:()=>$(e.id)},{trigger:()=>I(m,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确定删除此记忆？"})}}];async function M(){try{const e=await c.get("/api/memory/users");e.data.code===0&&(x.value=e.data.data||[],C.value.totalUsers=x.value.length)}catch(e){console.error("获取用户列表失败:",e)}}async function b(){if(!o.value){r.warning("请选择或输入用户ID");return}v.value=!0;try{const e=await c.get(`/api/memory/${o.value}`);e.data.code===0?(u.value=e.data.data||[],C.value.totalMemories=u.value.length):u.value=[]}catch(e){r.error("获取记忆失败: "+(e.response?.data?.message||e.message)),u.value=[]}finally{v.value=!1}}async function V(){if(!d.value.content.trim()){r.warning("请输入记忆内容");return}try{let e={};try{e=JSON.parse(d.value.metadata)}catch{}const a=await c.post("/api/memory",{userId:o.value,content:d.value.content,metadata:e});a.data.code===0?(r.success("添加成功"),p.value=!1,d.value={content:"",metadata:"{}"},b()):r.error("添加失败: "+a.data.message)}catch(e){r.error("添加失败: "+(e.response?.data?.message||e.message))}}async function $(e){try{const a=await c.delete(`/api/memory/${o.value}/${e}`);a.data.code===0?(r.success("删除成功"),b()):r.error("删除失败: "+a.data.message)}catch(a){r.error("删除失败: "+(a.response?.data?.message||a.message))}}async function R(){if(o.value)try{const e=await c.delete(`/api/memory/${o.value}`);e.data.code===0?(r.success("清空成功"),u.value=[]):r.error("清空失败: "+e.data.message)}catch(e){r.error("清空失败: "+(e.response?.data?.message||e.message))}}async function A(){v.value=!0;try{const e=await c.delete("/api/memory/clear-all");if(e.data.code===0){const a=e.data.data?.deletedCount??e.data.deletedCount??0;r.success(`清空成功，共清空 ${a} 个用户的记忆`),u.value=[],await M()}else r.error("清空失败: "+e.data.message)}catch(e){r.error("清空失败: "+(e.response?.data?.message||e.message))}finally{v.value=!1}}return T(()=>{M()}),(e,a)=>(w(),N(t(g),{vertical:"",size:"large"},{default:l(()=>[s(t(E),{cols:3,"x-gap":16},{default:l(()=>[s(t(h),null,{default:l(()=>[s(t(k),{size:"small"},{default:l(()=>[s(t(z),{label:"用户数",value:C.value.totalUsers},null,8,["value"])]),_:1})]),_:1}),s(t(h),null,{default:l(()=>[s(t(k),{size:"small"},{default:l(()=>[s(t(z),{label:"当前用户记忆数",value:u.value.length},null,8,["value"])]),_:1})]),_:1}),s(t(h),null,{default:l(()=>[s(t(k),{size:"small"},{default:l(()=>[s(t(z),{label:"已选用户",value:o.value||"-"},null,8,["value"])]),_:1})]),_:1})]),_:1}),s(t(k),{title:"记忆管理"},{"header-extra":l(()=>[s(t(g),null,{default:l(()=>[s(t(m),{size:"small",onClick:M},{icon:l(()=>[s(t(y),null,{default:l(()=>[s(t(H))]),_:1})]),default:l(()=>[a[6]||(a[6]=i(" 刷新用户 ",-1))]),_:1}),s(t(S),{onPositiveClick:A},{trigger:l(()=>[s(t(m),{size:"small",type:"error"},{icon:l(()=>[s(t(y),null,{default:l(()=>[s(t(O))]),_:1})]),default:l(()=>[a[7]||(a[7]=i(" 清空所有记忆 ",-1))]),_:1})]),default:l(()=>[a[8]||(a[8]=i(" 确定清空所有用户的记忆？此操作不可恢复！ ",-1))]),_:1})]),_:1})]),default:l(()=>[s(t(g),{vertical:"",size:"large"},{default:l(()=>[s(t(g),null,{default:l(()=>[s(t(X),{value:o.value,"onUpdate:value":a[0]||(a[0]=n=>o.value=n),options:x.value.map(n=>({label:n,value:n})),placeholder:"选择用户",filterable:"",tag:"",clearable:"",style:{width:"250px"}},null,8,["value","options"]),s(t(m),{type:"primary",onClick:b,loading:v.value},{icon:l(()=>[s(t(y),null,{default:l(()=>[s(t(W))]),_:1})]),default:l(()=>[a[9]||(a[9]=i(" 查询记忆 ",-1))]),_:1},8,["loading"]),s(t(m),{onClick:a[1]||(a[1]=n=>p.value=!0),disabled:!o.value},{icon:l(()=>[s(t(y),null,{default:l(()=>[s(t(q))]),_:1})]),default:l(()=>[a[10]||(a[10]=i(" 添加记忆 ",-1))]),_:1},8,["disabled"]),u.value.length>0?(w(),N(t(S),{key:0,onPositiveClick:R},{trigger:l(()=>[s(t(m),{type:"error"},{icon:l(()=>[s(t(y),null,{default:l(()=>[s(t(O))]),_:1})]),default:l(()=>[a[11]||(a[11]=i(" 清空记忆 ",-1))]),_:1})]),default:l(()=>[a[12]||(a[12]=i(" 确定清空该用户的所有记忆？ ",-1))]),_:1})):G("",!0)]),_:1}),o.value?(w(),N(t(Y),{key:1,columns:D,data:u.value,loading:v.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])):(w(),N(t(j),{key:0,description:"请选择或输入用户ID查询记忆"}))]),_:1})]),_:1}),s(t(K),{show:p.value,"onUpdate:show":a[5]||(a[5]=n=>p.value=n),preset:"card",title:"添加记忆",style:{width:"500px"}},{footer:l(()=>[s(t(g),{justify:"end"},{default:l(()=>[s(t(m),{onClick:a[4]||(a[4]=n=>p.value=!1)},{default:l(()=>[...a[13]||(a[13]=[i("取消",-1)])]),_:1}),s(t(m),{type:"primary",onClick:V},{default:l(()=>[...a[14]||(a[14]=[i("添加",-1)])]),_:1})]),_:1})]),default:l(()=>[s(t(Q),{"label-placement":"top"},{default:l(()=>[s(t(_),{label:"记忆内容"},{default:l(()=>[s(t(U),{value:d.value.content,"onUpdate:value":a[2]||(a[2]=n=>d.value.content=n),type:"textarea",autosize:{minRows:3,maxRows:8},placeholder:"输入要记住的内容..."},null,8,["value"])]),_:1}),s(t(_),{label:"元数据 (可选, JSON格式)"},{default:l(()=>[s(t(U),{value:d.value.metadata,"onUpdate:value":a[3]||(a[3]=n=>d.value.metadata=n),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:'{"type": "fact", "importance": "high"}'},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}};export{ne as default};
