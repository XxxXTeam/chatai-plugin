import{d as $,a2 as A,S as g,Z as L,K as P,w as d,L as F,M as w,O as s,P as e,Q as p,R as c,T as l,at as J,au as M,U as N,av as C,a1 as T,B as m,V as f,aq as k,ar as E,b5 as G,W as j,X as q,Y as _,N as S,h as I}from"./index-YVyRGUFH.js";import{S as H}from"./SearchOutlined-BQ5fCQof.js";import{D as K}from"./DeleteOutlined-SFG0dNgG.js";import{N as Q}from"./Select-BDC-ckzl.js";import{N as O}from"./Popconfirm-wwMzMwGf.js";import{N as W}from"./DataTable-Mo-O5bYy.js";const X={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Y=$({name:"AddOutlined",render:function(o,r){return g(),A("svg",X,r[0]||(r[0]=[L("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",fill:"currentColor"},null,-1)]))}}),re={__name:"MemoryView",setup(U){const o=P(),r=d(""),u=d([]),x=d([]),y=d(!1),v=d(!1),i=d({content:"",metadata:"{}"}),h=d({totalUsers:0,totalMemories:0}),B=[{title:"ID",key:"id",width:80,ellipsis:{tooltip:!0}},{title:"内容",key:"content",ellipsis:{tooltip:!0},render:a=>{const t=typeof a.content=="string"?a.content:JSON.stringify(a.content);return t.length>100?t.substring(0,100)+"...":t}},{title:"相似度",key:"score",width:80,render:a=>a.score?(a.score*100).toFixed(1)+"%":"-"},{title:"时间",key:"timestamp",width:160,render:a=>a.timestamp?new Date(a.timestamp).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:100,render(a){return I(O,{onPositiveClick:()=>V(a.id)},{trigger:()=>I(m,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确定删除此记忆？"})}}];async function z(){try{const a=await c.get("/api/memory/users");a.data.code===0&&(x.value=a.data.data||[],h.value.totalUsers=x.value.length)}catch(a){console.error("获取用户列表失败:",a)}}async function b(){if(!r.value){o.warning("请选择或输入用户ID");return}y.value=!0;try{const a=await c.get(`/api/memory/${r.value}`);a.data.code===0?(u.value=a.data.data||[],h.value.totalMemories=u.value.length):u.value=[]}catch(a){o.error("获取记忆失败: "+(a.response?.data?.message||a.message)),u.value=[]}finally{y.value=!1}}async function D(){if(!i.value.content.trim()){o.warning("请输入记忆内容");return}try{let a={};try{a=JSON.parse(i.value.metadata)}catch{}const t=await c.post("/api/memory",{userId:r.value,content:i.value.content,metadata:a});t.data.code===0?(o.success("添加成功"),v.value=!1,i.value={content:"",metadata:"{}"},b()):o.error("添加失败: "+t.data.message)}catch(a){o.error("添加失败: "+(a.response?.data?.message||a.message))}}async function V(a){try{const t=await c.delete(`/api/memory/${r.value}/${a}`);t.data.code===0?(o.success("删除成功"),b()):o.error("删除失败: "+t.data.message)}catch(t){o.error("删除失败: "+(t.response?.data?.message||t.message))}}async function R(){if(r.value)try{const a=await c.delete(`/api/memory/${r.value}`);a.data.code===0?(o.success("清空成功"),u.value=[]):o.error("清空失败: "+a.data.message)}catch(a){o.error("清空失败: "+(a.response?.data?.message||a.message))}}return F(()=>{z()}),(a,t)=>(g(),w(e(p),{vertical:"",size:"large"},{default:s(()=>[l(e(J),{cols:3,"x-gap":16},{default:s(()=>[l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"用户数",value:h.value.totalUsers},null,8,["value"])]),_:1})]),_:1}),l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"当前用户记忆数",value:u.value.length},null,8,["value"])]),_:1})]),_:1}),l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"已选用户",value:r.value||"-"},null,8,["value"])]),_:1})]),_:1})]),_:1}),l(e(N),{title:"记忆管理"},{"header-extra":s(()=>[l(e(p),null,{default:s(()=>[l(e(m),{size:"small",onClick:z},{icon:s(()=>[l(e(k),null,{default:s(()=>[l(e(G))]),_:1})]),default:s(()=>[t[6]||(t[6]=f(" 刷新用户 ",-1))]),_:1})]),_:1})]),default:s(()=>[l(e(p),{vertical:"",size:"large"},{default:s(()=>[l(e(p),null,{default:s(()=>[l(e(Q),{value:r.value,"onUpdate:value":t[0]||(t[0]=n=>r.value=n),options:x.value.map(n=>({label:n,value:n})),placeholder:"选择用户",filterable:"",tag:"",clearable:"",style:{width:"250px"}},null,8,["value","options"]),l(e(m),{type:"primary",onClick:b,loading:y.value},{icon:s(()=>[l(e(k),null,{default:s(()=>[l(e(H))]),_:1})]),default:s(()=>[t[7]||(t[7]=f(" 查询记忆 ",-1))]),_:1},8,["loading"]),l(e(m),{onClick:t[1]||(t[1]=n=>v.value=!0),disabled:!r.value},{icon:s(()=>[l(e(k),null,{default:s(()=>[l(e(Y))]),_:1})]),default:s(()=>[t[8]||(t[8]=f(" 添加记忆 ",-1))]),_:1},8,["disabled"]),u.value.length>0?(g(),w(e(O),{key:0,onPositiveClick:R},{trigger:s(()=>[l(e(m),{type:"error"},{icon:s(()=>[l(e(k),null,{default:s(()=>[l(e(K))]),_:1})]),default:s(()=>[t[9]||(t[9]=f(" 清空记忆 ",-1))]),_:1})]),default:s(()=>[t[10]||(t[10]=f(" 确定清空该用户的所有记忆？ ",-1))]),_:1})):T("",!0)]),_:1}),r.value?(g(),w(e(W),{key:1,columns:B,data:u.value,loading:y.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])):(g(),w(e(E),{key:0,description:"请选择或输入用户ID查询记忆"}))]),_:1})]),_:1}),l(e(j),{show:v.value,"onUpdate:show":t[5]||(t[5]=n=>v.value=n),preset:"card",title:"添加记忆",style:{width:"500px"}},{footer:s(()=>[l(e(p),{justify:"end"},{default:s(()=>[l(e(m),{onClick:t[4]||(t[4]=n=>v.value=!1)},{default:s(()=>[...t[11]||(t[11]=[f("取消",-1)])]),_:1}),l(e(m),{type:"primary",onClick:D},{default:s(()=>[...t[12]||(t[12]=[f("添加",-1)])]),_:1})]),_:1})]),default:s(()=>[l(e(q),{"label-placement":"top"},{default:s(()=>[l(e(_),{label:"记忆内容"},{default:s(()=>[l(e(S),{value:i.value.content,"onUpdate:value":t[2]||(t[2]=n=>i.value.content=n),type:"textarea",autosize:{minRows:3,maxRows:8},placeholder:"输入要记住的内容..."},null,8,["value"])]),_:1}),l(e(_),{label:"元数据 (可选, JSON格式)"},{default:s(()=>[l(e(S),{value:i.value.metadata,"onUpdate:value":t[3]||(t[3]=n=>i.value.metadata=n),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:'{"type": "fact", "importance": "high"}'},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}};export{re as default};
