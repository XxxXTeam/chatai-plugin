import{W as K,r as d,l as _,X as ee,Y as x,Z as u,$ as a,a0 as g,a1 as p,a2 as w,a3 as l,a4 as $,a8 as n,Q as f,a5 as k,a6 as A,a7 as ae,P as m,ac as h,h as v,ab as D}from"./index-D5XyPjkW.js";import{N as le,a as U,b as te}from"./Tabs-D2GneCkY.js";import{N as E}from"./Select-B7Umczl8.js";import{N as z}from"./Switch-BxYuU8DT.js";import{N as se}from"./DataTable-jF2dDf85.js";import{N}from"./InputNumber-DP7c8im9.js";import{N as y,a as oe}from"./Popconfirm-D4RpYPhb.js";import"./Empty-B-I6UuOT.js";const ce={__name:"Presets",setup(ue){const r=K(),C=d([]),M=d([]),T=d([]),c=d(!1),b=d(!1),P=d(""),F=d(null),G=d(""),I=d(!1),i=d({defaultId:"default",allowUserSwitch:!0,perUserPreset:!1,perGroupPreset:!1}),S=()=>({name:"",description:"",systemPrompt:"",model:"",temperature:.7,persona:{name:"",personality:"",background:"",speakingStyle:"",traits:[],likes:[],dislikes:[],customFields:{}},context:{maxMessages:20,maxTokens:8e3,includeGroupContext:!1,groupContextLength:10},tools:{enableBuiltinTools:!0,allowedTools:[],disabledTools:[]}}),s=d(S()),L={name:{required:!0,message:"请输入名称",trigger:"blur"}},O=_(()=>C.value.map(o=>({label:o.name,value:o.id}))),R=[{title:"名称",key:"name",width:120},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"人设",key:"persona",width:100,render(o){return o.persona?.name?v(D,{type:"info",size:"small"},{default:()=>o.persona.name}):"-"}},{title:"模型",key:"model",width:150,ellipsis:{tooltip:!0}},{title:"默认",key:"isDefault",width:60,render(o){return i.value.defaultId===o.id?v(D,{type:"success",size:"small"},{default:()=>"是"}):""}},{title:"操作",key:"actions",width:220,render(o){return v(g,null,{default:()=>[v(f,{size:"small",onClick:()=>Q(o)},{default:()=>"编辑"}),v(f,{size:"small",type:"info",onClick:()=>W(o.id)},{default:()=>"预览"}),o.id!==i.value.defaultId?v(f,{size:"small",onClick:()=>X(o.id)},{default:()=>"设为默认"}):null,v(oe,{onPositiveClick:()=>Z(o.id)},{trigger:()=>v(f,{size:"small",type:"error",disabled:o.id==="default"},{default:()=>"删除"}),default:()=>"确定删除该预设吗？"})].filter(Boolean)})}}];async function B(){try{const o=await p.get("/api/preset/list");o.data.code===0&&(C.value=o.data.data)}catch{r.error("获取预设列表失败")}}async function j(){try{const o=await p.get("/api/channels/list");if(o.data.code===0){M.value=o.data.data;const e=new Set;M.value.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(J=>e.add(J))}),T.value=Array.from(e).map(t=>({label:t,value:t})),T.value.unshift({label:"使用默认模型",value:""})}}catch(o){console.error("Failed to fetch channels",o)}}function q(){b.value=!1,P.value="",s.value=S(),c.value=!0}function Q(o){b.value=!0,P.value=o.id;const e=S();s.value={...e,...o,persona:{...e.persona,...o.persona},context:{...e.context,...o.context},tools:{...e.tools,...o.tools}},c.value=!0}async function W(o){try{const e=await p.get(`/api/preset/${o}/prompt`);e.data.code===0&&(G.value=e.data.data.prompt,I.value=!0)}catch{r.error("获取预览失败")}}async function X(o){try{(await p.put("/api/presets/config",{defaultId:o})).data.code===0&&(i.value.defaultId=o,r.success("已设为默认预设"))}catch{r.error("设置失败")}}async function Y(){try{const o=await p.get("/api/presets/config");o.data.code===0&&(i.value=o.data.data)}catch(o){console.error("Failed to fetch presets config",o)}}async function V(){try{(await p.put("/api/presets/config",i.value)).data.code===0&&r.success("配置已保存")}catch{r.error("保存失败")}}async function Z(o){try{const e=await p.delete(`/api/preset/${o}`);e.data.code===0?(r.success("删除成功"),B()):r.error(e.data.message)}catch{r.error("删除失败")}}async function H(){F.value?.validate(async o=>{if(!o)try{let e;b.value?e=await p.put(`/api/preset/${P.value}`,s.value):e=await p.post("/api/preset/",s.value),e.data.code===0?(r.success("保存成功"),c.value=!1,B()):r.error(e.data.message)}catch{r.error("保存失败")}})}return ee(()=>{B(),j(),Y()}),(o,e)=>(w(),x(a(g),{vertical:""},{default:u(()=>[l(a($),{title:"预设配置",size:"small"},{default:u(()=>[l(a(g),null,{default:u(()=>[l(a(n),{label:"默认预设","label-placement":"left"},{default:u(()=>[l(a(E),{value:i.value.defaultId,"onUpdate:value":[e[0]||(e[0]=t=>i.value.defaultId=t),V],options:O.value,style:{width:"200px"}},null,8,["value","options"])]),_:1}),l(a(n),{label:"允许用户切换","label-placement":"left"},{default:u(()=>[l(a(z),{value:i.value.allowUserSwitch,"onUpdate:value":[e[1]||(e[1]=t=>i.value.allowUserSwitch=t),V]},null,8,["value"])]),_:1})]),_:1})]),_:1}),l(a($),{title:"预设管理"},{"header-extra":u(()=>[l(a(f),{type:"primary",onClick:q},{default:u(()=>[...e[24]||(e[24]=[k("添加预设",-1)])]),_:1})]),default:u(()=>[l(a(se),{columns:R,data:C.value,pagination:{pageSize:10}},null,8,["data"])]),_:1}),l(a(A),{show:c.value,"onUpdate:show":e[22]||(e[22]=t=>c.value=t),preset:"card",title:b.value?"编辑预设":"添加预设",style:{width:"800px","max-height":"90vh"},"mask-closable":!1},{footer:u(()=>[l(a(g),{justify:"end"},{default:u(()=>[l(a(f),{onClick:e[21]||(e[21]=t=>c.value=!1)},{default:u(()=>[...e[26]||(e[26]=[k("取消",-1)])]),_:1}),l(a(f),{type:"primary",onClick:H},{default:u(()=>[...e[27]||(e[27]=[k("保存",-1)])]),_:1})]),_:1})]),default:u(()=>[l(a(ae),{ref_key:"formRef",ref:F,model:s.value,rules:L,"label-placement":"left","label-width":"100"},{default:u(()=>[l(a(le),{type:"line"},{default:u(()=>[l(a(U),{name:"basic",tab:"基础设置"},{default:u(()=>[l(a(n),{label:"名称",path:"name"},{default:u(()=>[l(a(m),{value:s.value.name,"onUpdate:value":e[2]||(e[2]=t=>s.value.name=t),placeholder:"请输入名称"},null,8,["value"])]),_:1}),l(a(n),{label:"描述",path:"description"},{default:u(()=>[l(a(m),{value:s.value.description,"onUpdate:value":e[3]||(e[3]=t=>s.value.description=t),placeholder:"请输入描述"},null,8,["value"])]),_:1}),l(a(n),{label:"系统提示词"},{default:u(()=>[l(a(m),{value:s.value.systemPrompt,"onUpdate:value":e[4]||(e[4]=t=>s.value.systemPrompt=t),type:"textarea",placeholder:"基础系统提示词，人设信息会自动附加",rows:4},null,8,["value"])]),_:1}),l(a(n),{label:"模型"},{default:u(()=>[l(a(E),{value:s.value.model,"onUpdate:value":e[5]||(e[5]=t=>s.value.model=t),options:T.value,placeholder:"留空使用默认模型",filterable:"",tag:"",clearable:""},null,8,["value","options"])]),_:1}),l(a(n),{label:"温度"},{default:u(()=>[l(a(N),{value:s.value.temperature,"onUpdate:value":e[6]||(e[6]=t=>s.value.temperature=t),min:0,max:2,step:.1,style:{width:"150px"}},null,8,["value"])]),_:1})]),_:1}),l(a(U),{name:"persona",tab:"人设配置"},{default:u(()=>[l(a(n),{label:"角色名称"},{default:u(()=>[l(a(m),{value:s.value.persona.name,"onUpdate:value":e[7]||(e[7]=t=>s.value.persona.name=t),placeholder:"AI的名字"},null,8,["value"])]),_:1}),l(a(n),{label:"性格特点"},{default:u(()=>[l(a(m),{value:s.value.persona.personality,"onUpdate:value":e[8]||(e[8]=t=>s.value.persona.personality=t),placeholder:"如：友好、幽默、专业"},null,8,["value"])]),_:1}),l(a(n),{label:"说话风格"},{default:u(()=>[l(a(m),{value:s.value.persona.speakingStyle,"onUpdate:value":e[9]||(e[9]=t=>s.value.persona.speakingStyle=t),placeholder:"如：礼貌、简洁、活泼"},null,8,["value"])]),_:1}),l(a(n),{label:"背景故事"},{default:u(()=>[l(a(m),{value:s.value.persona.background,"onUpdate:value":e[10]||(e[10]=t=>s.value.persona.background=t),type:"textarea",placeholder:"角色的背景故事",rows:3},null,8,["value"])]),_:1}),l(a(n),{label:"性格标签"},{default:u(()=>[l(a(y),{value:s.value.persona.traits,"onUpdate:value":e[11]||(e[11]=t=>s.value.persona.traits=t)},null,8,["value"])]),_:1}),l(a(n),{label:"喜好"},{default:u(()=>[l(a(y),{value:s.value.persona.likes,"onUpdate:value":e[12]||(e[12]=t=>s.value.persona.likes=t)},null,8,["value"])]),_:1}),l(a(n),{label:"厌恶"},{default:u(()=>[l(a(y),{value:s.value.persona.dislikes,"onUpdate:value":e[13]||(e[13]=t=>s.value.persona.dislikes=t)},null,8,["value"])]),_:1})]),_:1}),l(a(U),{name:"context",tab:"上下文配置"},{default:u(()=>[l(a(n),{label:"最大消息数"},{default:u(()=>[l(a(N),{value:s.value.context.maxMessages,"onUpdate:value":e[14]||(e[14]=t=>s.value.context.maxMessages=t),min:1,max:100,style:{width:"150px"}},null,8,["value"])]),_:1}),l(a(n),{label:"最大Token数"},{default:u(()=>[l(a(N),{value:s.value.context.maxTokens,"onUpdate:value":e[15]||(e[15]=t=>s.value.context.maxTokens=t),min:100,max:128e3,step:100,style:{width:"150px"}},null,8,["value"])]),_:1}),l(a(n),{label:"包含群聊上下文"},{default:u(()=>[l(a(z),{value:s.value.context.includeGroupContext,"onUpdate:value":e[16]||(e[16]=t=>s.value.context.includeGroupContext=t)},null,8,["value"])]),_:1}),s.value.context.includeGroupContext?(w(),x(a(n),{key:0,label:"群聊上下文长度"},{default:u(()=>[l(a(N),{value:s.value.context.groupContextLength,"onUpdate:value":e[17]||(e[17]=t=>s.value.context.groupContextLength=t),min:1,max:50,style:{width:"150px"}},null,8,["value"])]),_:1})):h("",!0)]),_:1}),l(a(U),{name:"tools",tab:"工具配置"},{default:u(()=>[l(a(n),{label:"启用内置工具"},{default:u(()=>[l(a(z),{value:s.value.tools.enableBuiltinTools,"onUpdate:value":e[18]||(e[18]=t=>s.value.tools.enableBuiltinTools=t)},null,8,["value"])]),_:1}),s.value.tools.enableBuiltinTools?(w(),x(a(n),{key:0,label:"允许的工具"},{feedback:u(()=>[...e[25]||(e[25]=[k("留空表示允许所有工具",-1)])]),default:u(()=>[l(a(y),{value:s.value.tools.allowedTools,"onUpdate:value":e[19]||(e[19]=t=>s.value.tools.allowedTools=t)},null,8,["value"])]),_:1})):h("",!0),s.value.tools.enableBuiltinTools?(w(),x(a(n),{key:1,label:"禁用的工具"},{default:u(()=>[l(a(y),{value:s.value.tools.disabledTools,"onUpdate:value":e[20]||(e[20]=t=>s.value.tools.disabledTools=t)},null,8,["value"])]),_:1})):h("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(a(A),{show:I.value,"onUpdate:show":e[23]||(e[23]=t=>I.value=t),preset:"card",title:"系统提示词预览",style:{width:"700px"}},{default:u(()=>[l(a(te),{code:G.value,language:"markdown","word-wrap":""},null,8,["code"])]),_:1},8,["show"])]),_:1}))}};export{ce as default};
