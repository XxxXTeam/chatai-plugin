import{K,x as i,L as A,M as u,O as t,P as a,Q as O,R as B,S as n,T as l,U as k,ad as J,h as S,a1 as f,N as Q,aA as R,ac as D,B as z,V as d,aw as $,W as j,a0 as w,$ as m}from"./index-DI9sxwHq.js";import{C}from"./CodeBlock-CWDRXIco.js";import{S as E}from"./SearchOutlined-7_ijp3DF.js";import{D as P}from"./DeleteOutlined-BPykx3Ct.js";import{N as W}from"./DataTable-BSSVUSBo.js";import{N as q}from"./Select-WRU1rpWn.js";import{N as F,a as v}from"./DescriptionsItem-2WHkPpCH.js";import"./prop-NnGblK-3.js";const se={__name:"ToolLogs",setup(G){const _=K(),g=i(!1),c=i([]),y=i(""),h=i(null),x=i(!1),s=i(null),M=[{title:"时间",key:"timestamp",width:160,render:e=>I(e.timestamp)},{title:"工具",key:"toolName",width:180,render:e=>S(w,{type:"info",size:"small"},()=>e.toolName)},{title:"用户",key:"userId",width:120,ellipsis:{tooltip:!0}},{title:"状态",key:"success",width:80,render:e=>S(w,{type:e.success?"success":"error",size:"small"},()=>e.success?"成功":"失败")},{title:"耗时",key:"duration",width:80,render:e=>e.duration?`${e.duration}ms`:"-"},{title:"操作",key:"actions",width:80,render:e=>S(z,{size:"small",onClick:()=>U(e)},()=>"详情")}],T=i([]);async function N(){g.value=!0;try{const e={};h.value&&(e.tool=h.value),y.value&&(e.search=y.value);const o=await B.get("/api/tools/logs",{params:e});if(o.data.code===0){c.value=o.data.data||[];const r=new Set(c.value.map(p=>p.toolName));T.value=Array.from(r).map(p=>({label:p,value:p}))}}catch(e){_.error("获取日志失败: "+e.message)}finally{g.value=!1}}function U(e){s.value=e,x.value=!0}async function V(){try{(await B.delete("/api/tools/logs")).data.code===0&&(_.success("日志已清空"),c.value=[])}catch(e){_.error("清空失败: "+e.message)}}function I(e){return e?new Date(e).toLocaleString("zh-CN"):"-"}function L(e){try{let r=JSON.stringify(e,(p,b)=>b,2);return r=r.replace(/\\\\n/g,`
`).replace(/\\n/g,`
`),r}catch{return String(e)}}return A(()=>{N()}),(e,o)=>(n(),u(a(O),{vertical:"",size:"large"},{default:t(()=>[l(a(k),{title:"工具调用日志"},{"header-extra":t(()=>[l(a(O),null,{default:t(()=>[l(a(q),{value:h.value,"onUpdate:value":[o[0]||(o[0]=r=>h.value=r),N],options:T.value,placeholder:"筛选工具",clearable:"",style:{width:"180px"}},null,8,["value","options"]),l(a(Q),{value:y.value,"onUpdate:value":o[1]||(o[1]=r=>y.value=r),placeholder:"搜索...",clearable:"",style:{width:"150px"},onKeyup:R(N,["enter"])},{prefix:t(()=>[l(a(D),null,{default:t(()=>[l(a(E))]),_:1})]),_:1},8,["value"]),l(a(z),{onClick:N,loading:g.value},{icon:t(()=>[l(a(D),null,{default:t(()=>[l(a($))]),_:1})]),default:t(()=>[o[3]||(o[3]=d(" 刷新 ",-1))]),_:1},8,["loading"]),c.value.length>0?(n(),u(a(z),{key:0,type:"error",onClick:V},{icon:t(()=>[l(a(D),null,{default:t(()=>[l(a(P))]),_:1})]),default:t(()=>[o[4]||(o[4]=d(" 清空 ",-1))]),_:1})):f("",!0)]),_:1})]),default:t(()=>[c.value.length===0?(n(),u(a(J),{key:0,description:"暂无日志记录"})):(n(),u(a(W),{key:1,columns:M,data:c.value,loading:g.value,pagination:{pageSize:50},bordered:!1,striped:"","max-height":"60vh"},null,8,["data","loading"]))]),_:1}),l(a(j),{show:x.value,"onUpdate:show":o[2]||(o[2]=r=>x.value=r),preset:"card",title:"调用详情",style:{width:"700px"}},{default:t(()=>[s.value?(n(),u(a(F),{key:0,column:2,"label-placement":"left",bordered:""},{default:t(()=>[l(a(v),{label:"工具名称"},{default:t(()=>[l(a(w),{type:"info"},{default:t(()=>[d(m(s.value.toolName),1)]),_:1})]),_:1}),l(a(v),{label:"状态"},{default:t(()=>[l(a(w),{type:s.value.success?"success":"error"},{default:t(()=>[d(m(s.value.success?"成功":"失败"),1)]),_:1},8,["type"])]),_:1}),l(a(v),{label:"用户ID"},{default:t(()=>[d(m(s.value.userId||"-"),1)]),_:1}),l(a(v),{label:"耗时"},{default:t(()=>[d(m(s.value.duration?s.value.duration+"ms":"-"),1)]),_:1}),l(a(v),{label:"时间",span:2},{default:t(()=>[d(m(I(s.value.timestamp)),1)]),_:1})]),_:1})):f("",!0),s.value?.arguments?(n(),u(a(k),{key:1,title:"请求参数",size:"small",style:{"margin-top":"16px"}},{default:t(()=>[l(C,{code:L(s.value.arguments),language:"json"},null,8,["code"])]),_:1})):f("",!0),s.value?.result?(n(),u(a(k),{key:2,title:"返回结果",size:"small",style:{"margin-top":"16px"}},{default:t(()=>[l(C,{code:L(s.value.result),language:"json","max-height":"300px"},null,8,["code"])]),_:1})):f("",!0),s.value?.error?(n(),u(a(k),{key:3,title:"错误信息",size:"small",style:{"margin-top":"16px"}},{default:t(()=>[l(C,{code:s.value.error,language:"text"},null,8,["code"])]),_:1})):f("",!0)]),_:1},8,["show"])]),_:1}))}};export{se as default};
