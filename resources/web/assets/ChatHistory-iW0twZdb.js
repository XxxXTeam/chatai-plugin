import{_ as V,K as E,w as i,A as P,L as q,M as p,O as s,P as a,Q as v,R as y,S as l,T as o,U as H,N as Q,aq as S,B as h,V as $,b5 as F,W as J,Z as k,ar as K,b6 as W,a2 as Z,a3 as G,a4 as X,b7 as Y,b8 as ee,$ as b,a0 as te,h as c}from"./index-CxA8u68m.js";import{S as ae}from"./SearchOutlined-BOPQJuYO.js";import{N as se}from"./DataTable-CjOr2VNt.js";import{N as oe}from"./Popconfirm-CrdXlLnF.js";import"./Select-BFvf1tQg.js";const ne={style:{"max-height":"60vh","overflow-y":"auto"}},re={style:{color:"#999","font-size":"12px"}},ie={style:{"white-space":"pre-wrap","word-break":"break-word","max-height":"200px","overflow-y":"auto"}},le={__name:"ChatHistory",setup(ce){const r=E(),d=i(!1),m=i([]),u=i(""),L=i(null),g=i(!1),w=i([]),B=[{title:"ä¼šè¯ID",key:"id",width:200,ellipsis:{tooltip:!0},render:e=>e.id?.substring(0,16)+"..."},{title:"ç”¨æˆ·",key:"userId",width:150,ellipsis:{tooltip:!0}},{title:"æ¶ˆæ¯æ•°",key:"messageCount",width:80,align:"center"},{title:"æœ€åŽæ´»åŠ¨",key:"lastActivity",width:160,render:e=>x(e.lastActivity)},{title:"æ“ä½œ",key:"actions",width:200,render:e=>c(v,{size:"small"},()=>[c(h,{size:"small",onClick:()=>M(e)},()=>"æŸ¥çœ‹"),c(h,{size:"small",type:"info",onClick:()=>U(e)},()=>"å¯¼å‡º"),c(oe,{onPositiveClick:()=>O(e.id)},{trigger:()=>c(h,{size:"small",type:"error"},()=>"åˆ é™¤"),default:()=>"ç¡®å®šåˆ é™¤æ­¤ä¼šè¯ï¼Ÿ"})])}],D=P(()=>{if(!u.value)return m.value;const e=u.value.toLowerCase();return m.value.filter(t=>t.id?.toLowerCase().includes(e)||t.userId?.toLowerCase().includes(e))});async function _(){d.value=!0;try{const e=await y.get("/api/conversations/list");e.data.code===0&&(m.value=e.data.data||[])}catch(e){r.error("èŽ·å–ä¼šè¯åˆ—è¡¨å¤±è´¥: "+e.message)}finally{d.value=!1}}async function M(e){L.value=e;try{const t=await y.get(`/api/conversations/${e.id}/messages`);t.data.code===0&&(w.value=t.data.data||[],g.value=!0)}catch(t){r.error("èŽ·å–ä¼šè¯è¯¦æƒ…å¤±è´¥: "+t.message)}}async function O(e){try{const t=await y.delete(`/api/conversations/${e}`);t.data.code===0?(r.success("åˆ é™¤æˆåŠŸ"),_()):r.error("åˆ é™¤å¤±è´¥: "+t.data.message)}catch(t){r.error("åˆ é™¤å¤±è´¥: "+t.message)}}function x(e){return e?new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function I(e){return typeof e.content=="string"?e.content:Array.isArray(e.content)?e.content.filter(t=>t.type==="text").map(t=>t.text).join(`
`):JSON.stringify(e.content)}async function U(e){try{const t=await y.get(`/api/conversations/${e.id}/messages`);if(t.data.code===0){const C=(t.data.data||[]).map(f=>{const T=f.role==="user"?"ðŸ‘¤ ç”¨æˆ·":f.role==="assistant"?"ðŸ¤– åŠ©æ‰‹":"ðŸ“‹ ç³»ç»Ÿ",A=I(f),j=x(f.timestamp);return`${T} [${j}]
${A}
`}).join(`
---

`),R=new Blob([C],{type:"text/plain;charset=utf-8"}),z=URL.createObjectURL(R),N=document.createElement("a");N.href=z,N.download=`conversation_${e.userId}_${new Date().toISOString().slice(0,10)}.txt`,N.click(),URL.revokeObjectURL(z),r.success("å¯¼å‡ºæˆåŠŸ")}}catch(t){r.error("å¯¼å‡ºå¤±è´¥: "+t.message)}}return q(()=>{_()}),(e,t)=>(l(),p(a(v),{vertical:"",size:"large"},{default:s(()=>[o(a(H),{title:"å¯¹è¯åŽ†å²"},{"header-extra":s(()=>[o(a(v),null,{default:s(()=>[o(a(Q),{value:u.value,"onUpdate:value":t[0]||(t[0]=n=>u.value=n),placeholder:"æœç´¢ä¼šè¯IDæˆ–ç”¨æˆ·",clearable:"",style:{width:"200px"}},{prefix:s(()=>[o(a(S),null,{default:s(()=>[o(a(ae))]),_:1})]),_:1},8,["value"]),o(a(h),{onClick:_,loading:d.value},{icon:s(()=>[o(a(S),null,{default:s(()=>[o(a(F))]),_:1})]),default:s(()=>[t[2]||(t[2]=$(" åˆ·æ–° ",-1))]),_:1},8,["loading"])]),_:1})]),default:s(()=>[o(a(se),{columns:B,data:D.value,loading:d.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])]),_:1}),o(a(J),{show:g.value,"onUpdate:show":t[1]||(t[1]=n=>g.value=n),preset:"card",title:`ä¼šè¯è¯¦æƒ… - ${L.value?.userId||""}`,style:{width:"700px","max-height":"80vh"}},{default:s(()=>[k("div",ne,[w.value.length===0?(l(),p(a(K),{key:0,description:"æš‚æ— æ¶ˆæ¯"})):(l(),p(a(W),{key:1},{default:s(()=>[(l(!0),Z(G,null,X(w.value,(n,C)=>(l(),p(a(Y),{key:C},{default:s(()=>[o(a(ee),null,{header:s(()=>[o(a(v),{align:"center",size:8},{default:s(()=>[o(a(te),{type:n.role==="user"?"info":n.role==="assistant"?"success":"warning",size:"small"},{default:s(()=>[$(b(n.role),1)]),_:2},1032,["type"]),k("span",re,b(x(n.timestamp)),1)]),_:2},1024)]),description:s(()=>[k("div",ie,b(I(n)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))])]),_:1},8,["show","title"])]),_:1}))}},ye=V(le,[["__scopeId","data-v-ca483efa"]]);export{ye as default};
