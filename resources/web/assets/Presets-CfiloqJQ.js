import{K as de,x as p,C as pe,L as ve,M as I,O as o,P as l,Q as i,R as v,S as U,T as a,U as R,Y as r,B as m,V as x,W as V,X as me,N as P,$ as f,Z as d,a1 as $,a2 as fe,a3 as ye,a4 as xe,a0 as j,h as c}from"./index-BlGFC_7o.js";import{C as ge}from"./CodeBlock-DMsRnSVe.js";import{N as be,a as M}from"./Tabs-jSlilz08.js";import{N as W}from"./Select-CWjjOVcG.js";import{N as C}from"./Switch-D_pdGs5P.js";import{N as ce}from"./DataTable-D8okgOgI.js";import{N as k}from"./InputNumber-BO-DBVrj.js";import{N as B}from"./DynamicTags-DteiU6QU.js";import{N as ke}from"./Popconfirm-B1BeyeG5.js";import"./Add-Df6mcjB1.js";import"./prop-NnGblK-3.js";const we={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"16px"}},Pe={style:{"font-weight":"600","font-size":"15px"}},Ue={style:{"min-height":"60px"}},Ce={style:{color:"#666","font-size":"13px",margin:"0 0 8px 0"}},Te={style:{color:"#999","font-size":"12px",margin:"0","line-height":"1.4",display:"-webkit-box","-webkit-line-clamp":"2","-webkit-box-orient":"vertical",overflow:"hidden"}},Ve={__name:"Presets",setup(Ne){const u=de(),b=p([]),D=p([]),L=p([]),w=p(!1),T=p(!1),A=p(""),E=p(null),G=p(""),F=p(!1),N=p(!1),g=p({defaultId:"default",allowUserSwitch:!0,perUserPreset:!1,perGroupPreset:!1}),X=[{id:"assistant",name:"通用助手",description:"友好专业的AI助手",systemPrompt:"你是一个有帮助的AI助手，请用简洁清晰的语言回答用户的问题。",persona:{name:"AI助手",personality:"友好、专业、乐于助人",speakingStyle:"礼貌、简洁"}},{id:"catgirl",name:"猫娘",description:"可爱的猫娘角色",systemPrompt:'你是一只可爱的猫娘，说话时会加上"喵~"，性格活泼可爱。',persona:{name:"小喵",personality:"活泼、可爱、傲娇",speakingStyle:"卖萌、撒娇",traits:["猫耳","傲娇","贪吃"]}},{id:"coder",name:"编程助手",description:"专业的编程开发助手",systemPrompt:"你是一个专业的编程助手，擅长多种编程语言和框架。请提供清晰的代码示例和解释。",persona:{name:"代码助手",personality:"严谨、专业、耐心",speakingStyle:"技术性、条理清晰"}},{id:"translator",name:"翻译助手",description:"多语言翻译专家",systemPrompt:"你是一个专业的翻译助手，精通中英日韩等多种语言。请提供准确流畅的翻译。",persona:{name:"翻译官",personality:"专业、细致",speakingStyle:"准确、地道"}},{id:"writer",name:"写作助手",description:"创意写作和文案助手",systemPrompt:"你是一个创意写作助手，擅长各类文体写作，包括小说、诗歌、文案等。",persona:{name:"文思",personality:"富有创意、文采斐然",speakingStyle:"优美、富有感染力"}},{id:"roleplay",name:"角色扮演",description:"沉浸式角色扮演",systemPrompt:"你将扮演用户指定的角色，保持角色一致性，进行沉浸式对话。不要打破角色设定。",persona:{name:"",personality:"根据角色设定",speakingStyle:"符合角色特点"}},{id:"tutor",name:"学习导师",description:"耐心的学习辅导老师",systemPrompt:"你是一个耐心的学习导师，擅长用通俗易懂的方式解释复杂概念，引导学生思考。",persona:{name:"导师",personality:"耐心、博学、善于引导",speakingStyle:"循循善诱、深入浅出"}},{id:"emotional",name:"情感陪伴",description:"温暖的情感支持伙伴",systemPrompt:"你是一个温暖的倾听者和陪伴者，善于理解和安慰他人，提供情感支持。",persona:{name:"暖心",personality:"温柔、善解人意、有同理心",speakingStyle:"温暖、治愈"}}];function Y(s){n.value={...S(),name:s.name,description:s.description,systemPrompt:s.systemPrompt,persona:{...S().persona,...s.persona}},N.value=!1,T.value=!1,A.value="",w.value=!0}const S=()=>({name:"",description:"",systemPrompt:"",model:"",modelParams:{temperature:.7,top_p:.9,max_tokens:4096,presence_penalty:0,frequency_penalty:0},persona:{name:"",personality:"",background:"",speakingStyle:"",traits:[],likes:[],dislikes:[],customFields:{}},context:{maxMessages:20,maxTokens:8e3,isolateContext:!1,includeGroupContext:!1,groupContextLength:10,clearOnSwitch:!1},tools:{enableBuiltinTools:!0,enableMcpTools:!0,allowedTools:[],disabledTools:[]}}),n=p(S()),Z={name:{required:!0,message:"请输入名称",trigger:"blur"}},H=pe(()=>b.value.map(s=>({label:s.name,value:s.id}))),h=[{title:"名称",key:"name",width:120},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"人设",key:"persona",width:100,render(s){return s.persona?.name?c(j,{type:"info",size:"small"},{default:()=>s.persona.name}):"-"}},{title:"模型",key:"model",width:150,ellipsis:{tooltip:!0}},{title:"默认",key:"isDefault",width:60,render(s){return g.value.defaultId===s.id?c(j,{type:"success",size:"small"},{default:()=>"是"}):""}},{title:"操作",key:"actions",width:220,render(s){return c(i,null,{default:()=>[c(m,{size:"small",onClick:()=>le(s)},{default:()=>"编辑"}),c(m,{size:"small",type:"info",onClick:()=>ae(s.id)},{default:()=>"预览"}),s.id!==g.value.defaultId?c(m,{size:"small",onClick:()=>te(s.id)},{default:()=>"设为默认"}):null,c(ke,{onPositiveClick:()=>oe(s.id)},{trigger:()=>c(m,{size:"small",type:"error",disabled:s.id==="default"},{default:()=>"删除"}),default:()=>"确定删除该预设吗？"})].filter(Boolean)})}}];async function O(){try{const s=await v.get("/api/preset/list");s.data.code===0?(b.value=Array.isArray(s.data.data)?s.data.data:[],console.log("[Presets] 加载预设:",b.value.length,"个")):(console.warn("[Presets] API返回错误:",s.data.message),b.value=[])}catch(s){console.error("[Presets] 获取预设列表失败:",s),u.error("获取预设列表失败: "+(s.response?.data?.message||s.message)),b.value=[]}}async function _(){try{const s=await v.get("/api/channels/list");if(s.data.code===0){D.value=s.data.data;const e=new Set;D.value.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(y=>e.add(y))}),L.value=Array.from(e).map(t=>({label:t,value:t})),L.value.unshift({label:"使用默认模型",value:""})}}catch(s){console.error("Failed to fetch channels",s)}}function ee(){T.value=!1,A.value="",n.value=S(),w.value=!0}function le(s){T.value=!0,A.value=s.id;const e=S();n.value={...e,...s,persona:{...e.persona,...s.persona},context:{...e.context,...s.context},tools:{...e.tools,...s.tools}},w.value=!0}async function ae(s){try{const e=await v.get(`/api/preset/${s}/prompt`);e.data.code===0&&(G.value=e.data.data.prompt,F.value=!0)}catch{u.error("获取预览失败")}}async function te(s){try{(await v.put("/api/presets/config",{defaultId:s})).data.code===0&&(g.value.defaultId=s,u.success("已设为默认预设"))}catch{u.error("设置失败")}}async function se(){try{const s=await v.get("/api/presets/config");s.data.code===0&&(g.value=s.data.data)}catch(s){console.error("Failed to fetch presets config",s)}}async function q(){try{(await v.put("/api/presets/config",g.value)).data.code===0&&u.success("配置已保存")}catch{u.error("保存失败")}}async function oe(s){try{const e=await v.delete(`/api/preset/${s}`);e.data.code===0?(u.success("删除成功"),O()):u.error(e.data.message)}catch{u.error("删除失败")}}function ne(){const s=JSON.stringify(b.value,null,2),e=new Blob([s],{type:"application/json"}),t=URL.createObjectURL(e),y=document.createElement("a");y.href=t,y.download=`presets_${new Date().toISOString().slice(0,10)}.json`,y.click(),URL.revokeObjectURL(t),u.success("导出成功")}function re(){const s=document.createElement("input");s.type="file",s.accept=".json",s.onchange=async e=>{const t=e.target.files[0];if(t)try{const y=await t.text(),J=JSON.parse(y);if(!Array.isArray(J)){u.error("无效的预设文件格式");return}let K=0;for(const z of J)try{b.value.find(ie=>ie.id===z.id)?await v.put(`/api/preset/${z.id}`,z):await v.post("/api/preset/",z),K++}catch(Q){console.error("导入预设失败:",z.name,Q)}u.success(`成功导入 ${K} 个预设`),O()}catch(y){u.error("导入失败: "+y.message)}},s.click()}async function ue(){E.value?.validate(async s=>{if(!s)try{let e;T.value?e=await v.put(`/api/preset/${A.value}`,n.value):e=await v.post("/api/preset/",n.value),e.data.code===0?(u.success("保存成功"),w.value=!1,O()):u.error(e.data.message)}catch{u.error("保存失败")}})}return ve(()=>{O(),_(),se()}),(s,e)=>(U(),I(l(i),{vertical:""},{default:o(()=>[a(l(R),{title:"预设配置",size:"small"},{default:o(()=>[a(l(i),null,{default:o(()=>[a(l(r),{label:"默认预设","label-placement":"left"},{default:o(()=>[a(l(W),{value:g.value.defaultId,"onUpdate:value":[e[0]||(e[0]=t=>g.value.defaultId=t),q],options:H.value,style:{width:"200px"}},null,8,["value","options"])]),_:1}),a(l(r),{label:"允许用户切换","label-placement":"left"},{default:o(()=>[a(l(C),{value:g.value.allowUserSwitch,"onUpdate:value":[e[1]||(e[1]=t=>g.value.allowUserSwitch=t),q]},null,8,["value"])]),_:1})]),_:1})]),_:1}),a(l(R),{title:"预设管理"},{"header-extra":o(()=>[a(l(i),null,{default:o(()=>[a(l(m),{onClick:e[2]||(e[2]=t=>N.value=!0)},{default:o(()=>[...e[34]||(e[34]=[x("模板库",-1)])]),_:1}),a(l(m),{onClick:re},{default:o(()=>[...e[35]||(e[35]=[x("导入",-1)])]),_:1}),a(l(m),{onClick:ne},{default:o(()=>[...e[36]||(e[36]=[x("导出",-1)])]),_:1}),a(l(m),{type:"primary",onClick:ee},{default:o(()=>[...e[37]||(e[37]=[x("添加预设",-1)])]),_:1})]),_:1})]),default:o(()=>[a(l(ce),{columns:h,data:b.value,pagination:{pageSize:10}},null,8,["data"])]),_:1}),a(l(V),{show:w.value,"onUpdate:show":e[30]||(e[30]=t=>w.value=t),preset:"card",title:T.value?"编辑预设":"添加预设",style:{width:"800px","max-height":"90vh"},"mask-closable":!1},{footer:o(()=>[a(l(i),{justify:"end"},{default:o(()=>[a(l(m),{onClick:e[29]||(e[29]=t=>w.value=!1)},{default:o(()=>[...e[49]||(e[49]=[x("取消",-1)])]),_:1}),a(l(m),{type:"primary",onClick:ue},{default:o(()=>[...e[50]||(e[50]=[x("保存",-1)])]),_:1})]),_:1})]),default:o(()=>[a(l(me),{ref_key:"formRef",ref:E,model:n.value,rules:Z,"label-placement":"left","label-width":"100"},{default:o(()=>[a(l(be),{type:"line"},{default:o(()=>[a(l(M),{name:"basic",tab:"基础设置"},{default:o(()=>[a(l(r),{label:"名称",path:"name"},{default:o(()=>[a(l(P),{value:n.value.name,"onUpdate:value":e[3]||(e[3]=t=>n.value.name=t),placeholder:"请输入名称"},null,8,["value"])]),_:1}),a(l(r),{label:"描述",path:"description"},{default:o(()=>[a(l(P),{value:n.value.description,"onUpdate:value":e[4]||(e[4]=t=>n.value.description=t),placeholder:"请输入描述"},null,8,["value"])]),_:1}),a(l(r),{label:"系统提示词"},{feedback:o(()=>[x(" 支持变量: "+f(s.user_name)+", "+f(s.user_id)+", "+f(s.group_name)+", "+f(s.group_id)+", "+f(s.bot_name)+", "+f(s.date)+", "+f(s.time)+", "+f(s.weekday),1)]),default:o(()=>[a(l(P),{value:n.value.systemPrompt,"onUpdate:value":e[5]||(e[5]=t=>n.value.systemPrompt=t),type:"textarea",placeholder:"基础系统提示词，人设信息会自动附加",rows:4},null,8,["value"])]),_:1}),a(l(r),{label:"模型"},{default:o(()=>[a(l(W),{value:n.value.model,"onUpdate:value":e[6]||(e[6]=t=>n.value.model=t),options:L.value,placeholder:"留空使用默认模型",filterable:"",tag:"",clearable:""},null,8,["value","options"])]),_:1})]),_:1}),a(l(M),{name:"modelParams",tab:"模型参数"},{default:o(()=>[a(l(r),{label:"温度"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.modelParams.temperature,"onUpdate:value":e[7]||(e[7]=t=>n.value.modelParams.temperature=t),min:0,max:2,step:.1,style:{width:"120px"}},null,8,["value"]),e[38]||(e[38]=d("span",{style:{color:"#999","font-size":"12px"}},"控制输出随机性，越高越有创意",-1))]),_:1})]),_:1}),a(l(r),{label:"Top P"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.modelParams.top_p,"onUpdate:value":e[8]||(e[8]=t=>n.value.modelParams.top_p=t),min:0,max:1,step:.05,style:{width:"120px"}},null,8,["value"]),e[39]||(e[39]=d("span",{style:{color:"#999","font-size":"12px"}},"核采样参数，建议保持默认",-1))]),_:1})]),_:1}),a(l(r),{label:"最大输出"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.modelParams.max_tokens,"onUpdate:value":e[9]||(e[9]=t=>n.value.modelParams.max_tokens=t),min:100,max:128e3,step:100,style:{width:"120px"}},null,8,["value"]),e[40]||(e[40]=d("span",{style:{color:"#999","font-size":"12px"}},"单次回复最大 token 数",-1))]),_:1})]),_:1}),a(l(r),{label:"存在惩罚"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.modelParams.presence_penalty,"onUpdate:value":e[10]||(e[10]=t=>n.value.modelParams.presence_penalty=t),min:-2,max:2,step:.1,style:{width:"120px"}},null,8,["value"]),e[41]||(e[41]=d("span",{style:{color:"#999","font-size":"12px"}},"增加讨论新话题的可能性",-1))]),_:1})]),_:1}),a(l(r),{label:"频率惩罚"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.modelParams.frequency_penalty,"onUpdate:value":e[11]||(e[11]=t=>n.value.modelParams.frequency_penalty=t),min:-2,max:2,step:.1,style:{width:"120px"}},null,8,["value"]),e[42]||(e[42]=d("span",{style:{color:"#999","font-size":"12px"}},"减少重复内容",-1))]),_:1})]),_:1})]),_:1}),a(l(M),{name:"persona",tab:"人设配置"},{default:o(()=>[a(l(r),{label:"角色名称"},{default:o(()=>[a(l(P),{value:n.value.persona.name,"onUpdate:value":e[12]||(e[12]=t=>n.value.persona.name=t),placeholder:"AI的名字"},null,8,["value"])]),_:1}),a(l(r),{label:"性格特点"},{default:o(()=>[a(l(P),{value:n.value.persona.personality,"onUpdate:value":e[13]||(e[13]=t=>n.value.persona.personality=t),placeholder:"如：友好、幽默、专业"},null,8,["value"])]),_:1}),a(l(r),{label:"说话风格"},{default:o(()=>[a(l(P),{value:n.value.persona.speakingStyle,"onUpdate:value":e[14]||(e[14]=t=>n.value.persona.speakingStyle=t),placeholder:"如：礼貌、简洁、活泼"},null,8,["value"])]),_:1}),a(l(r),{label:"背景故事"},{default:o(()=>[a(l(P),{value:n.value.persona.background,"onUpdate:value":e[15]||(e[15]=t=>n.value.persona.background=t),type:"textarea",placeholder:"角色的背景故事",rows:3},null,8,["value"])]),_:1}),a(l(r),{label:"性格标签"},{default:o(()=>[a(l(B),{value:n.value.persona.traits,"onUpdate:value":e[16]||(e[16]=t=>n.value.persona.traits=t)},null,8,["value"])]),_:1}),a(l(r),{label:"喜好"},{default:o(()=>[a(l(B),{value:n.value.persona.likes,"onUpdate:value":e[17]||(e[17]=t=>n.value.persona.likes=t)},null,8,["value"])]),_:1}),a(l(r),{label:"厌恶"},{default:o(()=>[a(l(B),{value:n.value.persona.dislikes,"onUpdate:value":e[18]||(e[18]=t=>n.value.persona.dislikes=t)},null,8,["value"])]),_:1})]),_:1}),a(l(M),{name:"context",tab:"上下文配置"},{default:o(()=>[a(l(r),{label:"最大消息数"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.context.maxMessages,"onUpdate:value":e[19]||(e[19]=t=>n.value.context.maxMessages=t),min:1,max:100,style:{width:"150px"}},null,8,["value"]),e[43]||(e[43]=d("span",{style:{color:"#999","font-size":"12px"}},"保留的历史消息数量",-1))]),_:1})]),_:1}),a(l(r),{label:"最大Token数"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(k),{value:n.value.context.maxTokens,"onUpdate:value":e[20]||(e[20]=t=>n.value.context.maxTokens=t),min:100,max:128e3,step:100,style:{width:"150px"}},null,8,["value"]),e[44]||(e[44]=d("span",{style:{color:"#999","font-size":"12px"}},"上下文总 token 限制",-1))]),_:1})]),_:1}),a(l(r),{label:"独立上下文"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(C),{value:n.value.context.isolateContext,"onUpdate:value":e[21]||(e[21]=t=>n.value.context.isolateContext=t)},null,8,["value"]),e[45]||(e[45]=d("span",{style:{color:"#999","font-size":"12px"}},"此预设使用独立的对话历史",-1))]),_:1})]),_:1}),n.value.context.isolateContext?(U(),I(l(r),{key:0,label:"切换时清除"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(C),{value:n.value.context.clearOnSwitch,"onUpdate:value":e[22]||(e[22]=t=>n.value.context.clearOnSwitch=t)},null,8,["value"]),e[46]||(e[46]=d("span",{style:{color:"#999","font-size":"12px"}},"切换预设时清除原上下文",-1))]),_:1})]),_:1})):$("",!0),a(l(r),{label:"包含群聊上下文"},{default:o(()=>[a(l(C),{value:n.value.context.includeGroupContext,"onUpdate:value":e[23]||(e[23]=t=>n.value.context.includeGroupContext=t)},null,8,["value"])]),_:1}),n.value.context.includeGroupContext?(U(),I(l(r),{key:1,label:"群聊上下文长度"},{default:o(()=>[a(l(k),{value:n.value.context.groupContextLength,"onUpdate:value":e[24]||(e[24]=t=>n.value.context.groupContextLength=t),min:1,max:50,style:{width:"150px"}},null,8,["value"])]),_:1})):$("",!0)]),_:1}),a(l(M),{name:"tools",tab:"工具配置"},{default:o(()=>[a(l(r),{label:"启用内置工具"},{default:o(()=>[a(l(C),{value:n.value.tools.enableBuiltinTools,"onUpdate:value":e[25]||(e[25]=t=>n.value.tools.enableBuiltinTools=t)},null,8,["value"])]),_:1}),a(l(r),{label:"启用MCP工具"},{default:o(()=>[a(l(i),{align:"center"},{default:o(()=>[a(l(C),{value:n.value.tools.enableMcpTools,"onUpdate:value":e[26]||(e[26]=t=>n.value.tools.enableMcpTools=t)},null,8,["value"]),e[47]||(e[47]=d("span",{style:{color:"#999","font-size":"12px"}},"允许使用 MCP 服务器提供的工具",-1))]),_:1})]),_:1}),n.value.tools.enableBuiltinTools||n.value.tools.enableMcpTools?(U(),I(l(r),{key:0,label:"允许的工具"},{feedback:o(()=>[...e[48]||(e[48]=[x("留空表示允许所有工具",-1)])]),default:o(()=>[a(l(B),{value:n.value.tools.allowedTools,"onUpdate:value":e[27]||(e[27]=t=>n.value.tools.allowedTools=t)},null,8,["value"])]),_:1})):$("",!0),n.value.tools.enableBuiltinTools||n.value.tools.enableMcpTools?(U(),I(l(r),{key:1,label:"禁用的工具"},{default:o(()=>[a(l(B),{value:n.value.tools.disabledTools,"onUpdate:value":e[28]||(e[28]=t=>n.value.tools.disabledTools=t)},null,8,["value"])]),_:1})):$("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(l(V),{show:F.value,"onUpdate:show":e[31]||(e[31]=t=>F.value=t),preset:"card",title:"系统提示词预览",style:{width:"700px"}},{default:o(()=>[a(ge,{code:G.value,markdown:!0},null,8,["code"])]),_:1},8,["show"]),a(l(V),{show:N.value,"onUpdate:show":e[33]||(e[33]=t=>N.value=t),preset:"card",title:"预设模板库",style:{width:"750px"}},{footer:o(()=>[a(l(m),{onClick:e[32]||(e[32]=t=>N.value=!1)},{default:o(()=>[...e[52]||(e[52]=[x("关闭",-1)])]),_:1})]),default:o(()=>[d("div",we,[(U(),fe(ye,null,xe(X,t=>a(l(R),{key:t.id,size:"small",hoverable:"",style:{cursor:"pointer"},onClick:y=>Y(t)},{header:o(()=>[d("div",Pe,f(t.name),1)]),"header-extra":o(()=>[a(l(j),{size:"small",type:"info"},{default:o(()=>[...e[51]||(e[51]=[x("点击使用",-1)])]),_:1})]),default:o(()=>[d("div",Ue,[d("p",Ce,f(t.description),1),d("p",Te,f(t.systemPrompt),1)])]),_:2},1032,["onClick"])),64))])]),_:1},8,["show"])]),_:1}))}};export{Ve as default};
