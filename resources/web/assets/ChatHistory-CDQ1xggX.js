import{_ as E,W as P,r as i,l as V,X as H,Y as p,Z as s,$ as a,a0 as v,a1 as y,a2 as l,a3 as o,a4 as Q,P as q,ay as $,Q as h,a5 as S,bc as F,a6 as J,a9 as N,az as W,bd as X,ax as Y,aA as Z,aB as G,be as K,bf as ee,aa as b,ab as te,h as c}from"./index-CI1YICfA.js";import{S as ae}from"./SearchOutlined-Be51wodi.js";import{N as se}from"./DataTable-DYpkcRAA.js";import{N as oe}from"./Popconfirm-BnKriZsM.js";import"./Select-C-tTICXf.js";const ne={style:{"max-height":"60vh","overflow-y":"auto"}},re={style:{color:"#999","font-size":"12px"}},ie={style:{"white-space":"pre-wrap","word-break":"break-word","max-height":"200px","overflow-y":"auto"}},le={__name:"ChatHistory",setup(ce){const r=P(),d=i(!1),m=i([]),u=i(""),z=i(null),g=i(!1),w=i([]),B=[{title:"ä¼šè¯ID",key:"id",width:200,ellipsis:{tooltip:!0},render:e=>e.id?.substring(0,16)+"..."},{title:"ç”¨æˆ·",key:"userId",width:150,ellipsis:{tooltip:!0}},{title:"æ¶ˆæ¯æ•°",key:"messageCount",width:80,align:"center"},{title:"æœ€åŽæ´»åŠ¨",key:"lastActivity",width:160,render:e=>x(e.lastActivity)},{title:"æ“ä½œ",key:"actions",width:200,render:e=>c(v,{size:"small"},()=>[c(h,{size:"small",onClick:()=>M(e)},()=>"æŸ¥çœ‹"),c(h,{size:"small",type:"info",onClick:()=>U(e)},()=>"å¯¼å‡º"),c(oe,{onPositiveClick:()=>O(e.id)},{trigger:()=>c(h,{size:"small",type:"error"},()=>"åˆ é™¤"),default:()=>"ç¡®å®šåˆ é™¤æ­¤ä¼šè¯ï¼Ÿ"})])}],D=V(()=>{if(!u.value)return m.value;const e=u.value.toLowerCase();return m.value.filter(t=>t.id?.toLowerCase().includes(e)||t.userId?.toLowerCase().includes(e))});async function _(){d.value=!0;try{const e=await y.get("/api/conversations/list");e.data.code===0&&(m.value=e.data.data||[])}catch(e){r.error("èŽ·å–ä¼šè¯åˆ—è¡¨å¤±è´¥: "+e.message)}finally{d.value=!1}}async function M(e){z.value=e;try{const t=await y.get(`/api/conversations/${e.id}/messages`);t.data.code===0&&(w.value=t.data.data||[],g.value=!0)}catch(t){r.error("èŽ·å–ä¼šè¯è¯¦æƒ…å¤±è´¥: "+t.message)}}async function O(e){try{const t=await y.delete(`/api/conversations/${e}`);t.data.code===0?(r.success("åˆ é™¤æˆåŠŸ"),_()):r.error("åˆ é™¤å¤±è´¥: "+t.data.message)}catch(t){r.error("åˆ é™¤å¤±è´¥: "+t.message)}}function x(e){return e?new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function I(e){return typeof e.content=="string"?e.content:Array.isArray(e.content)?e.content.filter(t=>t.type==="text").map(t=>t.text).join(`
`):JSON.stringify(e.content)}async function U(e){try{const t=await y.get(`/api/conversations/${e.id}/messages`);if(t.data.code===0){const C=(t.data.data||[]).map(f=>{const R=f.role==="user"?"ðŸ‘¤ ç”¨æˆ·":f.role==="assistant"?"ðŸ¤– åŠ©æ‰‹":"ðŸ“‹ ç³»ç»Ÿ",T=I(f),j=x(f.timestamp);return`${R} [${j}]
${T}
`}).join(`
---

`),A=new Blob([C],{type:"text/plain;charset=utf-8"}),L=URL.createObjectURL(A),k=document.createElement("a");k.href=L,k.download=`conversation_${e.userId}_${new Date().toISOString().slice(0,10)}.txt`,k.click(),URL.revokeObjectURL(L),r.success("å¯¼å‡ºæˆåŠŸ")}}catch(t){r.error("å¯¼å‡ºå¤±è´¥: "+t.message)}}return H(()=>{_()}),(e,t)=>(l(),p(a(v),{vertical:"",size:"large"},{default:s(()=>[o(a(Q),{title:"å¯¹è¯åŽ†å²"},{"header-extra":s(()=>[o(a(v),null,{default:s(()=>[o(a(q),{value:u.value,"onUpdate:value":t[0]||(t[0]=n=>u.value=n),placeholder:"æœç´¢ä¼šè¯IDæˆ–ç”¨æˆ·",clearable:"",style:{width:"200px"}},{prefix:s(()=>[o(a($),null,{default:s(()=>[o(a(ae))]),_:1})]),_:1},8,["value"]),o(a(h),{onClick:_,loading:d.value},{icon:s(()=>[o(a($),null,{default:s(()=>[o(a(F))]),_:1})]),default:s(()=>[t[2]||(t[2]=S(" åˆ·æ–° ",-1))]),_:1},8,["loading"])]),_:1})]),default:s(()=>[o(a(se),{columns:B,data:D.value,loading:d.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])]),_:1}),o(a(J),{show:g.value,"onUpdate:show":t[1]||(t[1]=n=>g.value=n),preset:"card",title:`ä¼šè¯è¯¦æƒ… - ${z.value?.userId||""}`,style:{width:"700px","max-height":"80vh"}},{default:s(()=>[N("div",ne,[w.value.length===0?(l(),p(a(W),{key:0,description:"æš‚æ— æ¶ˆæ¯"})):(l(),p(a(X),{key:1},{default:s(()=>[(l(!0),Y(Z,null,G(w.value,(n,C)=>(l(),p(a(K),{key:C},{default:s(()=>[o(a(ee),null,{header:s(()=>[o(a(v),{align:"center",size:8},{default:s(()=>[o(a(te),{type:n.role==="user"?"info":n.role==="assistant"?"success":"warning",size:"small"},{default:s(()=>[S(b(n.role),1)]),_:2},1032,["type"]),N("span",re,b(x(n.timestamp)),1)]),_:2},1024)]),description:s(()=>[N("div",ie,b(I(n)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))])]),_:1},8,["show","title"])]),_:1}))}},ye=E(le,[["__scopeId","data-v-ca483efa"]]);export{ye as default};
