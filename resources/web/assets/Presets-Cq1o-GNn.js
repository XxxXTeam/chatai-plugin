import{W as oe,r as i,l as ue,X as ne,Y as C,Z as u,$ as a,a0 as w,a1 as d,a2 as P,a3 as t,a4 as E,a8 as n,Q as f,a5 as b,a6 as G,a7 as re,P as c,ac as $,h as m,ab as V}from"./index-ByT8JVNQ.js";import{N as ie,a as T}from"./Tabs-Dt9u96et.js";import{N as de}from"./Code-JRHP4nR0.js";import{N as J}from"./Select-CIUXVh9L.js";import{N as L}from"./Switch-Hw-ePGMK.js";import{N as pe}from"./DataTable-DK-AIUwN.js";import{N as S}from"./InputNumber-DVLaWvsO.js";import{N as k}from"./DynamicTags-D82dMIgi.js";import{N as ve}from"./Popconfirm-5dLm6jcY.js";const Ne={__name:"Presets",setup(fe){const r=oe(),x=i([]),M=i([]),I=i([]),y=i(!1),U=i(!1),B=i(""),O=i(null),j=i(""),h=i(!1),p=i({defaultId:"default",allowUserSwitch:!0,perUserPreset:!1,perGroupPreset:!1}),z=()=>({name:"",description:"",systemPrompt:"",model:"",temperature:.7,persona:{name:"",personality:"",background:"",speakingStyle:"",traits:[],likes:[],dislikes:[],customFields:{}},context:{maxMessages:20,maxTokens:8e3,includeGroupContext:!1,groupContextLength:10},tools:{enableBuiltinTools:!0,allowedTools:[],disabledTools:[]}}),o=i(z()),q={name:{required:!0,message:"请输入名称",trigger:"blur"}},Q=ue(()=>x.value.map(s=>({label:s.name,value:s.id}))),W=[{title:"名称",key:"name",width:120},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"人设",key:"persona",width:100,render(s){return s.persona?.name?m(V,{type:"info",size:"small"},{default:()=>s.persona.name}):"-"}},{title:"模型",key:"model",width:150,ellipsis:{tooltip:!0}},{title:"默认",key:"isDefault",width:60,render(s){return p.value.defaultId===s.id?m(V,{type:"success",size:"small"},{default:()=>"是"}):""}},{title:"操作",key:"actions",width:220,render(s){return m(w,null,{default:()=>[m(f,{size:"small",onClick:()=>Z(s)},{default:()=>"编辑"}),m(f,{size:"small",type:"info",onClick:()=>H(s.id)},{default:()=>"预览"}),s.id!==p.value.defaultId?m(f,{size:"small",onClick:()=>K(s.id)},{default:()=>"设为默认"}):null,m(ve,{onPositiveClick:()=>ee(s.id)},{trigger:()=>m(f,{size:"small",type:"error",disabled:s.id==="default"},{default:()=>"删除"}),default:()=>"确定删除该预设吗？"})].filter(Boolean)})}}];async function N(){try{const s=await d.get("/api/preset/list");s.data.code===0&&(x.value=s.data.data)}catch{r.error("获取预设列表失败")}}async function X(){try{const s=await d.get("/api/channels/list");if(s.data.code===0){M.value=s.data.data;const e=new Set;M.value.forEach(l=>{l.models&&Array.isArray(l.models)&&l.models.forEach(v=>e.add(v))}),I.value=Array.from(e).map(l=>({label:l,value:l})),I.value.unshift({label:"使用默认模型",value:""})}}catch(s){console.error("Failed to fetch channels",s)}}function Y(){U.value=!1,B.value="",o.value=z(),y.value=!0}function Z(s){U.value=!0,B.value=s.id;const e=z();o.value={...e,...s,persona:{...e.persona,...s.persona},context:{...e.context,...s.context},tools:{...e.tools,...s.tools}},y.value=!0}async function H(s){try{const e=await d.get(`/api/preset/${s}/prompt`);e.data.code===0&&(j.value=e.data.data.prompt,h.value=!0)}catch{r.error("获取预览失败")}}async function K(s){try{(await d.put("/api/presets/config",{defaultId:s})).data.code===0&&(p.value.defaultId=s,r.success("已设为默认预设"))}catch{r.error("设置失败")}}async function _(){try{const s=await d.get("/api/presets/config");s.data.code===0&&(p.value=s.data.data)}catch(s){console.error("Failed to fetch presets config",s)}}async function A(){try{(await d.put("/api/presets/config",p.value)).data.code===0&&r.success("配置已保存")}catch{r.error("保存失败")}}async function ee(s){try{const e=await d.delete(`/api/preset/${s}`);e.data.code===0?(r.success("删除成功"),N()):r.error(e.data.message)}catch{r.error("删除失败")}}function ae(){const s=JSON.stringify(x.value,null,2),e=new Blob([s],{type:"application/json"}),l=URL.createObjectURL(e),v=document.createElement("a");v.href=l,v.download=`presets_${new Date().toISOString().slice(0,10)}.json`,v.click(),URL.revokeObjectURL(l),r.success("导出成功")}function le(){const s=document.createElement("input");s.type="file",s.accept=".json",s.onchange=async e=>{const l=e.target.files[0];if(l)try{const v=await l.text(),F=JSON.parse(v);if(!Array.isArray(F)){r.error("无效的预设文件格式");return}let R=0;for(const g of F)try{x.value.find(se=>se.id===g.id)?await d.put(`/api/preset/${g.id}`,g):await d.post("/api/preset/",g),R++}catch(D){console.error("导入预设失败:",g.name,D)}r.success(`成功导入 ${R} 个预设`),N()}catch(v){r.error("导入失败: "+v.message)}},s.click()}async function te(){O.value?.validate(async s=>{if(!s)try{let e;U.value?e=await d.put(`/api/preset/${B.value}`,o.value):e=await d.post("/api/preset/",o.value),e.data.code===0?(r.success("保存成功"),y.value=!1,N()):r.error(e.data.message)}catch{r.error("保存失败")}})}return ne(()=>{N(),X(),_()}),(s,e)=>(P(),C(a(w),{vertical:""},{default:u(()=>[t(a(E),{title:"预设配置",size:"small"},{default:u(()=>[t(a(w),null,{default:u(()=>[t(a(n),{label:"默认预设","label-placement":"left"},{default:u(()=>[t(a(J),{value:p.value.defaultId,"onUpdate:value":[e[0]||(e[0]=l=>p.value.defaultId=l),A],options:Q.value,style:{width:"200px"}},null,8,["value","options"])]),_:1}),t(a(n),{label:"允许用户切换","label-placement":"left"},{default:u(()=>[t(a(L),{value:p.value.allowUserSwitch,"onUpdate:value":[e[1]||(e[1]=l=>p.value.allowUserSwitch=l),A]},null,8,["value"])]),_:1})]),_:1})]),_:1}),t(a(E),{title:"预设管理"},{"header-extra":u(()=>[t(a(w),null,{default:u(()=>[t(a(f),{onClick:le},{default:u(()=>[...e[24]||(e[24]=[b("导入",-1)])]),_:1}),t(a(f),{onClick:ae},{default:u(()=>[...e[25]||(e[25]=[b("导出",-1)])]),_:1}),t(a(f),{type:"primary",onClick:Y},{default:u(()=>[...e[26]||(e[26]=[b("添加预设",-1)])]),_:1})]),_:1})]),default:u(()=>[t(a(pe),{columns:W,data:x.value,pagination:{pageSize:10}},null,8,["data"])]),_:1}),t(a(G),{show:y.value,"onUpdate:show":e[22]||(e[22]=l=>y.value=l),preset:"card",title:U.value?"编辑预设":"添加预设",style:{width:"800px","max-height":"90vh"},"mask-closable":!1},{footer:u(()=>[t(a(w),{justify:"end"},{default:u(()=>[t(a(f),{onClick:e[21]||(e[21]=l=>y.value=!1)},{default:u(()=>[...e[28]||(e[28]=[b("取消",-1)])]),_:1}),t(a(f),{type:"primary",onClick:te},{default:u(()=>[...e[29]||(e[29]=[b("保存",-1)])]),_:1})]),_:1})]),default:u(()=>[t(a(re),{ref_key:"formRef",ref:O,model:o.value,rules:q,"label-placement":"left","label-width":"100"},{default:u(()=>[t(a(ie),{type:"line"},{default:u(()=>[t(a(T),{name:"basic",tab:"基础设置"},{default:u(()=>[t(a(n),{label:"名称",path:"name"},{default:u(()=>[t(a(c),{value:o.value.name,"onUpdate:value":e[2]||(e[2]=l=>o.value.name=l),placeholder:"请输入名称"},null,8,["value"])]),_:1}),t(a(n),{label:"描述",path:"description"},{default:u(()=>[t(a(c),{value:o.value.description,"onUpdate:value":e[3]||(e[3]=l=>o.value.description=l),placeholder:"请输入描述"},null,8,["value"])]),_:1}),t(a(n),{label:"系统提示词"},{default:u(()=>[t(a(c),{value:o.value.systemPrompt,"onUpdate:value":e[4]||(e[4]=l=>o.value.systemPrompt=l),type:"textarea",placeholder:"基础系统提示词，人设信息会自动附加",rows:4},null,8,["value"])]),_:1}),t(a(n),{label:"模型"},{default:u(()=>[t(a(J),{value:o.value.model,"onUpdate:value":e[5]||(e[5]=l=>o.value.model=l),options:I.value,placeholder:"留空使用默认模型",filterable:"",tag:"",clearable:""},null,8,["value","options"])]),_:1}),t(a(n),{label:"温度"},{default:u(()=>[t(a(S),{value:o.value.temperature,"onUpdate:value":e[6]||(e[6]=l=>o.value.temperature=l),min:0,max:2,step:.1,style:{width:"150px"}},null,8,["value"])]),_:1})]),_:1}),t(a(T),{name:"persona",tab:"人设配置"},{default:u(()=>[t(a(n),{label:"角色名称"},{default:u(()=>[t(a(c),{value:o.value.persona.name,"onUpdate:value":e[7]||(e[7]=l=>o.value.persona.name=l),placeholder:"AI的名字"},null,8,["value"])]),_:1}),t(a(n),{label:"性格特点"},{default:u(()=>[t(a(c),{value:o.value.persona.personality,"onUpdate:value":e[8]||(e[8]=l=>o.value.persona.personality=l),placeholder:"如：友好、幽默、专业"},null,8,["value"])]),_:1}),t(a(n),{label:"说话风格"},{default:u(()=>[t(a(c),{value:o.value.persona.speakingStyle,"onUpdate:value":e[9]||(e[9]=l=>o.value.persona.speakingStyle=l),placeholder:"如：礼貌、简洁、活泼"},null,8,["value"])]),_:1}),t(a(n),{label:"背景故事"},{default:u(()=>[t(a(c),{value:o.value.persona.background,"onUpdate:value":e[10]||(e[10]=l=>o.value.persona.background=l),type:"textarea",placeholder:"角色的背景故事",rows:3},null,8,["value"])]),_:1}),t(a(n),{label:"性格标签"},{default:u(()=>[t(a(k),{value:o.value.persona.traits,"onUpdate:value":e[11]||(e[11]=l=>o.value.persona.traits=l)},null,8,["value"])]),_:1}),t(a(n),{label:"喜好"},{default:u(()=>[t(a(k),{value:o.value.persona.likes,"onUpdate:value":e[12]||(e[12]=l=>o.value.persona.likes=l)},null,8,["value"])]),_:1}),t(a(n),{label:"厌恶"},{default:u(()=>[t(a(k),{value:o.value.persona.dislikes,"onUpdate:value":e[13]||(e[13]=l=>o.value.persona.dislikes=l)},null,8,["value"])]),_:1})]),_:1}),t(a(T),{name:"context",tab:"上下文配置"},{default:u(()=>[t(a(n),{label:"最大消息数"},{default:u(()=>[t(a(S),{value:o.value.context.maxMessages,"onUpdate:value":e[14]||(e[14]=l=>o.value.context.maxMessages=l),min:1,max:100,style:{width:"150px"}},null,8,["value"])]),_:1}),t(a(n),{label:"最大Token数"},{default:u(()=>[t(a(S),{value:o.value.context.maxTokens,"onUpdate:value":e[15]||(e[15]=l=>o.value.context.maxTokens=l),min:100,max:128e3,step:100,style:{width:"150px"}},null,8,["value"])]),_:1}),t(a(n),{label:"包含群聊上下文"},{default:u(()=>[t(a(L),{value:o.value.context.includeGroupContext,"onUpdate:value":e[16]||(e[16]=l=>o.value.context.includeGroupContext=l)},null,8,["value"])]),_:1}),o.value.context.includeGroupContext?(P(),C(a(n),{key:0,label:"群聊上下文长度"},{default:u(()=>[t(a(S),{value:o.value.context.groupContextLength,"onUpdate:value":e[17]||(e[17]=l=>o.value.context.groupContextLength=l),min:1,max:50,style:{width:"150px"}},null,8,["value"])]),_:1})):$("",!0)]),_:1}),t(a(T),{name:"tools",tab:"工具配置"},{default:u(()=>[t(a(n),{label:"启用内置工具"},{default:u(()=>[t(a(L),{value:o.value.tools.enableBuiltinTools,"onUpdate:value":e[18]||(e[18]=l=>o.value.tools.enableBuiltinTools=l)},null,8,["value"])]),_:1}),o.value.tools.enableBuiltinTools?(P(),C(a(n),{key:0,label:"允许的工具"},{feedback:u(()=>[...e[27]||(e[27]=[b("留空表示允许所有工具",-1)])]),default:u(()=>[t(a(k),{value:o.value.tools.allowedTools,"onUpdate:value":e[19]||(e[19]=l=>o.value.tools.allowedTools=l)},null,8,["value"])]),_:1})):$("",!0),o.value.tools.enableBuiltinTools?(P(),C(a(n),{key:1,label:"禁用的工具"},{default:u(()=>[t(a(k),{value:o.value.tools.disabledTools,"onUpdate:value":e[20]||(e[20]=l=>o.value.tools.disabledTools=l)},null,8,["value"])]),_:1})):$("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),t(a(G),{show:h.value,"onUpdate:show":e[23]||(e[23]=l=>h.value=l),preset:"card",title:"系统提示词预览",style:{width:"700px"}},{default:u(()=>[t(a(de),{code:j.value,language:"markdown","word-wrap":""},null,8,["code"])]),_:1},8,["show"])]),_:1}))}};export{Ne as default};
