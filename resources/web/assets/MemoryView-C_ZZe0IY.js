import{d as $,a2 as A,S as g,Z as L,K as P,w as d,L as F,M as w,O as s,P as e,Q as p,R as c,T as l,aw as J,ax as M,U as N,ay as C,a1 as T,B as m,V as f,aq as x,ar as E,b7 as G,W as j,X as q,Y as _,N as S,h as I}from"./index-CRsLZEUK.js";import{S as H}from"./SearchOutlined-D6Wzddq_.js";import{D as K}from"./DeleteOutlined-B0wpKlHP.js";import{N as Q}from"./Select-BkVODdDG.js";import{N as O}from"./Popconfirm-CMn-Apyy.js";import{N as W}from"./DataTable-HweZ0C5S.js";const X={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 24 24"},Y=$({name:"AddOutlined",render:function(o,r){return g(),A("svg",X,r[0]||(r[0]=[L("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",fill:"currentColor"},null,-1)]))}}),re={__name:"MemoryView",setup(U){const o=P(),r=d(""),u=d([]),k=d([]),y=d(!1),v=d(!1),i=d({content:"",metadata:"{}"}),h=d({totalUsers:0,totalMemories:0}),B=[{title:"ID",key:"id",width:80,ellipsis:{tooltip:!0}},{title:"内容",key:"content",ellipsis:{tooltip:!0},render:t=>{const a=typeof t.content=="string"?t.content:JSON.stringify(t.content);return a.length>100?a.substring(0,100)+"...":a}},{title:"相似度",key:"score",width:80,render:t=>t.score?(t.score*100).toFixed(1)+"%":"-"},{title:"时间",key:"timestamp",width:160,render:t=>t.timestamp?new Date(t.timestamp).toLocaleString("zh-CN"):"-"},{title:"操作",key:"actions",width:100,render(t){return I(O,{onPositiveClick:()=>V(t.id)},{trigger:()=>I(m,{size:"small",type:"error"},{default:()=>"删除"}),default:()=>"确定删除此记忆？"})}}];async function z(){try{const t=await c.get("/api/memory/users");t.data.code===0&&(k.value=t.data.data||[],h.value.totalUsers=k.value.length)}catch(t){console.error("获取用户列表失败:",t)}}async function b(){if(!r.value){o.warning("请选择或输入用户ID");return}y.value=!0;try{const t=await c.get(`/api/memory/${r.value}`);t.data.code===0?(u.value=t.data.data||[],h.value.totalMemories=u.value.length):u.value=[]}catch(t){o.error("获取记忆失败: "+(t.response?.data?.message||t.message)),u.value=[]}finally{y.value=!1}}async function D(){if(!i.value.content.trim()){o.warning("请输入记忆内容");return}try{let t={};try{t=JSON.parse(i.value.metadata)}catch{}const a=await c.post("/api/memory",{userId:r.value,content:i.value.content,metadata:t});a.data.code===0?(o.success("添加成功"),v.value=!1,i.value={content:"",metadata:"{}"},b()):o.error("添加失败: "+a.data.message)}catch(t){o.error("添加失败: "+(t.response?.data?.message||t.message))}}async function V(t){try{const a=await c.delete(`/api/memory/${r.value}/${t}`);a.data.code===0?(o.success("删除成功"),b()):o.error("删除失败: "+a.data.message)}catch(a){o.error("删除失败: "+(a.response?.data?.message||a.message))}}async function R(){if(r.value)try{const t=await c.delete(`/api/memory/${r.value}`);t.data.code===0?(o.success("清空成功"),u.value=[]):o.error("清空失败: "+t.data.message)}catch(t){o.error("清空失败: "+(t.response?.data?.message||t.message))}}return F(()=>{z()}),(t,a)=>(g(),w(e(p),{vertical:"",size:"large"},{default:s(()=>[l(e(J),{cols:3,"x-gap":16},{default:s(()=>[l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"用户数",value:h.value.totalUsers},null,8,["value"])]),_:1})]),_:1}),l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"当前用户记忆数",value:u.value.length},null,8,["value"])]),_:1})]),_:1}),l(e(M),null,{default:s(()=>[l(e(N),{size:"small"},{default:s(()=>[l(e(C),{label:"已选用户",value:r.value||"-"},null,8,["value"])]),_:1})]),_:1})]),_:1}),l(e(N),{title:"记忆管理"},{"header-extra":s(()=>[l(e(p),null,{default:s(()=>[l(e(m),{size:"small",onClick:z},{icon:s(()=>[l(e(x),null,{default:s(()=>[l(e(G))]),_:1})]),default:s(()=>[a[6]||(a[6]=f(" 刷新用户 ",-1))]),_:1})]),_:1})]),default:s(()=>[l(e(p),{vertical:"",size:"large"},{default:s(()=>[l(e(p),null,{default:s(()=>[l(e(Q),{value:r.value,"onUpdate:value":a[0]||(a[0]=n=>r.value=n),options:k.value.map(n=>({label:n,value:n})),placeholder:"选择用户",filterable:"",tag:"",clearable:"",style:{width:"250px"}},null,8,["value","options"]),l(e(m),{type:"primary",onClick:b,loading:y.value},{icon:s(()=>[l(e(x),null,{default:s(()=>[l(e(H))]),_:1})]),default:s(()=>[a[7]||(a[7]=f(" 查询记忆 ",-1))]),_:1},8,["loading"]),l(e(m),{onClick:a[1]||(a[1]=n=>v.value=!0),disabled:!r.value},{icon:s(()=>[l(e(x),null,{default:s(()=>[l(e(Y))]),_:1})]),default:s(()=>[a[8]||(a[8]=f(" 添加记忆 ",-1))]),_:1},8,["disabled"]),u.value.length>0?(g(),w(e(O),{key:0,onPositiveClick:R},{trigger:s(()=>[l(e(m),{type:"error"},{icon:s(()=>[l(e(x),null,{default:s(()=>[l(e(K))]),_:1})]),default:s(()=>[a[9]||(a[9]=f(" 清空记忆 ",-1))]),_:1})]),default:s(()=>[a[10]||(a[10]=f(" 确定清空该用户的所有记忆？ ",-1))]),_:1})):T("",!0)]),_:1}),r.value?(g(),w(e(W),{key:1,columns:B,data:u.value,loading:y.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])):(g(),w(e(E),{key:0,description:"请选择或输入用户ID查询记忆"}))]),_:1})]),_:1}),l(e(j),{show:v.value,"onUpdate:show":a[5]||(a[5]=n=>v.value=n),preset:"card",title:"添加记忆",style:{width:"500px"}},{footer:s(()=>[l(e(p),{justify:"end"},{default:s(()=>[l(e(m),{onClick:a[4]||(a[4]=n=>v.value=!1)},{default:s(()=>[...a[11]||(a[11]=[f("取消",-1)])]),_:1}),l(e(m),{type:"primary",onClick:D},{default:s(()=>[...a[12]||(a[12]=[f("添加",-1)])]),_:1})]),_:1})]),default:s(()=>[l(e(q),{"label-placement":"top"},{default:s(()=>[l(e(_),{label:"记忆内容"},{default:s(()=>[l(e(S),{value:i.value.content,"onUpdate:value":a[2]||(a[2]=n=>i.value.content=n),type:"textarea",autosize:{minRows:3,maxRows:8},placeholder:"输入要记住的内容..."},null,8,["value"])]),_:1}),l(e(_),{label:"元数据 (可选, JSON格式)"},{default:s(()=>[l(e(S),{value:i.value.metadata,"onUpdate:value":a[3]||(a[3]=n=>i.value.metadata=n),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:'{"type": "fact", "importance": "high"}'},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["show"])]),_:1}))}};export{re as default};
