import{K as de,x as i,C as pe,L as me,M as B,O as o,P as l,Q as C,R as d,S as N,T as s,U as M,Y as r,B as p,V as f,W as O,X as ve,N as k,$ as m,a1 as F,Z as S,a2 as fe,a3 as ye,a4 as ce,a0 as R,h as g}from"./index-C4kcv-k7.js";import{C as ge}from"./CodeBlock-DQYHDbX-.js";import{N as be,a as z}from"./Tabs-B_E9OLNu.js";import{N as Q}from"./Select-Ds4k6n0x.js";import{N as V}from"./Switch-DAJY3CYl.js";import{N as ke}from"./DataTable-Qm1tIWQr.js";import{N as A}from"./InputNumber-DCvyj33l.js";import{N as T}from"./DynamicTags-BsZOeVpU.js";import{N as we}from"./Popconfirm-BWFjo_Q3.js";import"./Add-4cw-Rc12.js";import"./prop-NnGblK-3.js";const xe={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"16px"}},Pe={style:{"font-weight":"600","font-size":"15px"}},Ue={style:{"min-height":"60px"}},Ce={style:{color:"#666","font-size":"13px",margin:"0 0 8px 0"}},Ne={style:{color:"#999","font-size":"12px",margin:"0","line-height":"1.4",display:"-webkit-box","-webkit-line-clamp":"2","-webkit-box-orient":"vertical",overflow:"hidden"}},Re={__name:"Presets",setup(Se){const u=de(),c=i([]),j=i([]),$=i([]),b=i(!1),w=i(!1),I=i(""),D=i(null),E=i(""),L=i(!1),x=i(!1),y=i({defaultId:"default",allowUserSwitch:!0,perUserPreset:!1,perGroupPreset:!1}),W=[{id:"assistant",name:"通用助手",description:"友好专业的AI助手",systemPrompt:"你是一个有帮助的AI助手，请用简洁清晰的语言回答用户的问题。",persona:{name:"AI助手",personality:"友好、专业、乐于助人",speakingStyle:"礼貌、简洁"}},{id:"catgirl",name:"猫娘",description:"可爱的猫娘角色",systemPrompt:'你是一只可爱的猫娘，说话时会加上"喵~"，性格活泼可爱。',persona:{name:"小喵",personality:"活泼、可爱、傲娇",speakingStyle:"卖萌、撒娇",traits:["猫耳","傲娇","贪吃"]}},{id:"coder",name:"编程助手",description:"专业的编程开发助手",systemPrompt:"你是一个专业的编程助手，擅长多种编程语言和框架。请提供清晰的代码示例和解释。",persona:{name:"代码助手",personality:"严谨、专业、耐心",speakingStyle:"技术性、条理清晰"}},{id:"translator",name:"翻译助手",description:"多语言翻译专家",systemPrompt:"你是一个专业的翻译助手，精通中英日韩等多种语言。请提供准确流畅的翻译。",persona:{name:"翻译官",personality:"专业、细致",speakingStyle:"准确、地道"}},{id:"writer",name:"写作助手",description:"创意写作和文案助手",systemPrompt:"你是一个创意写作助手，擅长各类文体写作，包括小说、诗歌、文案等。",persona:{name:"文思",personality:"富有创意、文采斐然",speakingStyle:"优美、富有感染力"}},{id:"roleplay",name:"角色扮演",description:"沉浸式角色扮演",systemPrompt:"你将扮演用户指定的角色，保持角色一致性，进行沉浸式对话。不要打破角色设定。",persona:{name:"",personality:"根据角色设定",speakingStyle:"符合角色特点"}},{id:"tutor",name:"学习导师",description:"耐心的学习辅导老师",systemPrompt:"你是一个耐心的学习导师，擅长用通俗易懂的方式解释复杂概念，引导学生思考。",persona:{name:"导师",personality:"耐心、博学、善于引导",speakingStyle:"循循善诱、深入浅出"}},{id:"emotional",name:"情感陪伴",description:"温暖的情感支持伙伴",systemPrompt:"你是一个温暖的倾听者和陪伴者，善于理解和安慰他人，提供情感支持。",persona:{name:"暖心",personality:"温柔、善解人意、有同理心",speakingStyle:"温暖、治愈"}}];function X(a){n.value={...P(),name:a.name,description:a.description,systemPrompt:a.systemPrompt,persona:{...P().persona,...a.persona}},x.value=!1,w.value=!1,I.value="",b.value=!0}const P=()=>({name:"",description:"",systemPrompt:"",model:"",temperature:.7,persona:{name:"",personality:"",background:"",speakingStyle:"",traits:[],likes:[],dislikes:[],customFields:{}},context:{maxMessages:20,maxTokens:8e3,includeGroupContext:!1,groupContextLength:10},tools:{enableBuiltinTools:!0,allowedTools:[],disabledTools:[]}}),n=i(P()),Y={name:{required:!0,message:"请输入名称",trigger:"blur"}},Z=pe(()=>c.value.map(a=>({label:a.name,value:a.id}))),H=[{title:"名称",key:"name",width:120},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"人设",key:"persona",width:100,render(a){return a.persona?.name?g(R,{type:"info",size:"small"},{default:()=>a.persona.name}):"-"}},{title:"模型",key:"model",width:150,ellipsis:{tooltip:!0}},{title:"默认",key:"isDefault",width:60,render(a){return y.value.defaultId===a.id?g(R,{type:"success",size:"small"},{default:()=>"是"}):""}},{title:"操作",key:"actions",width:220,render(a){return g(C,null,{default:()=>[g(p,{size:"small",onClick:()=>ae(a)},{default:()=>"编辑"}),g(p,{size:"small",type:"info",onClick:()=>te(a.id)},{default:()=>"预览"}),a.id!==y.value.defaultId?g(p,{size:"small",onClick:()=>le(a.id)},{default:()=>"设为默认"}):null,g(we,{onPositiveClick:()=>oe(a.id)},{trigger:()=>g(p,{size:"small",type:"error",disabled:a.id==="default"},{default:()=>"删除"}),default:()=>"确定删除该预设吗？"})].filter(Boolean)})}}];async function h(){try{const a=await d.get("/api/preset/list");a.data.code===0?(c.value=Array.isArray(a.data.data)?a.data.data:[],console.log("[Presets] 加载预设:",c.value.length,"个")):(console.warn("[Presets] API返回错误:",a.data.message),c.value=[])}catch(a){console.error("[Presets] 获取预设列表失败:",a),u.error("获取预设列表失败: "+(a.response?.data?.message||a.message)),c.value=[]}}async function _(){try{const a=await d.get("/api/channels/list");if(a.data.code===0){j.value=a.data.data;const e=new Set;j.value.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(v=>e.add(v))}),$.value=Array.from(e).map(t=>({label:t,value:t})),$.value.unshift({label:"使用默认模型",value:""})}}catch(a){console.error("Failed to fetch channels",a)}}function ee(){w.value=!1,I.value="",n.value=P(),b.value=!0}function ae(a){w.value=!0,I.value=a.id;const e=P();n.value={...e,...a,persona:{...e.persona,...a.persona},context:{...e.context,...a.context},tools:{...e.tools,...a.tools}},b.value=!0}async function te(a){try{const e=await d.get(`/api/preset/${a}/prompt`);e.data.code===0&&(E.value=e.data.data.prompt,L.value=!0)}catch{u.error("获取预览失败")}}async function le(a){try{(await d.put("/api/presets/config",{defaultId:a})).data.code===0&&(y.value.defaultId=a,u.success("已设为默认预设"))}catch{u.error("设置失败")}}async function se(){try{const a=await d.get("/api/presets/config");a.data.code===0&&(y.value=a.data.data)}catch(a){console.error("Failed to fetch presets config",a)}}async function G(){try{(await d.put("/api/presets/config",y.value)).data.code===0&&u.success("配置已保存")}catch{u.error("保存失败")}}async function oe(a){try{const e=await d.delete(`/api/preset/${a}`);e.data.code===0?(u.success("删除成功"),h()):u.error(e.data.message)}catch{u.error("删除失败")}}function ne(){const a=JSON.stringify(c.value,null,2),e=new Blob([a],{type:"application/json"}),t=URL.createObjectURL(e),v=document.createElement("a");v.href=t,v.download=`presets_${new Date().toISOString().slice(0,10)}.json`,v.click(),URL.revokeObjectURL(t),u.success("导出成功")}function re(){const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async e=>{const t=e.target.files[0];if(t)try{const v=await t.text(),J=JSON.parse(v);if(!Array.isArray(J)){u.error("无效的预设文件格式");return}let q=0;for(const U of J)try{c.value.find(ie=>ie.id===U.id)?await d.put(`/api/preset/${U.id}`,U):await d.post("/api/preset/",U),q++}catch(K){console.error("导入预设失败:",U.name,K)}u.success(`成功导入 ${q} 个预设`),h()}catch(v){u.error("导入失败: "+v.message)}},a.click()}async function ue(){D.value?.validate(async a=>{if(!a)try{let e;w.value?e=await d.put(`/api/preset/${I.value}`,n.value):e=await d.post("/api/preset/",n.value),e.data.code===0?(u.success("保存成功"),b.value=!1,h()):u.error(e.data.message)}catch{u.error("保存失败")}})}return me(()=>{h(),_(),se()}),(a,e)=>(N(),B(l(C),{vertical:""},{default:o(()=>[s(l(M),{title:"预设配置",size:"small"},{default:o(()=>[s(l(C),null,{default:o(()=>[s(l(r),{label:"默认预设","label-placement":"left"},{default:o(()=>[s(l(Q),{value:y.value.defaultId,"onUpdate:value":[e[0]||(e[0]=t=>y.value.defaultId=t),G],options:Z.value,style:{width:"200px"}},null,8,["value","options"])]),_:1}),s(l(r),{label:"允许用户切换","label-placement":"left"},{default:o(()=>[s(l(V),{value:y.value.allowUserSwitch,"onUpdate:value":[e[1]||(e[1]=t=>y.value.allowUserSwitch=t),G]},null,8,["value"])]),_:1})]),_:1})]),_:1}),s(l(M),{title:"预设管理"},{"header-extra":o(()=>[s(l(C),null,{default:o(()=>[s(l(p),{onClick:e[2]||(e[2]=t=>x.value=!0)},{default:o(()=>[...e[27]||(e[27]=[f("模板库",-1)])]),_:1}),s(l(p),{onClick:re},{default:o(()=>[...e[28]||(e[28]=[f("导入",-1)])]),_:1}),s(l(p),{onClick:ne},{default:o(()=>[...e[29]||(e[29]=[f("导出",-1)])]),_:1}),s(l(p),{type:"primary",onClick:ee},{default:o(()=>[...e[30]||(e[30]=[f("添加预设",-1)])]),_:1})]),_:1})]),default:o(()=>[s(l(ke),{columns:H,data:c.value,pagination:{pageSize:10}},null,8,["data"])]),_:1}),s(l(O),{show:b.value,"onUpdate:show":e[23]||(e[23]=t=>b.value=t),preset:"card",title:w.value?"编辑预设":"添加预设",style:{width:"800px","max-height":"90vh"},"mask-closable":!1},{footer:o(()=>[s(l(C),{justify:"end"},{default:o(()=>[s(l(p),{onClick:e[22]||(e[22]=t=>b.value=!1)},{default:o(()=>[...e[32]||(e[32]=[f("取消",-1)])]),_:1}),s(l(p),{type:"primary",onClick:ue},{default:o(()=>[...e[33]||(e[33]=[f("保存",-1)])]),_:1})]),_:1})]),default:o(()=>[s(l(ve),{ref_key:"formRef",ref:D,model:n.value,rules:Y,"label-placement":"left","label-width":"100"},{default:o(()=>[s(l(be),{type:"line"},{default:o(()=>[s(l(z),{name:"basic",tab:"基础设置"},{default:o(()=>[s(l(r),{label:"名称",path:"name"},{default:o(()=>[s(l(k),{value:n.value.name,"onUpdate:value":e[3]||(e[3]=t=>n.value.name=t),placeholder:"请输入名称"},null,8,["value"])]),_:1}),s(l(r),{label:"描述",path:"description"},{default:o(()=>[s(l(k),{value:n.value.description,"onUpdate:value":e[4]||(e[4]=t=>n.value.description=t),placeholder:"请输入描述"},null,8,["value"])]),_:1}),s(l(r),{label:"系统提示词"},{feedback:o(()=>[f(" 支持变量: "+m(a.user_name)+", "+m(a.user_id)+", "+m(a.group_name)+", "+m(a.group_id)+", "+m(a.bot_name)+", "+m(a.date)+", "+m(a.time)+", "+m(a.weekday),1)]),default:o(()=>[s(l(k),{value:n.value.systemPrompt,"onUpdate:value":e[5]||(e[5]=t=>n.value.systemPrompt=t),type:"textarea",placeholder:"基础系统提示词，人设信息会自动附加",rows:4},null,8,["value"])]),_:1}),s(l(r),{label:"模型"},{default:o(()=>[s(l(Q),{value:n.value.model,"onUpdate:value":e[6]||(e[6]=t=>n.value.model=t),options:$.value,placeholder:"留空使用默认模型",filterable:"",tag:"",clearable:""},null,8,["value","options"])]),_:1}),s(l(r),{label:"温度"},{default:o(()=>[s(l(A),{value:n.value.temperature,"onUpdate:value":e[7]||(e[7]=t=>n.value.temperature=t),min:0,max:2,step:.1,style:{width:"150px"}},null,8,["value"])]),_:1})]),_:1}),s(l(z),{name:"persona",tab:"人设配置"},{default:o(()=>[s(l(r),{label:"角色名称"},{default:o(()=>[s(l(k),{value:n.value.persona.name,"onUpdate:value":e[8]||(e[8]=t=>n.value.persona.name=t),placeholder:"AI的名字"},null,8,["value"])]),_:1}),s(l(r),{label:"性格特点"},{default:o(()=>[s(l(k),{value:n.value.persona.personality,"onUpdate:value":e[9]||(e[9]=t=>n.value.persona.personality=t),placeholder:"如：友好、幽默、专业"},null,8,["value"])]),_:1}),s(l(r),{label:"说话风格"},{default:o(()=>[s(l(k),{value:n.value.persona.speakingStyle,"onUpdate:value":e[10]||(e[10]=t=>n.value.persona.speakingStyle=t),placeholder:"如：礼貌、简洁、活泼"},null,8,["value"])]),_:1}),s(l(r),{label:"背景故事"},{default:o(()=>[s(l(k),{value:n.value.persona.background,"onUpdate:value":e[11]||(e[11]=t=>n.value.persona.background=t),type:"textarea",placeholder:"角色的背景故事",rows:3},null,8,["value"])]),_:1}),s(l(r),{label:"性格标签"},{default:o(()=>[s(l(T),{value:n.value.persona.traits,"onUpdate:value":e[12]||(e[12]=t=>n.value.persona.traits=t)},null,8,["value"])]),_:1}),s(l(r),{label:"喜好"},{default:o(()=>[s(l(T),{value:n.value.persona.likes,"onUpdate:value":e[13]||(e[13]=t=>n.value.persona.likes=t)},null,8,["value"])]),_:1}),s(l(r),{label:"厌恶"},{default:o(()=>[s(l(T),{value:n.value.persona.dislikes,"onUpdate:value":e[14]||(e[14]=t=>n.value.persona.dislikes=t)},null,8,["value"])]),_:1})]),_:1}),s(l(z),{name:"context",tab:"上下文配置"},{default:o(()=>[s(l(r),{label:"最大消息数"},{default:o(()=>[s(l(A),{value:n.value.context.maxMessages,"onUpdate:value":e[15]||(e[15]=t=>n.value.context.maxMessages=t),min:1,max:100,style:{width:"150px"}},null,8,["value"])]),_:1}),s(l(r),{label:"最大Token数"},{default:o(()=>[s(l(A),{value:n.value.context.maxTokens,"onUpdate:value":e[16]||(e[16]=t=>n.value.context.maxTokens=t),min:100,max:128e3,step:100,style:{width:"150px"}},null,8,["value"])]),_:1}),s(l(r),{label:"包含群聊上下文"},{default:o(()=>[s(l(V),{value:n.value.context.includeGroupContext,"onUpdate:value":e[17]||(e[17]=t=>n.value.context.includeGroupContext=t)},null,8,["value"])]),_:1}),n.value.context.includeGroupContext?(N(),B(l(r),{key:0,label:"群聊上下文长度"},{default:o(()=>[s(l(A),{value:n.value.context.groupContextLength,"onUpdate:value":e[18]||(e[18]=t=>n.value.context.groupContextLength=t),min:1,max:50,style:{width:"150px"}},null,8,["value"])]),_:1})):F("",!0)]),_:1}),s(l(z),{name:"tools",tab:"工具配置"},{default:o(()=>[s(l(r),{label:"启用内置工具"},{default:o(()=>[s(l(V),{value:n.value.tools.enableBuiltinTools,"onUpdate:value":e[19]||(e[19]=t=>n.value.tools.enableBuiltinTools=t)},null,8,["value"])]),_:1}),n.value.tools.enableBuiltinTools?(N(),B(l(r),{key:0,label:"允许的工具"},{feedback:o(()=>[...e[31]||(e[31]=[f("留空表示允许所有工具",-1)])]),default:o(()=>[s(l(T),{value:n.value.tools.allowedTools,"onUpdate:value":e[20]||(e[20]=t=>n.value.tools.allowedTools=t)},null,8,["value"])]),_:1})):F("",!0),n.value.tools.enableBuiltinTools?(N(),B(l(r),{key:1,label:"禁用的工具"},{default:o(()=>[s(l(T),{value:n.value.tools.disabledTools,"onUpdate:value":e[21]||(e[21]=t=>n.value.tools.disabledTools=t)},null,8,["value"])]),_:1})):F("",!0)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),s(l(O),{show:L.value,"onUpdate:show":e[24]||(e[24]=t=>L.value=t),preset:"card",title:"系统提示词预览",style:{width:"700px"}},{default:o(()=>[s(ge,{code:E.value,markdown:!0},null,8,["code"])]),_:1},8,["show"]),s(l(O),{show:x.value,"onUpdate:show":e[26]||(e[26]=t=>x.value=t),preset:"card",title:"预设模板库",style:{width:"750px"}},{footer:o(()=>[s(l(p),{onClick:e[25]||(e[25]=t=>x.value=!1)},{default:o(()=>[...e[35]||(e[35]=[f("关闭",-1)])]),_:1})]),default:o(()=>[S("div",xe,[(N(),fe(ye,null,ce(W,t=>s(l(M),{key:t.id,size:"small",hoverable:"",style:{cursor:"pointer"},onClick:v=>X(t)},{header:o(()=>[S("div",Pe,m(t.name),1)]),"header-extra":o(()=>[s(l(R),{size:"small",type:"info"},{default:o(()=>[...e[34]||(e[34]=[f("点击使用",-1)])]),_:1})]),default:o(()=>[S("div",Ue,[S("p",Ce,m(t.description),1),S("p",Ne,m(t.systemPrompt),1)])]),_:2},1032,["onClick"])),64))])]),_:1},8,["show"])]),_:1}))}};export{Re as default};
