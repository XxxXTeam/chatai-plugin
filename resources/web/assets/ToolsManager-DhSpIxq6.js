import{W as Te,r as o,l as P,X as Ce,Y as B,Z as s,$ as a,a0 as v,a1 as c,a2 as w,a3 as t,aH as ze,aI as L,a4 as J,aJ as h,P as N,Q as p,a5 as r,ac as F,ae as Z,a7 as _,a8 as f,a6 as R,a9 as g,aa as I,ab as M,ax as q,aA as ee,h as m}from"./index-BkHJ8ozj.js";import{N as Ue,a as G}from"./Tabs-D0W-1IL4.js";import{N as Y}from"./Select-BSaey-Nh.js";import{N as le}from"./DataTable-CWXZQiHu.js";import{N as ae}from"./Switch-FaSdSlpy.js";import{N as K}from"./DynamicTags-JpeH22l6.js";import{N as xe}from"./Divider-CL_5VIHO.js";import{N as te}from"./Code-nFqxYFwE.js";import{N as Pe}from"./Popconfirm-CqnnVkVp.js";const Be={key:0},Fe={__name:"ToolsManager",setup(Je){const i=Te(),j=o(!1),U=o([]),O=o([]),D=o(""),E=o(null),$=o(null),W=o("tools"),V=o(!1),y=o(null),H=o(!1),x=o("{}"),S=o(""),Q=o(!1),C=o(!1),k=o(!1),n=o({name:"",type:"stdio",command:"",args:"",url:"",env:"",scriptPath:""}),d=o({enabled:!0,allowedTools:[],disabledTools:[],dangerousTools:["kick_member","mute_member","recall_message","set_group_ban","set_group_whole_ban"],allowDangerous:!1}),se=P(()=>{const l=new Set(["builtin"]);return U.value.forEach(e=>{e.serverName&&l.add(e.serverName)}),[{label:"全部",value:null},...Array.from(l).map(e=>({label:e,value:e}))]}),ue=[{label:"全部",value:null},{label:"内置工具",value:"builtin"},{label:"MCP工具",value:"mcp"}],ne=P(()=>{let l=U.value;if(D.value){const e=D.value.toLowerCase();l=l.filter(u=>u.name.toLowerCase().includes(e)||u.description?.toLowerCase().includes(e))}return $.value&&(l=l.filter(e=>(e.serverName||"builtin")===$.value)),E.value==="builtin"?l=l.filter(e=>e.isBuiltin):E.value==="mcp"&&(l=l.filter(e=>!e.isBuiltin)),l}),oe=P(()=>U.value.filter(l=>l.isBuiltin).length),re=P(()=>U.value.filter(l=>!l.isBuiltin).length),ie=P(()=>O.value.filter(l=>l.status==="connected").length),de=[{title:"名称",key:"name",width:180,ellipsis:{tooltip:!0}},{title:"描述",key:"description",ellipsis:{tooltip:!0}},{title:"类型",key:"type",width:80,render:l=>l.isBuiltin?m(M,{type:"success",size:"small"},{default:()=>"内置"}):m(M,{type:"info",size:"small"},{default:()=>"MCP"})},{title:"来源",key:"serverName",width:120,render:l=>l.serverName||"builtin"},{title:"危险",key:"dangerous",width:60,render:l=>d.value.dangerousTools?.includes(l.name)?m(M,{type:"error",size:"small"},{default:()=>"是"}):""},{title:"操作",key:"actions",width:150,render:l=>m(v,{size:"small"},{default:()=>[m(p,{size:"small",onClick:()=>me(l)},{default:()=>"详情"}),m(p,{size:"small",type:"primary",onClick:()=>ye(l)},{default:()=>"测试"})]})}],ve=[{title:"名称",key:"name",width:150},{title:"类型",key:"type",width:100,render:l=>({stdio:"本地进程",sse:"SSE",http:"HTTP",js:"JS脚本"})[l.type]||l.type},{title:"状态",key:"status",width:100,render:l=>{const e=l.status==="connected"?"success":l.status==="error"?"error":"warning";return m(M,{type:e,size:"small"},{default:()=>l.status||"unknown"})}},{title:"工具数",key:"toolsCount",width:80},{title:"资源数",key:"resourcesCount",width:80},{title:"操作",key:"actions",width:200,render:l=>{const e=l.name==="builtin";return m(v,{size:"small"},{default:()=>[m(p,{size:"small",onClick:()=>we(l),disabled:e},{default:()=>"重连"}),m(p,{size:"small",onClick:()=>be(l),disabled:e},{default:()=>"编辑"}),m(Pe,{onPositiveClick:()=>Ne(l)},{trigger:()=>m(p,{size:"small",type:"error",disabled:e},{default:()=>"删除"}),default:()=>"确定要删除吗？"})]})}}];async function T(){j.value=!0;try{const l=await c.get("/api/tools/list");l.data.code===0&&(U.value=l.data.data||[])}catch{i.error("获取工具列表失败")}finally{j.value=!1}}async function A(){try{const l=await c.get("/api/mcp/servers");l.data.code===0&&(O.value=l.data.data||[])}catch{i.error("获取服务器列表失败")}}async function fe(){try{const l=await c.get("/api/tools/builtin/config");l.data.code===0&&(d.value={...d.value,...l.data.data})}catch(l){console.error("Failed to fetch builtin config",l)}}async function pe(){try{(await c.put("/api/tools/builtin/config",d.value)).data.code===0&&(i.success("配置已保存"),await T())}catch{i.error("保存失败")}}function me(l){y.value=l,V.value=!0}function ye(l){y.value=l,x.value=JSON.stringify(X(l),null,2),S.value="",H.value=!0}function X(l){const e=l.inputSchema||l.parameters||{},u={};return e.properties&&Object.keys(e.properties).forEach(b=>{const z=e.properties[b];z.default!==void 0?u[b]=z.default:z.type==="string"?u[b]="":z.type==="number"||z.type==="integer"?u[b]=0:z.type==="boolean"&&(u[b]=!1)}),u}async function ge(){Q.value=!0,S.value="";try{const l=JSON.parse(x.value),e=await c.post("/api/tools/test",{toolName:y.value.name,arguments:l});e.data.code===0?(S.value=JSON.stringify(e.data.data,null,2),i.success("测试成功")):S.value=`Error: ${e.data.message}`}catch(l){S.value=`Error: ${l.message}`}finally{Q.value=!1}}function ce(){k.value=!1,n.value={name:"",type:"stdio",command:"",args:"",url:"",env:"",scriptPath:""},C.value=!0}function be(l){k.value=!0,n.value={name:l.name,type:l.type||"stdio",command:l.config?.command||"",args:l.config?.args?.join(" ")||"",url:l.config?.url||"",env:l.config?.env?JSON.stringify(l.config.env):"",scriptPath:l.config?.scriptPath||""},C.value=!0}async function we(l){try{const e=await c.post(`/api/mcp/servers/${l.name}/reconnect`);e.data.code===0?(i.success("重连成功"),A(),T()):i.error(e.data.message)}catch(e){i.error("重连失败: "+e.message)}}async function Ne(l){try{const e=await c.delete(`/api/mcp/servers/${l.name}`);e.data.code===0?(i.success("删除成功"),A(),T()):i.error(e.data.message)}catch{i.error("删除失败")}}async function Se(){try{const l={type:n.value.type};n.value.type==="stdio"?(l.command=n.value.command,n.value.args&&(l.args=n.value.args.split(" ").filter(Boolean)),n.value.env&&(l.env=JSON.parse(n.value.env))):n.value.type==="js"?l.scriptPath=n.value.scriptPath:l.url=n.value.url;const e=k.value?`/api/mcp/servers/${n.value.name}`:"/api/mcp/servers",u=k.value?"put":"post",b=await c[u](e,{name:n.value.name,config:l});b.data.code===0?(i.success(k.value?"更新成功":"添加成功"),C.value=!1,A(),T()):i.error(b.data.message)}catch(l){i.error("操作失败: "+l.message)}}async function ke(){try{const l=await c.post("/api/tools/builtin/refresh");l.data.code===0&&(i.success(`已刷新 ${l.data.data?.count||0} 个内置工具`),await T())}catch{i.error("刷新失败")}}return Ce(()=>{T(),A(),fe()}),(l,e)=>(w(),B(a(v),{vertical:"",size:16},{default:s(()=>[t(a(ze),{cols:4,"x-gap":16},{default:s(()=>[t(a(L),null,{default:s(()=>[t(a(J),{size:"small"},{default:s(()=>[t(a(h),{label:"内置工具",value:oe.value},null,8,["value"])]),_:1})]),_:1}),t(a(L),null,{default:s(()=>[t(a(J),{size:"small"},{default:s(()=>[t(a(h),{label:"MCP工具",value:re.value},null,8,["value"])]),_:1})]),_:1}),t(a(L),null,{default:s(()=>[t(a(J),{size:"small"},{default:s(()=>[t(a(h),{label:"MCP服务器",value:O.value.length},null,8,["value"])]),_:1})]),_:1}),t(a(L),null,{default:s(()=>[t(a(J),{size:"small"},{default:s(()=>[t(a(h),{label:"已连接",value:ie.value},null,8,["value"])]),_:1})]),_:1})]),_:1}),t(a(J),null,{default:s(()=>[t(a(Ue),{value:W.value,"onUpdate:value":e[8]||(e[8]=u=>W.value=u),type:"line"},{default:s(()=>[t(a(G),{name:"tools",tab:"工具列表"},{default:s(()=>[t(a(v),{vertical:"",size:12},{default:s(()=>[t(a(v),{justify:"space-between"},{default:s(()=>[t(a(v),null,{default:s(()=>[t(a(N),{value:D.value,"onUpdate:value":e[0]||(e[0]=u=>D.value=u),placeholder:"搜索工具...",style:{width:"200px"},clearable:""},null,8,["value"]),t(a(Y),{value:E.value,"onUpdate:value":e[1]||(e[1]=u=>E.value=u),options:ue,placeholder:"类型",style:{width:"120px"},clearable:""},null,8,["value"]),t(a(Y),{value:$.value,"onUpdate:value":e[2]||(e[2]=u=>$.value=u),options:se.value,placeholder:"来源",style:{width:"150px"},clearable:""},null,8,["value","options"])]),_:1}),t(a(p),{onClick:T,loading:j.value},{default:s(()=>[...e[22]||(e[22]=[r("刷新",-1)])]),_:1},8,["loading"])]),_:1}),t(a(le),{columns:de,data:ne.value,loading:j.value,pagination:{pageSize:15},size:"small"},null,8,["data","loading"])]),_:1})]),_:1}),t(a(G),{name:"servers",tab:"MCP服务器"},{default:s(()=>[t(a(v),{vertical:"",size:12},{default:s(()=>[t(a(v),{justify:"end"},{default:s(()=>[t(a(p),{type:"primary",onClick:ce},{default:s(()=>[...e[23]||(e[23]=[r("添加服务器",-1)])]),_:1})]),_:1}),t(a(le),{columns:ve,data:O.value,size:"small"},null,8,["data"])]),_:1})]),_:1}),t(a(G),{name:"builtin",tab:"内置工具配置"},{default:s(()=>[t(a(v),{vertical:"",size:16},{default:s(()=>[d.value.enabled?F("",!0):(w(),B(a(Z),{key:0,type:"warning"},{default:s(()=>[...e[24]||(e[24]=[r(" 内置工具已禁用，AI将无法使用QQ相关功能 ",-1)])]),_:1})),t(a(_),{"label-placement":"left","label-width":"140"},{default:s(()=>[t(a(f),{label:"启用内置工具"},{default:s(()=>[t(a(ae),{value:d.value.enabled,"onUpdate:value":e[3]||(e[3]=u=>d.value.enabled=u)},null,8,["value"])]),_:1}),t(a(f),{label:"允许危险操作"},{feedback:s(()=>[...e[25]||(e[25]=[r("危险操作包括踢人、禁言、撤回等",-1)])]),default:s(()=>[t(a(ae),{value:d.value.allowDangerous,"onUpdate:value":e[4]||(e[4]=u=>d.value.allowDangerous=u)},null,8,["value"])]),_:1}),t(a(f),{label:"危险工具列表"},{default:s(()=>[t(a(K),{value:d.value.dangerousTools,"onUpdate:value":e[5]||(e[5]=u=>d.value.dangerousTools=u)},null,8,["value"])]),_:1}),t(a(f),{label:"允许的工具"},{feedback:s(()=>[...e[26]||(e[26]=[r("留空表示允许所有工具",-1)])]),default:s(()=>[t(a(K),{value:d.value.allowedTools,"onUpdate:value":e[6]||(e[6]=u=>d.value.allowedTools=u)},null,8,["value"])]),_:1}),t(a(f),{label:"禁用的工具"},{default:s(()=>[t(a(K),{value:d.value.disabledTools,"onUpdate:value":e[7]||(e[7]=u=>d.value.disabledTools=u)},null,8,["value"])]),_:1}),t(a(f),null,{default:s(()=>[t(a(v),null,{default:s(()=>[t(a(p),{type:"primary",onClick:pe},{default:s(()=>[...e[27]||(e[27]=[r("保存配置",-1)])]),_:1}),t(a(p),{onClick:ke},{default:s(()=>[...e[28]||(e[28]=[r("刷新内置工具",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["value"])]),_:1}),t(a(R),{show:V.value,"onUpdate:show":e[9]||(e[9]=u=>V.value=u),preset:"card",title:"工具详情",style:{width:"650px"}},{default:s(()=>[y.value?(w(),B(a(v),{key:0,vertical:""},{default:s(()=>[g("div",null,[e[29]||(e[29]=g("strong",null,"名称:",-1)),r(" "+I(y.value.name),1)]),g("div",null,[e[30]||(e[30]=g("strong",null,"描述:",-1)),r(" "+I(y.value.description),1)]),g("div",null,[e[31]||(e[31]=g("strong",null,"来源:",-1)),e[32]||(e[32]=r()),t(a(M),{type:"info",size:"small"},{default:s(()=>[r(I(y.value.serverName||"builtin"),1)]),_:1})]),t(a(xe)),e[33]||(e[33]=g("div",null,[g("strong",null,"输入参数:")],-1)),t(a(te),{code:JSON.stringify(y.value.inputSchema||{},null,2),language:"json"},null,8,["code"])]),_:1})):F("",!0)]),_:1},8,["show"]),t(a(R),{show:H.value,"onUpdate:show":e[12]||(e[12]=u=>H.value=u),preset:"card",title:"测试工具",style:{width:"700px"}},{default:s(()=>[y.value?(w(),B(a(v),{key:0,vertical:""},{default:s(()=>[g("div",null,[e[34]||(e[34]=g("strong",null,"工具:",-1)),r(" "+I(y.value.name),1)]),t(a(f),{label:"参数 (JSON)"},{default:s(()=>[t(a(N),{value:x.value,"onUpdate:value":e[10]||(e[10]=u=>x.value=u),type:"textarea",rows:8,placeholder:'{"key": "value"}'},null,8,["value"])]),_:1}),t(a(v),null,{default:s(()=>[t(a(p),{type:"primary",onClick:ge,loading:Q.value},{default:s(()=>[...e[35]||(e[35]=[r("执行测试",-1)])]),_:1},8,["loading"]),t(a(p),{onClick:e[11]||(e[11]=u=>x.value=JSON.stringify(X(y.value),null,2))},{default:s(()=>[...e[36]||(e[36]=[r("重置参数",-1)])]),_:1})]),_:1}),S.value?(w(),q("div",Be,[e[37]||(e[37]=g("strong",null,"测试结果:",-1)),t(a(te),{code:S.value,language:"json",style:{"margin-top":"8px"}},null,8,["code"])])):F("",!0)]),_:1})):F("",!0)]),_:1},8,["show"]),t(a(R),{show:C.value,"onUpdate:show":e[21]||(e[21]=u=>C.value=u),preset:"card",title:k.value?"编辑服务器":"添加服务器",style:{width:"600px"}},{footer:s(()=>[t(a(v),{justify:"end"},{default:s(()=>[t(a(p),{onClick:e[20]||(e[20]=u=>C.value=!1)},{default:s(()=>[...e[39]||(e[39]=[r("取消",-1)])]),_:1}),t(a(p),{type:"primary",onClick:Se},{default:s(()=>[...e[40]||(e[40]=[r("保存",-1)])]),_:1})]),_:1})]),default:s(()=>[t(a(_),{"label-placement":"left","label-width":"100"},{default:s(()=>[t(a(f),{label:"名称",required:""},{default:s(()=>[t(a(N),{value:n.value.name,"onUpdate:value":e[13]||(e[13]=u=>n.value.name=u),placeholder:"服务器名称",disabled:k.value},null,8,["value","disabled"])]),_:1}),t(a(f),{label:"类型",required:""},{default:s(()=>[t(a(Y),{value:n.value.type,"onUpdate:value":e[14]||(e[14]=u=>n.value.type=u),options:[{label:"Stdio (本地进程)",value:"stdio"},{label:"JS脚本 (本地JS)",value:"js"},{label:"SSE",value:"sse"},{label:"HTTP",value:"http"}]},null,8,["value"])]),_:1}),n.value.type==="stdio"?(w(),q(ee,{key:0},[t(a(f),{label:"命令"},{default:s(()=>[t(a(N),{value:n.value.command,"onUpdate:value":e[15]||(e[15]=u=>n.value.command=u),placeholder:"例如: node, python, npx"},null,8,["value"])]),_:1}),t(a(f),{label:"参数"},{default:s(()=>[t(a(N),{value:n.value.args,"onUpdate:value":e[16]||(e[16]=u=>n.value.args=u),placeholder:"空格分隔，例如: -m mcp_server"},null,8,["value"])]),_:1}),t(a(f),{label:"环境变量"},{default:s(()=>[t(a(N),{value:n.value.env,"onUpdate:value":e[17]||(e[17]=u=>n.value.env=u),type:"textarea",placeholder:'JSON格式: {"KEY": "VALUE"}',rows:3},null,8,["value"])]),_:1})],64)):n.value.type==="js"?(w(),q(ee,{key:1},[t(a(f),{label:"脚本路径"},{default:s(()=>[t(a(N),{value:n.value.scriptPath,"onUpdate:value":e[18]||(e[18]=u=>n.value.scriptPath=u),placeholder:"本地JS文件路径，如: ./mcp/my-server.js"},null,8,["value"])]),_:1}),t(a(Z),{type:"info",style:{"margin-top":"8px"}},{default:s(()=>[...e[38]||(e[38]=[r(" JS脚本需要导出一个包含 listTools 和 callTool 方法的对象 ",-1)])]),_:1})],64)):(w(),B(a(f),{key:2,label:"URL"},{default:s(()=>[t(a(N),{value:n.value.url,"onUpdate:value":e[19]||(e[19]=u=>n.value.url=u),placeholder:"服务器地址"},null,8,["value"])]),_:1}))]),_:1})]),_:1},8,["show","title"])]),_:1}))}};export{Fe as default};
