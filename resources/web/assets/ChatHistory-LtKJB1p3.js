import{_ as E,K as H,x as l,C as Q,L as q,M as m,O as a,P as s,Q as g,R as c,S as u,T as o,U as F,N as J,ad as b,B as f,V as h,aw as K,W,Z as L,ae as Z,ax as G,a2 as X,a3 as Y,a4 as ee,ay as te,az as ae,$ as z,a0 as se,h as p}from"./index-BlGFC_7o.js";import{S as oe}from"./SearchOutlined-D0-NXRiG.js";import{D as re}from"./DeleteOutlined-tip5ruDo.js";import{N as ne}from"./DataTable-D8okgOgI.js";import{N as D}from"./Popconfirm-B1BeyeG5.js";import"./Select-CWjjOVcG.js";import"./prop-NnGblK-3.js";const ie={style:{"max-height":"60vh","overflow-y":"auto"}},le={style:{color:"#999","font-size":"12px"}},de={style:{"white-space":"pre-wrap","word-break":"break-word","max-height":"200px","overflow-y":"auto"}},ce={__name:"ChatHistory",setup(ue){const r=H(),i=l(!1),d=l([]),v=l(""),I=l(null),w=l(!1),_=l([]),O=[{title:"ä¼šè¯ID",key:"id",width:200,ellipsis:{tooltip:!0},render:e=>e.id?.substring(0,16)+"..."},{title:"ç”¨æˆ·",key:"userId",width:150,ellipsis:{tooltip:!0}},{title:"æ¶ˆæ¯æ•°",key:"messageCount",width:80,align:"center"},{title:"æœ€åŽæ´»åŠ¨",key:"lastActivity",width:160,render:e=>x(e.lastActivity)},{title:"æ“ä½œ",key:"actions",width:200,render:e=>p(g,{size:"small"},()=>[p(f,{size:"small",onClick:()=>M(e)},()=>"æŸ¥çœ‹"),p(f,{size:"small",type:"info",onClick:()=>T(e)},()=>"å¯¼å‡º"),p(D,{onPositiveClick:()=>U(e.id)},{trigger:()=>p(f,{size:"small",type:"error"},()=>"åˆ é™¤"),default:()=>"ç¡®å®šåˆ é™¤æ­¤ä¼šè¯ï¼Ÿ"})])}],B=Q(()=>{if(!v.value)return d.value;const e=v.value.toLowerCase();return d.value.filter(t=>t.id?.toLowerCase().includes(e)||t.userId?.toLowerCase().includes(e))});async function C(){i.value=!0;try{const e=await c.get("/api/conversations/list");e.data.code===0&&(d.value=e.data.data||[])}catch(e){r.error("èŽ·å–ä¼šè¯åˆ—è¡¨å¤±è´¥: "+e.message)}finally{i.value=!1}}async function M(e){I.value=e;try{const t=await c.get(`/api/conversations/${e.id}/messages`);t.data.code===0&&(_.value=t.data.data||[],w.value=!0)}catch(t){r.error("èŽ·å–ä¼šè¯è¯¦æƒ…å¤±è´¥: "+t.message)}}async function U(e){try{const t=await c.delete(`/api/conversations/${e}`);t.data.code===0?(r.success("åˆ é™¤æˆåŠŸ"),C()):r.error("åˆ é™¤å¤±è´¥: "+t.data.message)}catch(t){r.error("åˆ é™¤å¤±è´¥: "+t.message)}}async function R(){i.value=!0;try{const e=await c.delete("/api/conversations/clear-all");if(e.data.code===0){const t=e.data.data?.deletedCount??e.data.deletedCount??0;r.success(`æ¸…ç©ºæˆåŠŸï¼Œå…±åˆ é™¤ ${t} æ¡å¯¹è¯`),d.value=[]}else r.error("æ¸…ç©ºå¤±è´¥: "+e.data.message)}catch(e){r.error("æ¸…ç©ºå¤±è´¥: "+e.message)}finally{i.value=!1}}function x(e){return e?new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-"}function $(e){return typeof e.content=="string"?e.content:Array.isArray(e.content)?e.content.filter(t=>t.type==="text").map(t=>t.text).join(`
`):JSON.stringify(e.content)}async function T(e){try{const t=await c.get(`/api/conversations/${e.id}/messages`);if(t.data.code===0){const k=(t.data.data||[]).map(y=>{const j=y.role==="user"?"ðŸ‘¤ ç”¨æˆ·":y.role==="assistant"?"ðŸ¤– åŠ©æ‰‹":"ðŸ“‹ ç³»ç»Ÿ",P=$(y),V=x(y.timestamp);return`${j} [${V}]
${P}
`}).join(`
---

`),A=new Blob([k],{type:"text/plain;charset=utf-8"}),S=URL.createObjectURL(A),N=document.createElement("a");N.href=S,N.download=`conversation_${e.userId}_${new Date().toISOString().slice(0,10)}.txt`,N.click(),URL.revokeObjectURL(S),r.success("å¯¼å‡ºæˆåŠŸ")}}catch(t){r.error("å¯¼å‡ºå¤±è´¥: "+t.message)}}return q(()=>{C()}),(e,t)=>(u(),m(s(g),{vertical:"",size:"large"},{default:a(()=>[o(s(F),{title:"å¯¹è¯åŽ†å²"},{"header-extra":a(()=>[o(s(g),null,{default:a(()=>[o(s(J),{value:v.value,"onUpdate:value":t[0]||(t[0]=n=>v.value=n),placeholder:"æœç´¢ä¼šè¯IDæˆ–ç”¨æˆ·",clearable:"",style:{width:"200px"}},{prefix:a(()=>[o(s(b),null,{default:a(()=>[o(s(oe))]),_:1})]),_:1},8,["value"]),o(s(f),{onClick:C,loading:i.value},{icon:a(()=>[o(s(b),null,{default:a(()=>[o(s(K))]),_:1})]),default:a(()=>[t[2]||(t[2]=h(" åˆ·æ–° ",-1))]),_:1},8,["loading"]),o(s(D),{onPositiveClick:R},{trigger:a(()=>[o(s(f),{type:"error",disabled:d.value.length===0},{icon:a(()=>[o(s(b),null,{default:a(()=>[o(s(re))]),_:1})]),default:a(()=>[t[3]||(t[3]=h(" æ¸…ç©ºæ‰€æœ‰ ",-1))]),_:1},8,["disabled"])]),default:a(()=>[t[4]||(t[4]=h(" ç¡®å®šæ¸…ç©ºæ‰€æœ‰å¯¹è¯åŽ†å²ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ ",-1))]),_:1})]),_:1})]),default:a(()=>[o(s(ne),{columns:O,data:B.value,loading:i.value,pagination:{pageSize:20},bordered:!1,striped:""},null,8,["data","loading"])]),_:1}),o(s(W),{show:w.value,"onUpdate:show":t[1]||(t[1]=n=>w.value=n),preset:"card",title:`ä¼šè¯è¯¦æƒ… - ${I.value?.userId||""}`,style:{width:"700px","max-height":"80vh"}},{default:a(()=>[L("div",ie,[_.value.length===0?(u(),m(s(Z),{key:0,description:"æš‚æ— æ¶ˆæ¯"})):(u(),m(s(G),{key:1},{default:a(()=>[(u(!0),X(Y,null,ee(_.value,(n,k)=>(u(),m(s(te),{key:k},{default:a(()=>[o(s(ae),null,{header:a(()=>[o(s(g),{align:"center",size:8},{default:a(()=>[o(s(se),{type:n.role==="user"?"info":n.role==="assistant"?"success":"warning",size:"small"},{default:a(()=>[h(z(n.role),1)]),_:2},1032,["type"]),L("span",le,z(x(n.timestamp)),1)]),_:2},1024)]),description:a(()=>[L("div",de,z($(n)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))])]),_:1},8,["show","title"])]),_:1}))}},we=E(ce,[["__scopeId","data-v-cb8d4b3d"]]);export{we as default};
